<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“± ã‚¹ãƒãƒ›æœ€é©åŒ–æ•°å­¦ã‚·ã‚¹ãƒ†ãƒ  v5.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css">
    <style>
        .latex-container {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            min-height: 60px;
            padding: 1rem;
            border-radius: 0.5rem;
        }
        .rendered-math {
            background: white;
            padding: 1rem;
            border-radius: 0.375rem;
            margin: 0.5rem 0;
            font-size: 1.125rem;
            border: 1px solid #d1d5db;
        }
        .history-item {
            transition: all 0.3s ease;
        }
        .history-item:hover {
            background: #f3f4f6;
        }
        .field-tag {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: #dbeafe;
            color: #1e40af;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .mode-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 0.5rem 1rem;
            background: #1f2937;
            color: white;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        @media (max-width: 768px) {
            .mobile-stack {
                flex-direction: column !important;
            }
            .mobile-full {
                width: 100% !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="mode-indicator" id="modeIndicator">KaTeX ãƒ¢ãƒ¼ãƒ‰</div>

    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ“± ã‚¹ãƒãƒ›æœ€é©åŒ–æ•°å­¦ã‚·ã‚¹ãƒ†ãƒ  v5.1</h1>
            <p class="text-gray-600">LaTeXæ•°å¼å¯¾å¿œãƒ»D1é€£æºç‰ˆ</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mobile-stack">
            <!-- å·¦å´: å…¥åŠ›ãƒ‘ãƒãƒ« -->
            <div class="lg:col-span-1 mobile-full">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4">ğŸ“ å•é¡Œä½œæˆ</h2>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å•é¡Œã‚¿ã‚¤ãƒˆãƒ«</label>
                            <input type="text" id="questionTitle" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="ä¾‹: äºŒæ¬¡æ–¹ç¨‹å¼ã®è§£æ³•">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">åˆ†é‡ã‚³ãƒ¼ãƒ‰</label>
                            <select id="fieldCode" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="algebra">ä»£æ•°</option>
                                <option value="geometry">å¹¾ä½•</option>
                                <option value="calculus">å¾®ç©åˆ†</option>
                                <option value="statistics">çµ±è¨ˆ</option>
                                <option value="trigonometry">ä¸‰è§’é–¢æ•°</option>
                                <option value="probability">ç¢ºç‡</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">LaTeXæ•°å¼</label>
                            <textarea id="latexInput" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm" rows="6" placeholder="ä¾‹: x = \frac{-b \pm \sqrt{b^2-4ac}}{2a}"></textarea>
                        </div>

                        <div class="flex gap-2">
                            <button id="renderBtn" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                                ğŸ”„ ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                            </button>
                            <button id="mathJaxBtn" class="flex-1 bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition-colors">
                                ğŸ“ MathJaxãƒ¢ãƒ¼ãƒ‰
                            </button>
                        </div>

                        <button id="saveBtn" class="w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors font-semibold">
                            ğŸ’¾ D1ã«ä¿å­˜
                        </button>
                    </div>
                </div>

                <!-- å±¥æ­´ãƒ‘ãƒãƒ« -->
                <div class="bg-white rounded-lg shadow-md p-6 mt-6">
                    <h3 class="text-lg font-semibold mb-3">ğŸ“š ä½œæˆå±¥æ­´</h3>
                    <div id="historyList" class="space-y-2 max-h-64 overflow-y-auto">
                        <p class="text-gray-500 text-sm">ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>
                    </div>
                    <button id="clearHistoryBtn" class="mt-3 text-red-600 hover:text-red-700 text-sm font-medium">
                        ğŸ—‘ï¸ å±¥æ­´ã‚’ã‚¯ãƒªã‚¢
                    </button>
                </div>
            </div>

            <!-- ä¸­å¤®: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‘ãƒãƒ« -->
            <div class="lg:col-span-1 mobile-full">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4">ğŸ‘€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
                    <div class="space-y-4">
                        <div>
                            <h3 class="text-sm font-medium text-gray-700 mb-2">å…¥åŠ›å†…å®¹</h3>
                            <div id="inputDisplay" class="latex-container font-mono text-sm">
                                LaTeXæ•°å¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
                            </div>
                        </div>

                        <div>
                            <h3 class="text-sm font-medium text-gray-700 mb-2">ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°çµæœ</h3>
                            <div id="renderingResult" class="rendered-math min-h-[80px] flex items-center justify-center text-gray-500">
                                ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚ŒãŸæ•°å¼ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
                            </div>
                        </div>

                        <div>
                            <h3 class="text-sm font-medium text-gray-700 mb-2">æ­£è¦åŒ–ãƒ†ã‚­ã‚¹ãƒˆ</h3>
                            <div id="normalizedText" class="latex-container font-mono text-sm">
                                æ­£è¦åŒ–ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
                            </div>
                        </div>

                        <div class="flex gap-2">
                            <button id="copyBtn" class="flex-1 bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition-colors">
                                ğŸ“‹ ã‚³ãƒ”ãƒ¼
                            </button>
                            <button id="clearBtn" class="flex-1 bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors">
                                ğŸ—‘ï¸ ã‚¯ãƒªã‚¢
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³å´: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ‘ãƒãƒ« -->
            <div class="lg:col-span-1 mobile-full">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4">ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
                    <div id="statusPanel" class="space-y-3">
                        <div class="flex items-center justify-between p-3 bg-blue-50 rounded-md">
                            <span class="text-sm font-medium text-blue-800">ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</span>
                            <span class="text-sm text-blue-600">æº–å‚™å®Œäº†</span>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-green-50 rounded-md">
                            <span class="text-sm font-medium text-green-800">D1æ¥ç¶š</span>
                            <span class="text-sm text-green-600">æœªæ¥ç¶š</span>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-purple-50 rounded-md">
                            <span class="text-sm font-medium text-purple-800">ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚¨ãƒ³ã‚¸ãƒ³</span>
                            <span class="text-sm text-purple-600">KaTeX</span>
                        </div>
                    </div>
                </div>

                <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‘ãƒãƒ« -->
                <div class="bg-white rounded-lg shadow-md p-6 mt-6">
                    <h3 class="text-lg font-semibold mb-3">ğŸ“‹ ã‚ˆãä½¿ã†ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</h3>
                    <div class="space-y-2">
                        <button class="template-btn w-full text-left p-2 bg-gray-50 hover:bg-gray-100 rounded-md transition-colors text-sm" data-template="äºŒæ¬¡æ–¹ç¨‹å¼">
                            <div class="font-medium">äºŒæ¬¡æ–¹ç¨‹å¼</div>
                            <div class="text-gray-600 text-xs">axÂ² + bx + c = 0</div>
                        </button>
                        <button class="template-btn w-full text-left p-2 bg-gray-50 hover:bg-gray-100 rounded-md transition-colors text-sm" data-template="å¾®åˆ†">
                            <div class="font-medium">å¾®åˆ†</div>
                            <div class="text-gray-600 text-xs">f'(x) = lim(hâ†’0)</div>
                        </button>
                        <button class="template-btn w-full text-left p-2 bg-gray-50 hover:bg-gray-100 rounded-md transition-colors text-sm" data-template="ç©åˆ†">
                            <div class="font-medium">ç©åˆ†</div>
                            <div class="text-gray-600 text-xs">âˆ« f(x)dx</div>
                        </button>
                        <button class="template-btn w-full text-left p-2 bg-gray-50 hover:bg-gray-100 rounded-md transition-colors text-sm" data-template="è¡Œåˆ—">
                            <div class="font-medium">è¡Œåˆ—</div>
                            <div class="text-gray-600 text-xs">A = [a_ij]</div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class MathEditor {
            constructor() {
                this.currentMode = 'katex';
                this.history = JSON.parse(localStorage.getItem('mathEditorHistory') || '[]');
                this.textarea = document.getElementById('latexInput');
                this.init();
            }

            init() {
                this.bindEvents();
                this.loadHistory();
                this.updateModeIndicator();
                this.addStatus('ğŸš€ ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•å®Œäº†', 'success');

                // D1æ¥ç¶šãƒã‚§ãƒƒã‚¯
                this.checkD1Connection();
            }

            bindEvents() {
                document.getElementById('renderBtn').addEventListener('click', () => this.renderMath());
                document.getElementById('mathJaxBtn').addEventListener('click', () => this.toggleMode());
                document.getElementById('saveBtn').addEventListener('click', () => this.saveQuestion());
                document.getElementById('copyBtn').addEventListener('click', () => this.copyToClipboard());
                document.getElementById('clearBtn').addEventListener('click', () => this.clearForm());
                document.getElementById('clearHistoryBtn').addEventListener('click', () => this.clearHistory());

                // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒœã‚¿ãƒ³
                document.querySelectorAll('.template-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => this.loadTemplate(e.target.closest('.template-btn').dataset.template));
                });

                // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
                this.textarea.addEventListener('input', () => {
                    this.updateInputDisplay();
                    this.autoRender();
                });
            }

            async checkD1Connection() {
                try {
                    // ç°¡å˜ãªæ¥ç¶šãƒã‚§ãƒƒã‚¯
                    const response = await fetch('/api/health', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        this.updateD1Status(true);
                        this.addStatus('âœ… D1æ¥ç¶šç¢ºèª', 'success');
                    } else {
                        this.updateD1Status(false);
                        this.addStatus('âš ï¸ D1æ¥ç¶šã«å•é¡ŒãŒã‚ã‚Šã¾ã™', 'warning');
                    }
                } catch (error) {
                    this.updateD1Status(false);
                    this.addStatus('âŒ D1ã«æ¥ç¶šã§ãã¾ã›ã‚“', 'error');
                    console.error('D1æ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            updateD1Status(connected) {
                const statusElement = document.querySelector('#statusPanel .bg-green-50 span:last-child');
                if (statusElement) {
                    statusElement.textContent = connected ? 'æ¥ç¶šæ¸ˆã¿' : 'æœªæ¥ç¶š';
                    statusElement.className = connected ? 'text-sm text-green-600' : 'text-sm text-red-600';
                }
            }

            renderMath() {
                const latex = this.textarea.value.trim();
                if (!latex) {
                    this.showMessage('LaTeXæ•°å¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                    return;
                }

                try {
                    const resultDiv = document.getElementById('renderingResult');

                    if (this.currentMode === 'katex') {
                        katex.render(latex, resultDiv, {
                            throwOnError: false,
                            displayMode: true
                        });
                    } else {
                        resultDiv.innerHTML = `\\[${latex}\\]`;
                        MathJax.typesetPromise([resultDiv]).catch((e) => {
                            console.error('MathJaxã‚¨ãƒ©ãƒ¼:', e);
                            resultDiv.innerHTML = '<span class="text-red-600">MathJaxãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼</span>';
                        });
                    }

                    this.updateNormalizedText();
                    this.addStatus('âœ… ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æˆåŠŸ', 'success');
                } catch (error) {
                    this.showMessage('ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                    this.addStatus('âŒ ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å¤±æ•—', 'error');
                }
            }

            autoRender() {
                const latex = this.textarea.value.trim();
                if (latex && latex.length > 3) {
                    clearTimeout(this.autoRenderTimeout);
                    this.autoRenderTimeout = setTimeout(() => {
                        this.renderMath();
                    }, 1000);
                }
            }

            updateInputDisplay() {
                const latex = this.textarea.value;
                document.getElementById('inputDisplay').textContent = latex || 'LaTeXæ•°å¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
            }

            updateNormalizedText() {
                const latex = this.textarea.value;
                const normalized = this.normalizeExpression(latex);
                document.getElementById('normalizedText').textContent = normalized || 'æ­£è¦åŒ–ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™';
            }

            normalizeExpression(expr) {
                return expr
                    .replace(/\s+/g, ' ')
                    .replace(/\\left/g, '')
                    .replace(/\\right/g, '')
                    .replace(/\{\}/g, '')
                    .trim();
            }

            toggleMode() {
                this.currentMode = this.currentMode === 'katex' ? 'mathjax' : 'katex';
                this.updateModeIndicator();
                this.addStatus(`ğŸ”„ ${this.currentMode.toUpperCase()}ãƒ¢ãƒ¼ãƒ‰ã«å¤‰æ›´`, 'info');

                if (this.textarea.value.trim()) {
                    this.renderMath();
                }
            }

            updateModeIndicator() {
                const indicator = document.getElementById('modeIndicator');
                indicator.textContent = this.currentMode === 'katex' ? 'KaTeX ãƒ¢ãƒ¼ãƒ‰' : 'MathJax ãƒ¢ãƒ¼ãƒ‰';
            }

            async saveQuestion() {
                const title = document.getElementById('questionTitle').value.trim();
                const field = document.getElementById('fieldCode').value;
                const content = this.textarea.value.trim();

                if (!title || !field || !content) {
                    this.showMessage('ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                    return;
                }

                const question = {
                    id: Date.now().toString(),
                    subject: 'math',
                    title,
                    field_code: field,
                    question_text: content,
                    normalized_content: this.normalizeExpression(content),
                    mode: this.currentMode,
                    created_at: new Date().toISOString()
                };

                try {
                    // D1ã«ä¿å­˜ã‚’è©¦ã¿ã‚‹
                    const d1Success = await this.saveToD1(question);

                    if (d1Success) {
                        this.showMessage('å•é¡Œã‚’D1ã«ä¿å­˜ã—ã¾ã—ãŸï¼', 'success');
                        this.addStatus('ğŸ’¾ D1ä¿å­˜å®Œäº†', 'success');
                    } else {
                        // D1ä¿å­˜ã«å¤±æ•—ã—ãŸå ´åˆã¯localStorageã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                        this.saveToLocalStorage(question);
                        this.showMessage('å•é¡Œã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã—ã¾ã—ãŸï¼ˆD1æ¥ç¶šã«å•é¡ŒãŒã‚ã‚Šã¾ã™ï¼‰', 'warning');
                        this.addStatus('ğŸ’¾ ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜å®Œäº†', 'warning');
                    }

                    this.addToHistory(question);
                    this.clearForm();
                } catch (error) {
                    this.showMessage('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                    this.addStatus('âŒ ä¿å­˜å¤±æ•—', 'error');
                }
            }

            async saveToD1(question) {
                try {
                    const sessionToken = localStorage.getItem('sessionToken');
                    if (!sessionToken) {
                        throw new Error('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“');
                    }

                    const response = await fetch('/api/questions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${sessionToken}`
                        },
                        body: JSON.stringify(question)
                    });

                    if (response.ok) {
                        return true;
                    } else if (response.status === 401) {
                        throw new Error('èªè¨¼ãŒå¿…è¦ã§ã™');
                    } else {
                        throw new Error('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼');
                    }
                } catch (error) {
                    console.error('D1ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                    return false;
                }
            }

            saveToLocalStorage(question) {
                const questions = JSON.parse(localStorage.getItem('katexMathQuestions') || '[]');
                questions.push(question);
                localStorage.setItem('katexMathQuestions', JSON.stringify(questions));
            }

            addToHistory(question) {
                this.history.unshift(question);
                if (this.history.length > 10) {
                    this.history = this.history.slice(0, 10);
                }
                localStorage.setItem('mathEditorHistory', JSON.stringify(this.history));
                this.updateHistoryDisplay();
            }

            loadHistory() {
                this.updateHistoryDisplay();
            }

            updateHistoryDisplay() {
                const historyList = document.getElementById('historyList');

                if (this.history.length === 0) {
                    historyList.innerHTML = '<p class="text-gray-500 text-sm">ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                    return;
                }

                historyList.innerHTML = this.history.map(item => `
                    <div class="history-item p-2 border rounded-md cursor-pointer" onclick="mathEditor.loadFromHistory('${item.id}')">
                        <div class="font-medium text-sm">${item.title}</div>
                        <div class="text-xs text-gray-600">${item.field_code} â€¢ ${new Date(item.created_at).toLocaleString()}</div>
                    </div>
                `).join('');
            }

            loadFromHistory(id) {
                const item = this.history.find(h => h.id === id);
                if (item) {
                    document.getElementById('questionTitle').value = item.title;
                    document.getElementById('fieldCode').value = item.field_code;
                    this.textarea.value = item.question_text;
                    this.updateInputDisplay();
                    this.renderMath();
                    this.showMessage('å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
                }
            }

            clearHistory() {
                if (confirm('å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                    this.history = [];
                    localStorage.removeItem('mathEditorHistory');
                    this.updateHistoryDisplay();
                    this.showMessage('å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
                }
            }

            loadTemplate(templateName) {
                const templates = {
                    'äºŒæ¬¡æ–¹ç¨‹å¼': 'x = \\frac{-b \\pm \\sqrt{b^2-4ac}}{2a}',
                    'å¾®åˆ†': 'f\'(x) = \\lim_{h \\to 0} \\frac{f(x+h) - f(x)}{h}',
                    'ç©åˆ†': '\\int f(x)\\,dx = F(x) + C',
                    'è¡Œåˆ—': '\\begin{pmatrix} a & b \\\\ c & d \\end{pmatrix}'
                };

                if (templates[templateName]) {
                    this.textarea.value = templates[templateName];
                    this.updateInputDisplay();
                    this.renderMath();
                    this.addStatus(`ğŸ“‹ ${templateName}ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿`, 'info');
                }
            }

            copyToClipboard() {
                const latex = this.textarea.value.trim();
                if (!latex) {
                    this.showMessage('ã‚³ãƒ”ãƒ¼ã™ã‚‹å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }

                navigator.clipboard.writeText(latex).then(() => {
                    this.showMessage('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
                    this.addStatus('ğŸ“‹ ã‚³ãƒ”ãƒ¼å®Œäº†', 'success');
                }).catch(() => {
                    this.showMessage('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                });
            }

            clearForm() {
                document.getElementById('questionTitle').value = '';
                document.getElementById('fieldCode').value = 'algebra';
                this.textarea.value = '';
                this.updateInputDisplay();
                document.getElementById('renderingResult').innerHTML = '<span class="text-gray-500">ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚ŒãŸæ•°å¼ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</span>';
                document.getElementById('normalizedText').textContent = 'æ­£è¦åŒ–ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™';
                this.addStatus('ğŸ—‘ï¸ ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢', 'info');
            }

            showMessage(message, type = 'info') {
                const colors = {
                    success: 'bg-green-100 border-green-400 text-green-700',
                    error: 'bg-red-100 border-red-400 text-red-700',
                    warning: 'bg-yellow-100 border-yellow-400 text-yellow-700',
                    info: 'bg-blue-100 border-blue-400 text-blue-700'
                };

                const messageDiv = document.createElement('div');
                messageDiv.className = `fixed top-4 left-1/2 transform -translate-x-1/2 px-4 py-2 border rounded-md ${colors[type]} z-50 transition-opacity duration-300`;
                messageDiv.textContent = message;

                document.body.appendChild(messageDiv);

                setTimeout(() => {
                    messageDiv.style.opacity = '0';
                    setTimeout(() => {
                        if (messageDiv.parentNode) {
                            messageDiv.parentNode.removeChild(messageDiv);
                        }
                    }, 300);
                }, 3000);
            }

            addStatus(message, type = 'info') {
                const statusPanel = document.getElementById('statusPanel');
                const statusDiv = document.createElement('div');

                const colors = {
                    success: 'bg-green-50 text-green-800',
                    error: 'bg-red-50 text-red-800',
                    warning: 'bg-yellow-50 text-yellow-800',
                    info: 'bg-blue-50 text-blue-800'
                };

                const time = new Date().toLocaleTimeString();
                statusDiv.className = `flex items-center justify-between p-3 ${colors[type]} rounded-md`;
                statusDiv.innerHTML = `
                    <span class="text-sm font-medium">${message}</span>
                    <span class="text-xs opacity-75">${time}</span>
                `;

                statusPanel.insertBefore(statusDiv, statusPanel.firstChild);

                // å¤ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å‰Šé™¤
                while (statusPanel.children.length > 10) {
                    statusPanel.removeChild(statusPanel.lastChild);
                }
            }
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
        let mathEditor;

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            mathEditor = new MathEditor();
        });

        // MathJaxè¨­å®š
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            startup: {
                ready: () => {
                    MathJax.startup.defaultReady();
                    console.log('MathJaxæº–å‚™å®Œäº†');
                }
            }
        };
    </script>
</body>
</html>