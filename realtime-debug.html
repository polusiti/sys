<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ èªè¨¼ãƒ‡ãƒãƒƒã‚°</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .log { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            border-radius: 4px; 
            padding: 15px; 
            height: 400px; 
            overflow-y: auto; 
            font-family: monospace; 
            font-size: 14px;
            white-space: pre-wrap;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        .warning { color: #ffc107; }
        .clear-btn { background: #6c757d; }
    </style>
</head>
<body>
    <h1>ğŸ” ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ èªè¨¼ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</h1>
    <p>ç¾åœ¨ã®ãƒ‰ãƒ¡ã‚¤ãƒ³: <strong id="currentDomain"></strong></p>
    
    <div class="form-group">
        <label for="testUserId">ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ID:</label>
        <input type="text" id="testUserId" value="debug_user_" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼ID">
    </div>
    
    <div class="form-group">
        <label for="testDisplayName">è¡¨ç¤ºå:</label>
        <input type="text" id="testDisplayName" value="ãƒ‡ãƒãƒƒã‚°ãƒ¦ãƒ¼ã‚¶ãƒ¼" placeholder="è¡¨ç¤ºå">
    </div>
    
    <div>
        <button onclick="testFullRegistration()">ğŸ”„ å®Œå…¨ç™»éŒ²ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="testBasicFetch()">ğŸŒ åŸºæœ¬æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
        <button onclick="testCORS()">ğŸ”— CORSãƒ†ã‚¹ãƒˆ</button>
        <button onclick="clearLog()" class="clear-btn">ğŸ—‘ï¸ ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
    </div>
    
    <h3>ğŸ“ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°</h3>
    <div id="debugLog" class="log"></div>
    
    <script>
        const WORKER_URL = 'https://data-manager-auth.t88596565.workers.dev';
        let logCount = 0;
        
        function log(type, message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('debugLog');
            logCount++;
            
            let logEntry = `[${timestamp}] [${logCount}] ${message}`;
            if (data) {
                logEntry += '\n' + JSON.stringify(data, null, 2);
            }
            logEntry += '\n';
            
            const span = document.createElement('span');
            span.className = type;
            span.textContent = logEntry;
            logDiv.appendChild(span);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('debugLog').innerHTML = '';
            logCount = 0;
        }
        
        async function testBasicFetch() {
            log('info', 'ğŸŒ åŸºæœ¬æ¥ç¶šãƒ†ã‚¹ãƒˆã‚’é–‹å§‹...');
            
            try {
                const response = await fetch(`${WORKER_URL}/api/auth/init`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer questa-admin-2024',
                        'Content-Type': 'application/json'
                    }
                });
                
                log('info', 'Response received', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    headers: Object.fromEntries(response.headers.entries())
                });
                
                const data = await response.json();
                log('success', 'âœ… åŸºæœ¬æ¥ç¶šæˆåŠŸ', data);
                
            } catch (error) {
                log('error', 'âŒ åŸºæœ¬æ¥ç¶šå¤±æ•—', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
            }
        }
        
        async function testCORS() {
            log('info', 'ğŸ”— CORSãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆãƒ†ã‚¹ãƒˆã‚’é–‹å§‹...');
            
            try {
                const response = await fetch(`${WORKER_URL}/api/auth/register`, {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': window.location.origin,
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type'
                    }
                });
                
                log('info', 'CORS preflight response', {
                    status: response.status,
                    headers: Object.fromEntries(response.headers.entries())
                });
                
                if (response.ok) {
                    log('success', 'âœ… CORSãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆæˆåŠŸ');
                } else {
                    log('error', 'âŒ CORSãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆå¤±æ•—');
                }
                
            } catch (error) {
                log('error', 'âŒ CORSãƒ†ã‚¹ãƒˆå¤±æ•—', {
                    name: error.name,
                    message: error.message
                });
            }
        }
        
        async function testFullRegistration() {
            const userId = document.getElementById('testUserId').value + Date.now();
            const displayName = document.getElementById('testDisplayName').value;
            
            log('info', 'ğŸ”„ å®Œå…¨ç™»éŒ²ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹...', { userId, displayName });
            
            try {
                // Step 1: User registration
                log('info', 'Step 1: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ä¸­...');
                
                const userData = {
                    userId: userId,
                    displayName: displayName,
                    email: 'debug@example.com',
                    inquiryNumber: `DM-2024-${String(Math.floor(Math.random() * 999999)).padStart(6, '0')}`
                };
                
                log('info', 'Sending registration data', userData);
                
                const regResponse = await fetch(`${WORKER_URL}/api/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Origin': window.location.origin
                    },
                    body: JSON.stringify(userData)
                });
                
                log('info', 'Registration response received', {
                    status: regResponse.status,
                    statusText: regResponse.statusText,
                    ok: regResponse.ok,
                    headers: Object.fromEntries(regResponse.headers.entries())
                });
                
                if (!regResponse.ok) {
                    const errorText = await regResponse.text();
                    log('error', 'âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²å¤±æ•—', {
                        status: regResponse.status,
                        errorText: errorText
                    });
                    return;
                }
                
                const regData = await regResponse.json();
                log('success', 'âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æˆåŠŸ', regData);
                
                // Step 2: Passkey registration begin
                log('info', 'Step 2: ãƒ‘ã‚¹ã‚­ãƒ¼ç™»éŒ²é–‹å§‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆ...');
                
                const beginResponse = await fetch(`${WORKER_URL}/api/auth/passkey/register/begin`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ userId: regData.user.id })
                });
                
                log('info', 'Passkey begin response', {
                    status: beginResponse.status,
                    ok: beginResponse.ok
                });
                
                if (!beginResponse.ok) {
                    const errorText = await beginResponse.text();
                    log('error', 'âŒ ãƒ‘ã‚¹ã‚­ãƒ¼ç™»éŒ²é–‹å§‹å¤±æ•—', errorText);
                    return;
                }
                
                const beginData = await beginResponse.json();
                log('success', 'âœ… ãƒ‘ã‚¹ã‚­ãƒ¼ç™»éŒ²ã‚ªãƒ—ã‚·ãƒ§ãƒ³å–å¾—æˆåŠŸ', beginData);
                
                // Step 3: WebAuthn check
                log('info', 'Step 3: WebAuthnå¯¾å¿œãƒã‚§ãƒƒã‚¯...');
                
                if (!window.PublicKeyCredential) {
                    log('error', 'âŒ WebAuthnæœªå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶');
                    return;
                }
                
                log('success', 'âœ… WebAuthnå¯¾å¿œç¢ºèª');
                
                // Step 4: Simulate credential creation (without actual WebAuthn)
                log('info', 'Step 4: èªè¨¼æƒ…å ±ä½œæˆï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼‰...');
                
                const mockCredential = {
                    id: 'mock_credential_' + Date.now(),
                    response: {
                        clientDataJSON: btoa(JSON.stringify({
                            type: 'webauthn.create',
                            challenge: beginData.challenge,
                            origin: window.location.origin
                        })),
                        attestationObject: 'mock_attestation_object'
                    }
                };
                
                const completeResponse = await fetch(`${WORKER_URL}/api/auth/passkey/register/complete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: regData.user.id,
                        credential: mockCredential
                    })
                });
                
                if (!completeResponse.ok) {
                    const errorText = await completeResponse.text();
                    log('error', 'âŒ ãƒ‘ã‚¹ã‚­ãƒ¼ç™»éŒ²å®Œäº†å¤±æ•—', errorText);
                    return;
                }
                
                const completeData = await completeResponse.json();
                log('success', 'âœ… ãƒ‘ã‚¹ã‚­ãƒ¼ç™»éŒ²å®Œäº†', completeData);
                
                log('success', 'ğŸ‰ å®Œå…¨ç™»éŒ²ãƒ†ã‚¹ãƒˆæˆåŠŸï¼');
                
            } catch (error) {
                log('error', 'âŒ å®Œå…¨ç™»éŒ²ãƒ†ã‚¹ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
            }
        }
        
        // Initialize
        window.addEventListener('load', () => {
            document.getElementById('currentDomain').textContent = window.location.origin;
            log('info', 'ğŸš€ ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«åˆæœŸåŒ–å®Œäº†', {
                userAgent: navigator.userAgent,
                origin: window.location.origin,
                protocol: window.location.protocol
            });
        });
    </script>
</body>
</html>