<!DOCTYPE html>
<html lang="ja" data-theme="light">
<head>
  <meta charset="UTF-8">
  <title>æ•°å­¦ç·åˆæ¼”ç¿’ - TestApp</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="description" content="æ•°å­¦ã®ç·åˆãƒ©ãƒ³ãƒ€ãƒ æ¼”ç¿’">
  <!-- æ—¢å­˜ CSS (ãƒªãƒã‚¸ãƒˆãƒªã«ã‚ã‚‹ã‚‚ã®ã‚’ãã®ã¾ã¾åˆ©ç”¨) -->
  <link rel="stylesheet" href="../assets/css/base.css">
  <link rel="stylesheet" href="../assets/css/layout.css">
  <link rel="stylesheet" href="../assets/css/components.css">
  <link rel="stylesheet" href="../assets/css/themes.css">
  <link rel="stylesheet" href="../assets/css/effects.css">

  <!-- MathJax è¨­å®š -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$','$$'], ['\\[','\\]']],
        packages: {'[+]': ['mhchem']}
      },
      loader: { load: ['[tex]/mhchem'] },
      startup: { typeset: false }  // å‹•çš„æç”»å¾Œã«æ‰‹å‹•ã§ typeset ã™ã‚‹
    };
  </script>
  <!-- MathJax æœ¬ä½“ -->
  <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"
          onload="console.log('[MathJax] loaded')" onerror="console.error('[MathJax] load error')"></script>
  <style>
    /* ã“ã®ãƒšãƒ¼ã‚¸ç‰¹æœ‰ã®è»½å¾®ãªä¸Šæ›¸ããŒã‚ã‚Œã°ã“ã“ã« */
    .config-grid{
      display:grid;
      gap:1rem;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      margin-top:.8rem;
    }
    .config-label{font-size:.7rem;font-weight:600;display:block;margin-bottom:.2rem;letter-spacing:.04em;}
    .config-control{width:100%;}
    fieldset.subject-card{border:1px solid var(--border-color,#d4dbe3);border-radius:14px;padding:.8rem 1rem;background:var(--layer-bg,#fff);}
    fieldset.subject-card legend{padding:0 .4rem;}
    .glass{background:var(--layer-bg,#fff);border:1px solid var(--border-color,#d4dbe3);border-radius:16px;}
    .hero-subtitle code{background:#f1f5f9;padding:.1rem .3rem;border-radius:4px;font-size:.75rem;}
    #resultBox .glass{animation:fadeIn .3s ease;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(4px);}to{opacity:1;transform:translateY(0);}}
  </style>
</head>
<body>
  <a class="skip-link" href="#main">ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¸ç§»å‹•</a>
  <header class="site-header" id="siteHeader">
    <div class="header-inner">
      <div class="brand">
        <img src="../assets/img/logo.svg" alt="TestApp ãƒ­ã‚´" class="logo">
        <span class="brand-name">TestApp</span>
      </div>
      <nav class="primary-nav" aria-label="ãƒ¡ã‚¤ãƒ³ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³">
        <ul class="nav-list" id="navList" data-nav>
          <li><a class="nav-link" href="../index.html#home">ãƒ›ãƒ¼ãƒ </a></li>
          <li><a class="nav-link" href="../index.html#subjects">ç§‘ç›®</a></li>
          <li><a class="nav-link active" href="comprehensive.html">æ•°å­¦ç·åˆ</a></li>
          <li><a class="nav-link" href="../index.html#about">æ¦‚è¦</a></li>
        </ul>
        <span class="nav-indicator" id="navIndicator" aria-hidden="true"></span>
      </nav>
      <div class="header-tools">
        <button class="theme-toggle" id="themeCycleBtn" aria-label="ãƒ†ãƒ¼ãƒåˆ‡æ›¿">
          <span class="theme-icon" data-theme-icon>ğŸŒ</span>
        </button>
        <div class="theme-quick" id="themeQuick">
          <button class="theme-pill" data-set-theme="light" title="Light">L</button>
          <button class="theme-pill" data-set-theme="dark" title="Dark">D</button>
          <button class="theme-pill" data-set-theme="reading" title="Reading">R</button>
        </div>
      </div>
    </div>
  </header>

  <main id="main" class="main">
    <section class="hero" style="margin-top:1.2rem;">
      <div class="hero-content">
        <h1 class="hero-title">æ•°å­¦ ç·åˆãƒ©ãƒ³ãƒ€ãƒ æ¼”ç¿’</h1>
        <p class="hero-subtitle">
          å…¨ãƒˆãƒ”ãƒƒã‚¯æ¨ªæ–­ã§ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œã€‚æ•°å¼ã¯ LaTeX å½¢å¼ã§å…¥åŠ› (ä¾‹: <code>$\\frac{a}{b}$</code>, <code>\\( a^2 + b^2 \\)</code>)ã€‚<br>
          JSON ã§ã¯ <code>"$\\frac{a}{b}$"</code> ã®ã‚ˆã†ã«ãƒãƒƒã‚¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã¯ 1 å›ï¼ˆæ–‡å­—åˆ—ã¨ã—ã¦ã¯ <code>\\</code> ã§ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼‰ã«ã—ã¦ãã ã•ã„ã€‚
        </p>
        <div class="hero-actions">
          <a href="#config" class="btn primary">æ¡ä»¶ã‚’è¨­å®š</a>
        </div>
      </div>
    </section>

    <section id="config" class="section">
      <header class="section-head">
        <h2 class="section-title">å‡ºé¡Œæ¡ä»¶</h2>
      </header>
      <div class="config-grid">
        <div class="config-item">
          <label for="countSel" class="config-label">å‡ºé¡Œæ•°</label>
          <select id="countSel" class="config-control">
            <option value="5">5å•</option>
            <option value="10" selected>10å•</option>
            <option value="15">15å•</option>
            <option value="20">20å•</option>
          </select>
        </div>
        <div class="config-item">
          <label for="diffSel" class="config-label">é›£æ˜“åº¦ (ä¾‹: 1-2,3,4-5 ç©º=å…¨)</label>
          <input id="diffSel" class="config-control" type="text" placeholder="é›£æ˜“åº¦ç¯„å›²">
        </div>
        <div class="config-item">
          <label for="modeSel" class="config-label">æŠ½å‡ºãƒ¢ãƒ¼ãƒ‰</label>
          <select id="modeSel" class="config-control">
            <option value="uniform" selected>ä¸€æ§˜ãƒ©ãƒ³ãƒ€ãƒ </option>
            <option value="balanced">é›£æ˜“åº¦ãƒãƒ©ãƒ³ã‚¹</option>
          </select>
        </div>
        <div class="config-actions" style="display:flex; gap:.6rem; align-items:flex-end;">
          <button id="startBtn" class="btn primary">å‡ºé¡Œ</button>
          <button id="resumeBtn" class="btn" style="display:none;">å‰å›ã‚’å¾©å…ƒ</button>
          <button id="clearBtn" class="btn danger" title="ä¿å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ¶ˆå»" style="margin-left:auto;">ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤</button>
        </div>
      </div>
    </section>

    <section id="testSection" class="section" style="display:none;">
      <header class="section-head">
        <h2 class="section-title">æ¼”ç¿’</h2>
        <div id="testMeta" class="meta"></div>
      </header>
      <div id="questionContainer" class="cards-grid" aria-live="polite"></div>
      <div class="actions-row" style="margin-top:1rem; display:flex; gap:.6rem; flex-wrap:wrap;">
        <button id="gradeBtn" class="btn success">æ¡ç‚¹</button>
        <button id="retryBtn" class="btn">å†æŠ½é¸</button>
        <button id="mistakeBtn" class="btn" disabled>é–“é•ãˆãŸå•é¡Œã®ã¿å¾©ç¿’</button>
      </div>
      <div id="resultBox" style="margin-top:1.2rem;"></div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="footer-inner">
      <small>&copy; 2025 TestApp</small>
    </div>
  </footer>

  <!-- ã“ã®ãƒšãƒ¼ã‚¸å°‚ç”¨ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ä¸è¦ç‰ˆï¼‰ -->
  <script>
  (function(){
    console.log('[comp] script init');

    const DATA_URL = '../data/questions/math.json'; // math/ ã‹ã‚‰ã®ç›¸å¯¾
    const LS_KEY   = 'testapp_math_comprehensive_session_v1';

    // è¦ç´ å‚ç…§
    const startBtn       = document.getElementById('startBtn');
    const resumeBtn      = document.getElementById('resumeBtn');
    const gradeBtn       = document.getElementById('gradeBtn');
    const retryBtn       = document.getElementById('retryBtn');
    const mistakeBtn     = document.getElementById('mistakeBtn');
    const clearBtn       = document.getElementById('clearBtn');
    const countSel       = document.getElementById('countSel');
    const diffSel        = document.getElementById('diffSel');
    const modeSel        = document.getElementById('modeSel');
    const testSection    = document.getElementById('testSection');
    const questionContainer = document.getElementById('questionContainer');
    const testMeta       = document.getElementById('testMeta');
    const resultBox      = document.getElementById('resultBox');

    // çŠ¶æ…‹
    let allQuestions = [];
    let currentSet   = [];
    let answers      = {};
    let graded       = false;
    let lastMistakeSet = [];

    // åˆæœŸå‡¦ç†
    init();

    async function init(){
      await loadQuestions();
      detectResumeSession();
      wireEvents();
    }

    async function loadQuestions(){
      try {
        const res = await fetch(DATA_URL, {cache:'no-store'});
        if(!res.ok){
          console.error('[comp] JSONå–å¾—å¤±æ•— status=', res.status);
          alert('å•é¡Œãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
          return;
        }
        const data = await res.json();
        if(!Array.isArray(data)){
          console.error('[comp] JSONãŒé…åˆ—ã§ãªã„');
          return;
        }
        allQuestions = data.filter(q => q && q.active !== false);
        console.log('[comp] questions loaded:', allQuestions.length);
      } catch(e){
        console.error('[comp] fetch error', e);
      }
    }

    function wireEvents(){
      startBtn.addEventListener('click', startNew);
      retryBtn.addEventListener('click', startNew);
      gradeBtn.addEventListener('click', grade);
      mistakeBtn.addEventListener('click', reviewMistakes);
      clearBtn.addEventListener('click', ()=>{
        localStorage.removeItem(LS_KEY);
        alert('ä¿å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        resumeBtn.style.display = 'none';
      });
    }

    function detectResumeSession(){
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return;
      try{
        const s = JSON.parse(raw);
        if(s && Array.isArray(s.questions) && !s.completed){
          resumeBtn.style.display = 'inline-flex';
          resumeBtn.addEventListener('click', ()=>{
            currentSet = s.questions;
            answers    = s.answers || {};
            renderQuestions(currentSet);
            updateMeta('(å‰å›å¾©å…ƒ)');
            testSection.style.display = '';
          }, {once:true});
        }
      }catch(e){
        console.warn('[comp] resume parse error', e);
      }
    }

    function startNew(){
      graded = false;
      resultBox.innerHTML = '';
      lastMistakeSet = [];
      answers = {};

      const count    = parseInt(countSel.value, 10);
      const diffSpec = diffSel.value.trim();
      const mode     = modeSel.value;

      const filtered = filterByDifficulty(allQuestions, diffSpec);
      if(!filtered.length){
        alert('è©²å½“ã™ã‚‹é›£æ˜“åº¦ã®å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      currentSet = (mode === 'balanced')
        ? balancedSample(filtered, count)
        : uniformSample(filtered, count);

      renderQuestions(currentSet);
      updateMeta();
      testSection.style.display = '';
      mistakeBtn.disabled = true;
      persistSession();
    }

    function filterByDifficulty(list, spec){
      if(!spec) return list;
      const set = new Set();
      spec.split(',').forEach(part=>{
        const p = part.trim();
        if(!p) return;
        if(p.includes('-')){
          const [a,b] = p.split('-').map(n=>parseInt(n,10));
          if(Number.isInteger(a) && Number.isInteger(b) && a<=b){
            for(let i=a;i<=b;i++) set.add(i);
          }
        } else {
          const v = parseInt(p,10);
            if(Number.isInteger(v)) set.add(v);
        }
      });
      return set.size ? list.filter(q=> set.has(q.difficulty)) : list;
    }

    function uniformSample(list, k){
      if(k >= list.length) return shuffle([...list]).slice(0,k);
      const used = new Set();
      const out = [];
      while(out.length < k){
        const idx = Math.floor(Math.random()*list.length);
        if(!used.has(idx)){
          used.add(idx);
          out.push(list[idx]);
        }
      }
      return out;
    }

    function balancedSample(list, k){
      const buckets = {};
      list.forEach(q => (buckets[q.difficulty] ||= []).push(q));
      Object.values(buckets).forEach(arr => shuffle(arr));
      const diffs = Object.keys(buckets).sort((a,b)=> a - b);
      const result = [];
      let i=0;
      while(result.length < k && result.length < list.length){
        const d = diffs[i % diffs.length];
        const arr = buckets[d];
        if(arr && arr.length) result.push(arr.shift());
        i++;
        if(diffs.every(dd => (buckets[dd]||[]).length === 0)) break;
      }
      return result;
    }

    function shuffle(a){
      for(let i=a.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }

    function renderQuestions(qs){
      questionContainer.innerHTML = qs.map((q,i)=>{
        const name = `q_${q.id}`;
        return `
          <fieldset class="subject-card obs" data-qid="${escapeAttr(q.id)}">
            <legend>Q${i+1}. ${escapeHtml(q.stem||'')}</legend>
            <p style="font-size:.8rem; margin-top:.3rem;">${escapeHtml(q.question||'')}</p>
            <ul style="list-style:none; margin-top:.6rem; display:flex; flex-direction:column; gap:.4rem; padding:0;">
              ${(q.choices||[]).map((c,ci)=>`
                <li>
                  <label style="display:flex; gap:.5rem; align-items:flex-start; font-size:.78rem;">
                    <input type="radio" name="${name}" value="${ci}" ${answers[q.id]===ci?'checked':''}>
                    <span>${escapeHtml(String(c))}</span>
                  </label>
                </li>`).join('')}
            </ul>
            <div class="explanation" data-exp="${escapeAttr(q.id)}" hidden
                 style="margin-top:.6rem; font-size:.7rem; background:var(--layer-bg-alt,#f4f7fb); padding:.55rem .65rem; border-radius:10px;"></div>
          </fieldset>`;
      }).join('');

      typesetMath(questionContainer);
    }

    function grade(){
      if(!currentSet.length){
        alert('å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      currentSet.forEach(q=>{
        const sel = questionContainer.querySelector(`input[name="q_${CSS.escape(q.id)}"]:checked`);
        answers[q.id] = sel ? parseInt(sel.value,10) : null;
      });

      let correct=0;
      const mistakes=[];
      currentSet.forEach(q=>{
        const ok = answers[q.id] === q.answer;
        if(ok) correct++; else mistakes.push(q.id);
        const box = questionContainer.querySelector(`.explanation[data-exp="${CSS.escape(q.id)}"]`);
        if(box){
          box.hidden = false;
          box.innerHTML = `
            <strong>${ok?'âœ” æ­£è§£':'âœ– ä¸æ­£è§£'}</strong><br>
            æ­£è§£: ${escapeHtml(choiceLabel(q,q.answer))}<br>
            ã‚ãªãŸ: ${answers[q.id]!=null? escapeHtml(choiceLabel(q,answers[q.id])):'(æœªå›ç­”)'}<br>
            <em>${escapeHtml(q.explanation || '')}</em>
          `;
          box.style.color = ok ? '#166534' : '#b91c1c';
        }
      });

      const pct = Math.round(correct / currentSet.length * 100);
      resultBox.innerHTML = `
        <div class="glass" style="padding:1rem 1.2rem;">
          <h3 style="margin-bottom:.4rem;">çµæœ: ${correct}/${currentSet.length} (${pct}%)</h3>
          <p style="font-size:.7rem;">${mistakes.length ? 'é–“é•ãˆ: '+mistakes.join(', ') : 'å…¨å•æ­£è§£ï¼'}</p>
        </div>
      `;

      graded = true;
      lastMistakeSet = mistakes;
      mistakeBtn.disabled = mistakes.length === 0;
      persistSession(true);

      typesetMath(questionContainer);
      typesetMath(resultBox);
    }

    function reviewMistakes(){
      if(!lastMistakeSet.length) return;
      currentSet = lastMistakeSet
        .map(id => allQuestions.find(q=> q.id === id))
        .filter(Boolean);
      answers = {};
      graded = false;
      lastMistakeSet = [];
      renderQuestions(currentSet);
      updateMeta('(å¾©ç¿’ã‚»ãƒƒãƒˆ)');
      resultBox.innerHTML = '';
      mistakeBtn.disabled = true;
      persistSession();
    }

    function choiceLabel(q, idx){
      if(!q || !Array.isArray(q.choices) || idx==null || idx<0 || idx>=q.choices.length) return '';
      return String(q.choices[idx]);
    }

    function updateMeta(extra=''){
      const diffInfo = diffSel.value ? `é›£æ˜“åº¦=${diffSel.value}` : 'é›£æ˜“åº¦=å…¨';
      testMeta.textContent = `å•é¡Œæ•°=${currentSet.length} / ${diffInfo} ${extra}`;
    }

    function persistSession(completed=false){
      try{
        const session = {
          version:1,
          timestamp:new Date().toISOString(),
          questions: currentSet,
          answers,
          completed: completed || graded
        };
        localStorage.setItem(LS_KEY, JSON.stringify(session));
      }catch(e){
        console.warn('[comp] session save error', e);
      }
    }

    function typesetMath(scope){
      if(!(window.MathJax && window.MathJax.typesetPromise)) return;
      window.MathJax.typesetPromise([scope]).catch(err=>{
        console.error('[comp] MathJax typeset error', err);
      });
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, c=>({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[c]));
    }
    function escapeAttr(s){
      return escapeHtml(s).replace(/"/g,'&quot;');
    }

  })();
  </script>
</body>
</html>
