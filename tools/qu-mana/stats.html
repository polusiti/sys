<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµ±è¨ˆ - å•é¡Œç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="stylesheet" href="css/style.css">
    <script src="data/config.js"></script>
    <script src="data/question-types.js"></script>
    <script src="data/sample-data.js"></script>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <h1 class="header-title">çµ±è¨ˆ</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary btn-sm" onclick="exportStatistics()">
                        ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    </button>
                </div>
            </div>
        </div>
    </header>

    <nav class="nav">
        <div class="container">
            <a href="index.html" class="nav-item">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
            <a href="create.html" class="nav-item">â• ä½œæˆ</a>
            <a href="list.html" class="nav-item">ğŸ“‹ ä¸€è¦§</a>
            <a href="stats.html" class="nav-item active">ğŸ“ˆ çµ±è¨ˆ</a>
        </div>
    </nav>

    <main class="container">
        <!-- æ¦‚è¦çµ±è¨ˆ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="total-questions">0</div>
                <div class="stat-label">ç·å•é¡Œæ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="published-questions">0</div>
                <div class="stat-label">å…¬é–‹æ¸ˆã¿</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="draft-questions">0</div>
                <div class="stat-label">ä¸‹æ›¸ã</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="deleted-questions">0</div>
                <div class="stat-label">å‰Šé™¤æ¸ˆã¿</div>
            </div>
        </div>

        <!-- å•é¡Œã‚¿ã‚¤ãƒ—åˆ¥çµ±è¨ˆ -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">å•é¡Œã‚¿ã‚¤ãƒ—åˆ¥çµ±è¨ˆ</h2>
            </div>
            <div class="card-body">
                <div id="type-stats">
                    <!-- å‹•çš„ã«ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- é›£æ˜“åº¦åˆ¥çµ±è¨ˆ -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">é›£æ˜“åº¦åˆ¥çµ±è¨ˆ</h2>
            </div>
            <div class="card-body">
                <div id="difficulty-stats">
                    <!-- å‹•çš„ã«ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- æœ€è¿‘ã®æ´»å‹• -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">æœ€è¿‘ã®æ´»å‹•</h2>
            </div>
            <div class="card-body">
                <div id="recent-activity">
                    <!-- å‹•çš„ã«ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- ã‚¿ã‚°çµ±è¨ˆ -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">ã‚¿ã‚°çµ±è¨ˆ</h2>
            </div>
            <div class="card-body">
                <div id="tag-stats">
                    <!-- å‹•çš„ã«ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- æœˆåˆ¥çµ±è¨ˆ -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">æœˆåˆ¥çµ±è¨ˆ</h2>
            </div>
            <div class="card-body">
                <div id="monthly-stats">
                    <!-- å‹•çš„ã«ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </main>

    <script src="js/app.js"></script>
    <script>
        // ãƒšãƒ¼ã‚¸åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeStats();
            
            // å®šæœŸçš„ã«æ›´æ–°
            setInterval(() => {
                if (window.app) {
                    updateStatistics();
                }
            }, 5000);
        });

        function initializeStats() {
            setTimeout(() => {
                if (window.app) {
                    updateStatistics();
                }
            }, 1000);
        }

        function updateStatistics() {
            if (!window.app) return;

            const stats = window.app.statistics;
            
            // æ¦‚è¦çµ±è¨ˆã®æ›´æ–°
            document.getElementById('total-questions').textContent = stats.totalQuestions || 0;
            document.getElementById('published-questions').textContent = stats.questionsByStatus.published || 0;
            document.getElementById('draft-questions').textContent = stats.questionsByStatus.draft || 0;
            document.getElementById('deleted-questions').textContent = stats.questionsByStatus.deleted || 0;
            
            // å•é¡Œã‚¿ã‚¤ãƒ—åˆ¥çµ±è¨ˆ
            updateTypeStats();
            
            // é›£æ˜“åº¦åˆ¥çµ±è¨ˆ
            updateDifficultyStats();
            
            // æœ€è¿‘ã®æ´»å‹•
            updateRecentActivity();
            
            // ã‚¿ã‚°çµ±è¨ˆ
            updateTagStats();
            
            // æœˆåˆ¥çµ±è¨ˆ
            updateMonthlyStats();
        }

        function updateTypeStats() {
            const container = document.getElementById('type-stats');
            const stats = window.app.statistics.questionsByType;
            
            let html = '<div class="stats-grid">';
            Object.keys(stats).forEach(type => {
                const count = stats[type];
                const typeInfo = window.QUESTION_TYPES[type];
                if (typeInfo) {
                    html += `
                        <div class="stat-card">
                            <div class="stat-number">${count}</div>
                            <div class="stat-label">${typeInfo.name}</div>
                        </div>
                    `;
                }
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        function updateDifficultyStats() {
            const container = document.getElementById('difficulty-stats');
            const stats = window.app.statistics.questionsByDifficulty;
            
            let html = '<div class="stats-grid">';
            Object.keys(stats).forEach(difficulty => {
                const count = stats[difficulty];
                html += `
                    <div class="stat-card">
                        <div class="stat-number">${count}</div>
                        <div class="stat-label">${window.CONFIG.DIFFICULTY_LEVELS[difficulty]}</div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        function updateRecentActivity() {
            const container = document.getElementById('recent-activity');
            const activities = window.app.statistics.recentActivity || [];
            
            let html = '<div class="activity-list">';
            activities.slice(0, 10).forEach(activity => {
                const date = new Date(activity.timestamp);
                const dateStr = date.toLocaleDateString('ja-JP');
                const timeStr = date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                
                const actionLabels = {
                    create: 'ä½œæˆ',
                    update: 'æ›´æ–°',
                    delete: 'å‰Šé™¤',
                    publish: 'å…¬é–‹'
                };
                
                html += `
                    <div class="list-item">
                        <div>
                            <div class="text-primary">${actionLabels[activity.action] || activity.action}</div>
                            <div class="text-muted">${activity.type} - ${dateStr} ${timeStr}</div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html || '<p class="text-muted">æœ€è¿‘ã®æ´»å‹•ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
        }

        function updateTagStats() {
            const container = document.getElementById('tag-stats');
            const allTags = {};
            
            // å…¨ã¦ã®ã‚¿ã‚°ã‚’åé›†
            Object.keys(window.app.questions).forEach(type => {
                window.app.questions[type].forEach(question => {
                    if (question.tags) {
                        question.tags.forEach(tag => {
                            allTags[tag] = (allTags[tag] || 0) + 1;
                        });
                    }
                });
            });
            
            // ä½¿ç”¨é »åº¦ã§ã‚½ãƒ¼ãƒˆ
            const sortedTags = Object.entries(allTags)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 20);
            
            let html = '<div class="tag-cloud">';
            sortedTags.forEach(([tag, count]) => {
                const size = Math.max(0.8, Math.min(1.5, count / 5));
                html += `<span class="tag-item" style="font-size: ${size}em;">${tag} (${count})</span>`;
            });
            html += '</div>';
            
            container.innerHTML = html || '<p class="text-muted">ã‚¿ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
        }

        function updateMonthlyStats() {
            const container = document.getElementById('monthly-stats');
            const monthlyStats = {};
            
            // æœˆåˆ¥çµ±è¨ˆã‚’è¨ˆç®—
            Object.keys(window.app.questions).forEach(type => {
                window.app.questions[type].forEach(question => {
                    const date = new Date(question.created);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    
                    if (!monthlyStats[monthKey]) {
                        monthlyStats[monthKey] = {
                            created: 0,
                            published: 0,
                            drafts: 0
                        };
                    }
                    
                    monthlyStats[monthKey].created++;
                    if (question.status === 'published') {
                        monthlyStats[monthKey].published++;
                    } else if (question.status === 'draft') {
                        monthlyStats[monthKey].drafts++;
                    }
                });
            });
            
            // æœˆã§ã‚½ãƒ¼ãƒˆ
            const sortedMonths = Object.keys(monthlyStats).sort().reverse();
            
            let html = '<div class="monthly-stats">';
            sortedMonths.slice(0, 6).forEach(month => {
                const stats = monthlyStats[month];
                html += `
                    <div class="list-item">
                        <div>
                            <div class="text-primary">${month}</div>
                            <div class="text-muted">
                                ä½œæˆ: ${stats.created} | 
                                å…¬é–‹: ${stats.published} | 
                                ä¸‹æ›¸ã: ${stats.drafts}
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html || '<p class="text-muted">æœˆåˆ¥çµ±è¨ˆã¯ã‚ã‚Šã¾ã›ã‚“</p>';
        }

        function exportStatistics() {
            if (!window.app) return;
            
            try {
                const stats = window.app.statistics;
                const exportData = {
                    statistics: stats,
                    questions: window.app.questions,
                    exported: new Date().toISOString(),
                    version: window.app.config.VERSION
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `statistics_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                window.app.showNotification('çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ', 'success');
            } catch (error) {
                window.app.showNotification('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }
    </script>
</body>
</html>