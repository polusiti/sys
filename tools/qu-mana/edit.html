<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•é¡Œç·¨é›† - å•é¡Œç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="stylesheet" href="css/style.css">
    <script src="data/config.js"></script>
    <script src="data/question-types.js"></script>
    <script src="data/sample-data.js"></script>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <h1 class="header-title">å•é¡Œç·¨é›†</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary btn-sm" onclick="goBack()">
                        â† æˆ»ã‚‹
                    </button>
                </div>
            </div>
        </div>
    </header>

    <nav class="nav">
        <div class="container">
            <a href="index.html" class="nav-item">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
            <a href="create.html" class="nav-item">â• ä½œæˆ</a>
            <a href="list.html" class="nav-item">ğŸ“‹ ä¸€è¦§</a>
            <a href="stats.html" class="nav-item">ğŸ“ˆ çµ±è¨ˆ</a>
        </div>
    </nav>

    <main class="container">
        <div id="loading" class="card">
            <div class="card-body text-center">
                <p>èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
        </div>

        <div id="edit-form" class="card" style="display: none;">
            <div class="card-header">
                <h2 class="card-title">å•é¡Œç·¨é›†</h2>
                <div class="question-meta">
                    <span class="badge badge-secondary" id="question-type-badge"></span>
                    <span class="badge badge-secondary" id="question-version"></span>
                </div>
            </div>
            <div class="card-body">
                <form id="question-edit-form">
                    <!-- åŸºæœ¬æƒ…å ± -->
                    <div class="form-group">
                        <label class="form-label">å•é¡Œã‚¿ã‚¤ãƒ—</label>
                        <input type="text" id="edit-type" class="form-input" readonly>
                    </div>

                    <div class="form-group">
                        <label class="form-label">é›£æ˜“åº¦</label>
                        <select id="edit-difficulty" class="form-select" required>
                            <option value="1">åˆç´š</option>
                            <option value="2">ä¸­ç´š</option>
                            <option value="3">ä¸Šç´š</option>
                            <option value="4">æœ€ä¸Šç´š</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                        <select id="edit-status" class="form-select" required>
                            <option value="draft">ä¸‹æ›¸ã</option>
                            <option value="published">å…¬é–‹</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ã‚¿ã‚°</label>
                        <input type="text" id="edit-tags" class="form-input" placeholder="ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›">
                    </div>

                    <!-- å‹•çš„ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
                    <div id="edit-dynamic-fields">
                        <!-- å•é¡Œã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦å‹•çš„ã«ç”Ÿæˆ -->
                    </div>

                    <!-- å¤‰æ›´å±¥æ­´ -->
                    <div class="form-group">
                        <label class="form-label">å¤‰æ›´å±¥æ­´</label>
                        <div id="version-history" class="version-history">
                            <!-- å‹•çš„ã«ç”Ÿæˆ -->
                        </div>
                    </div>

                    <!-- ãƒœã‚¿ãƒ³ -->
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary btn-block">
                            ğŸ’¾ ä¿å­˜
                        </button>
                        <button type="button" class="btn btn-secondary btn-block" onclick="previewQuestion()">
                            ğŸ‘ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                        </button>
                        <button type="button" class="btn btn-warning btn-block" onclick="createNewVersion()">
                            ğŸ”„ æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½œæˆ
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="preview-section" class="card" style="display: none;">
            <div class="card-header">
                <h2 class="card-title">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
            </div>
            <div class="card-body">
                <div id="preview-content">
                    <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…å®¹ã‚’å‹•çš„ã«ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </main>

    <script src="js/app.js"></script>
    <script>
        let currentQuestion = null;
        let currentType = null;
        let currentId = null;

        // ãƒšãƒ¼ã‚¸åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadQuestion();
        });

        function loadQuestion() {
            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å•é¡Œæƒ…å ±ã‚’å–å¾—
            const urlParams = new URLSearchParams(window.location.search);
            currentType = urlParams.get('type');
            currentId = urlParams.get('id');

            if (!currentType || !currentId) {
                alert('å•é¡Œæƒ…å ±ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                window.location.href = 'list.html';
                return;
            }

            // ã‚¢ãƒ—ãƒªãŒåˆæœŸåŒ–ã•ã‚Œã‚‹ã®ã‚’å¾…ã£ã¦ã‹ã‚‰å•é¡Œã‚’èª­ã¿è¾¼ã¿
            setTimeout(() => {
                if (window.app) {
                    currentQuestion = window.app.getQuestion(currentType, currentId);
                    if (currentQuestion) {
                        displayQuestion();
                    } else {
                        alert('å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                        window.location.href = 'list.html';
                    }
                } else {
                    alert('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }
            }, 1000);
        }

        function displayQuestion() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('edit-form').style.display = 'block';

            // åŸºæœ¬æƒ…å ±ã‚’è¡¨ç¤º
            document.getElementById('edit-type').value = currentQuestion.type;
            document.getElementById('edit-difficulty').value = currentQuestion.difficulty;
            document.getElementById('edit-status').value = currentQuestion.status;
            document.getElementById('edit-tags').value = currentQuestion.tags ? currentQuestion.tags.join(', ') : '';

            // å•é¡Œã‚¿ã‚¤ãƒ—ãƒãƒƒã‚¸
            const questionType = window.QUESTION_TYPES[currentQuestion.type];
            document.getElementById('question-type-badge').textContent = questionType.name;
            document.getElementById('question-version').textContent = `v${currentQuestion.version || 1}`;

            // å‹•çš„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç”Ÿæˆ
            generateDynamicFields();

            // å¤‰æ›´å±¥æ­´ã‚’è¡¨ç¤º
            displayVersionHistory();
        }

        function generateDynamicFields() {
            const container = document.getElementById('edit-dynamic-fields');
            container.innerHTML = '';

            const questionType = window.QUESTION_TYPES[currentQuestion.type];
            
            questionType.fields.forEach(field => {
                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';
                
                const label = document.createElement('label');
                label.className = 'form-label';
                label.textContent = field.label;
                if (field.required) {
                    label.textContent += ' *';
                }
                
                let input;
                if (field.type === 'textarea') {
                    input = document.createElement('textarea');
                    input.className = 'form-textarea';
                    input.rows = 4;
                } else if (field.type === 'array') {
                    input = document.createElement('textarea');
                    input.className = 'form-textarea';
                    input.placeholder = '1è¡Œã«1ã¤ãšã¤å…¥åŠ›ã—ã¦ãã ã•ã„';
                } else {
                    input = document.createElement('input');
                    input.type = field.type;
                    input.className = 'form-input';
                }
                
                input.id = 'edit-' + field.name;
                input.name = field.name;
                if (field.required) {
                    input.required = true;
                }
                
                // ç¾åœ¨ã®å€¤ã‚’è¨­å®š
                const currentValue = currentQuestion[field.name];
                if (currentValue !== undefined) {
                    if (field.type === 'array') {
                        input.value = currentValue.join('\n');
                    } else {
                        input.value = currentValue;
                    }
                }
                
                formGroup.appendChild(label);
                formGroup.appendChild(input);
                
                container.appendChild(formGroup);
            });
        }

        function displayVersionHistory() {
            const container = document.getElementById('version-history');
            
            // ç°¡æ˜“çš„ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³å±¥æ­´è¡¨ç¤º
            let html = `
                <div class="version-item">
                    <div class="version-header">
                        <span class="badge badge-primary">v${currentQuestion.version || 1}</span>
                        <span class="text-muted">${new Date(currentQuestion.modified || currentQuestion.created).toLocaleString('ja-JP')}</span>
                    </div>
                    <div class="version-info">
                        <p>ä½œæˆè€…: ${currentQuestion.created_by || 'unknown'}</p>
                        ${currentQuestion.modified_by ? `<p>æ›´æ–°è€…: ${currentQuestion.modified_by}</p>` : ''}
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function collectFormData() {
            const formData = {
                difficulty: parseInt(document.getElementById('edit-difficulty').value),
                status: document.getElementById('edit-status').value,
                tags: document.getElementById('edit-tags').value ? 
                    document.getElementById('edit-tags').value.split(',').map(t => t.trim()) : []
            };

            // å‹•çš„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
            const questionType = window.QUESTION_TYPES[currentQuestion.type];
            questionType.fields.forEach(field => {
                const input = document.getElementById('edit-' + field.name);
                if (input) {
                    if (field.type === 'array') {
                        formData[field.name] = input.value.split('\n').filter(line => line.trim());
                    } else {
                        formData[field.name] = input.value;
                    }
                }
            });

            return formData;
        }

        function previewQuestion() {
            const formData = collectFormData();
            const previewData = { ...currentQuestion, ...formData };
            
            const previewSection = document.getElementById('preview-section');
            const previewContent = document.getElementById('preview-content');
            
            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼HTMLã‚’ç”Ÿæˆ
            let previewHtml = generatePreviewHtml(previewData);
            previewContent.innerHTML = previewHtml;
            previewSection.style.display = 'block';
            
            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            previewSection.scrollIntoView({ behavior: 'smooth' });
        }

        function generatePreviewHtml(data) {
            const questionType = window.QUESTION_TYPES[data.type];
            let html = `<div class="preview-question">`;
            html += `<h3>${questionType.name}</h3>`;
            html += `<p><strong>é›£æ˜“åº¦:</strong> ${window.CONFIG.DIFFICULTY_LEVELS[data.difficulty]}</p>`;
            html += `<p><strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong> ${data.status === 'published' ? 'å…¬é–‹' : 'ä¸‹æ›¸ã'}</p>`;
            
            if (data.tags.length > 0) {
                html += `<p><strong>ã‚¿ã‚°:</strong> ${data.tags.map(tag => `<span class="badge badge-secondary">${tag}</span>`).join(' ')}</p>`;
            }

            // å•é¡Œã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆcreate.htmlã¨åŒæ§˜ï¼‰
            switch (data.type) {
                case 'vocab_meaning':
                    html += `<div class="question-preview">`;
                    html += `<p><strong>å˜èª:</strong> ${data.word}</p>`;
                    html += `<div class="options">`;
                    data.options.forEach((option, index) => {
                        html += `<div class="option">${index + 1}. ${option}</div>`;
                    });
                    html += `</div>`;
                    html += `<p><strong>æ­£è§£:</strong> ${data.correct}</p>`;
                    html += `</div>`;
                    break;
                    
                case 'vocab_fill':
                    html += `<div class="question-preview">`;
                    html += `<p><strong>è‹±æ–‡:</strong> ${data.sentence.replace('_____', `<u>${data.blank_word}</u>`)}</p>`;
                    html += `<div class="options">`;
                    data.options.forEach((option, index) => {
                        html += `<div class="option">${index + 1}. ${option}</div>`;
                    });
                    html += `</div>`;
                    html += `</div>`;
                    break;
                    
                case 'grammar_reorder':
                    html += `<div class="question-preview">`;
                    html += `<p><strong>å˜èª:</strong> ${data.scrambled_words.join(', ')}</p>`;
                    html += `<p><strong>æ­£è§£:</strong> ${data.correct_order.join(' ')}</p>`;
                    html += `</div>`;
                    break;
                    
                case 'reading_comprehension':
                    html += `<div class="question-preview">`;
                    html += `<p><strong>æœ¬æ–‡:</strong></p>`;
                    html += `<div class="passage">${data.passage}</div>`;
                    html += `<p><strong>è¨­å•æ•°:</strong> ${data.questions.length}</p>`;
                    html += `</div>`;
                    break;
                    
                case 'summary_short':
                case 'summary_medium':
                case 'summary_long':
                    html += `<div class="question-preview">`;
                    html += `<p><strong>æœ¬æ–‡:</strong></p>`;
                    html += `<div class="passage">${data.passage}</div>`;
                    html += `<p><strong>ç›®æ¨™å­—æ•°:</strong> ${data.target_length}å­—</p>`;
                    if (data.sample_answer) {
                        html += `<p><strong>æ¨¡ç¯„è§£ç­”:</strong> ${data.sample_answer}</p>`;
                    }
                    html += `</div>`;
                    break;
                    
                default:
                    html += `<p>ã“ã®å•é¡Œã‚¿ã‚¤ãƒ—ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ã¾ã å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>`;
            }
            
            html += `</div>`;
            return html;
        }

        function createNewVersion() {
            if (confirm('æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ä¿æŒã•ã‚Œã¾ã™ã€‚')) {
                // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
                const formData = collectFormData();
                formData.version = (currentQuestion.version || 1) + 1;
                
                try {
                    const updatedQuestion = window.app.updateQuestion(currentType, currentId, formData);
                    currentQuestion = updatedQuestion;
                    displayQuestion();
                    window.app.showNotification('æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã—ãŸ', 'success');
                } catch (error) {
                    window.app.showNotification('ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            }
        }

        function goBack() {
            window.location.href = 'list.html';
        }

        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
        document.getElementById('question-edit-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = collectFormData();
            
            if (window.app) {
                try {
                    const updatedQuestion = window.app.updateQuestion(currentType, currentId, formData);
                    currentQuestion = updatedQuestion;
                    displayQuestion();
                    window.app.showNotification('å•é¡Œã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
                } catch (error) {
                    window.app.showNotification('å•é¡Œã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                    console.error('Update question failed:', error);
                }
            } else {
                alert('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
            }
        });
    </script>
</body>
</html>