<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数式エディタ - Math Creator</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" integrity="sha384-GvrOXuhMATgEsSwCs4smul74iXGOixntILdUW9XmUC6+HX0sLNAK3q71HotJqlAn" crossorigin="anonymous">
    
    <style>
        :root {
            /* API Configuration */
            --api-base-url: '';
            --enable-auth: false; /* Set to true when authentication is fully implemented */

            /* index.htmlと共通のカラーテーマ */
            --primary-color: #2196F3;
            --secondary-color: #1976D2;
            --accent-color: #03A9F4;
            --success-color: #4CAF50;
            --warning-color: #FF9800;
            --error-color: #F44336;
            --info-color: #00BCD4;

            /* ニュートラルカラー */
            --bg-color: #f5f5f5;
            --surface-color: #ffffff;
            --text-color: #212121;
            --text-secondary: #757575;
            --border-color: #e0e0e0;
            --hover-bg: #f0f0f0;

            /* レスポンシブサイズ */
            --navbar-height: 56px;
            --bottom-nav-height: 60px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            overflow-x: hidden;
            padding-top: var(--navbar-height);
            padding-bottom: var(--bottom-nav-height);
        }

        /* ナビゲーションバー */
        .navbar-custom {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: var(--navbar-height);
        }

        .navbar-custom .navbar-brand {
            font-weight: 600;
            color: white !important;
        }

        .navbar-custom .nav-link {
            color: rgba(255,255,255,0.8) !important;
            transition: color 0.3s;
        }

        .navbar-custom .nav-link:hover {
            color: white !important;
        }

        /* 認証ステータス表示 */
        .auth-status {
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 0.85rem;
            backdrop-filter: blur(10px);
        }

        .auth-status.logged-in {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        /* KaTeXプレビューエリア */
        .preview-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }

        .preview-placeholder {
            color: #9e9e9e;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        #mathPreview {
            font-size: 1.2em;
            line-height: 1.6;
            width: 100%;
            text-align: center;
            display: block;
        }

        #mathPreview .katex {
            font-size: 1em !important;
        }

        #mathPreview .katex-display {
            margin: 10px 0 !important;
        }

        /* 横長数式用のスクロールコンテナ */
        .long-math-container {
            overflow-x: auto;
            overflow-y: hidden;
            max-width: 100%;
            width: 100%;
            display: block;
            text-align: center;
            border-radius: 4px;
            padding: 8px 0;
            margin: -8px 0;
            box-sizing: border-box;
        }

        .long-math-container .katex,
        .long-math-container .katex-display {
            max-width: none;
            display: inline-block;
        }

        .long-math-container .katex-display {
            margin: 0 auto !important;
        }

        .long-math-container::-webkit-scrollbar {
            height: 6px;
        }

        .long-math-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .long-math-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        .long-math-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        #normalizedOutput {
            background: #f5f5f5;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #666;
            border: 1px solid #ddd;
        }

        /* タグシステムスタイル - フォーム統一 */
        .tag-input-wrapper {
            position: relative;
            width: 100%;
        }

        .tag-input-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tag-input-field {
            flex: 1;
            padding: 12px;
            font-size: 1rem;
            border: 1px solid #ced4da;
            border-radius: 8px;
            background-color: white;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .tag-input-field:focus {
            color: #495057;
            background-color: #fff;
            border-color: var(--primary-color);
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(33, 150, 243, 0.25);
        }

        .tag-add-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 36px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease-in-out;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            font-size: 0.85rem;
            font-weight: 500;
            padding: 0 8px;
        }

        .tag-add-button:hover {
            background: #1976d2;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }

        .tag-add-button:active {
            transform: scale(0.97);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* Star Rating System */
        .star-rating-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 8px 0;
        }

        .star-rating {
            display: flex;
            gap: 4px;
            font-size: 1.5rem;
        }

        .star-rating .fa-star {
            cursor: pointer;
            transition: all 0.2s ease;
            color: #ddd;
        }

        .star-rating .fa-star:hover,
        .star-rating .fa-star.active {
            color: #ffc107;
        }

        .star-rating .fa-star:hover {
            transform: scale(1.1);
        }

        .rating-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
            white-space: nowrap;
        }

  
        .tag-display-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 16px;
            padding: 16px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
            max-height: 200px;
            overflow-y: auto;
        }

        .tag {
            background: var(--primary-color);
            color: white;
            padding: 10px 24px;
            border-radius: 20px;
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
            gap: 12px;
            animation: tagAppear 0.2s ease-out;
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 500;
        }

        @keyframes tagAppear {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .tag-remove {
            cursor: pointer;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: background 0.2s;
            flex-shrink: 0;
        }

        .tag-remove:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .tag-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ced4da;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin-top: 1px;
            width: 100%;
            box-sizing: border-box;
        }

        .tag-suggestion {
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.9em;
        }

        .tag-suggestion:hover {
            background: #f0f0f0;
        }

        .tag-suggestion.selected {
            background: var(--primary-color);
            color: white;
        }

        /* タグシステムのモバイル対応 */
        @media (max-width: 768px) {
            .tag {
                max-width: 140px;
                font-size: 0.8em;
                padding: 3px 10px;
            }
            .tag-input-field {
                font-size: 1.1em;
                padding: 14px;
            }
            .tag-add-button {
                width: 70px;
                height: 40px;
                font-size: 0.9rem;
            }
            .tag-remove {
                width: 18px;
                height: 18px;
                font-size: 12px;
            }
            .tag-display-container {
                max-height: 150px;
            }
        }

        @media (max-width: 480px) {
            .tag {
                max-width: 100px;
                font-size: 0.75em;
                padding: 2px 6px;
            }
            .tag-input-field {
                font-size: 1em;
                padding: 10px;
            }
            .tag-display-container {
                max-height: 120px;
                padding: 6px;
            }
            .tag-counter {
                font-size: 0.7em;
            }
        }

        /* タッチデバイス向けの最適化 */
        @media (hover: none) and (pointer: coarse) {
            .tag-input-field {
                touch-action: manipulation;
            }
            .tag-remove {
                min-width: 24px;
                min-height: 24px;
            }
            .tag {
                padding: 6px 12px;
            }
        }

        /* タグがはみ出す問題を修正 */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            margin-bottom: 0.75rem;
            font-weight: 500;
        }

        .auth-status.logged-out {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        /* メインコンテナ */
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* カードスタイル */
        .custom-card {
            background: var(--surface-color);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: none;
            margin-bottom: 20px;
        }

        .custom-card .card-header {
            background: transparent;
            border-bottom: 1px solid var(--border-color);
            padding: 16px 20px;
            font-weight: 600;
            color: var(--text-color);
        }

        .custom-card .card-body {
            padding: 20px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 1.4rem;
            margin: 0;
        }

        .back-link {
            color: white;
            text-decoration: none;
            font-weight: 500;
            opacity: 0.9;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .back-link:hover {
            opacity: 1;
        }

        /* 革命的トリプルペインレイアウト */
        .triple-pane-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            height: calc(100vh - 80px);
            gap: 0;
        }

        .input-pane {
            background: var(--editor-bg);
            border-right: 2px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .preview-pane {
            background: var(--preview-bg);
            border-right: 2px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .tools-pane {
            background: var(--bg-color);
            display: flex;
            flex-direction: column;
        }

        /* 数学入力モード選択 */
        .mode-selector {
            background: white;
            border-bottom: 2px solid var(--border-color);
            padding: 10px;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .mode-btn {
            padding: 6px 12px;
            background: var(--editor-bg);
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .mode-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .mode-btn:hover:not(.active) {
            background: var(--hover-bg);
        }

        /* KaTeX対応LaTeXツールバー */
        .latex-toolbar {
            background: white;
            border-bottom: 2px solid var(--border-color);
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 6px;
            max-height: 180px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            overscroll-behavior: contain;
            touch-action: pan-y;
            scroll-padding: 4px;
        }

        .latex-btn {
            background: var(--editor-bg);
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 6px 3px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.15s ease;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            position: relative;
            -webkit-touch-callout: none;
            -webkit-user-drag: none;
            -khtml-user-drag: none;
            -moz-user-drag: none;
            -o-user-drag: none;
            user-drag: none;
        }

        .latex-btn:active {
            transform: scale(0.95);
            transition: transform 0.1s;
        }

        .latex-btn:hover {
            background: var(--hover-bg);
            transform: translateY(-1px);
        }

        .latex-btn:active {
            background: var(--accent-color);
            color: white;
            transform: translateY(0) scale(0.97);
        }

        .latex-btn.flash {
            background: var(--success-color) !important;
            color: white !important;
            transform: scale(0.95) !important;
        }

        /* 入力エリア */
        .input-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 15px;
        }

        .section-header {
            font-size: 1rem;
            font-weight: 600;
            color: var(--secondary-color);
            margin-bottom: 10px;
            padding: 6px 10px;
            background: white;
            border-radius: 6px;
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .clear-button {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 4px 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .clear-button:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        .input-textarea {
            flex: 1;
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 1rem;
            font-family: 'Noto Sans JP', 'Courier New', Consolas, monospace;
            line-height: 1.5;
            resize: none;
            outline: none;
            transition: border-color 0.2s;
            background: white;
        }

        .input-textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* プレビューエリア */
        .preview-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 15px;
        }

        .preview-content {
            flex: 1;
            padding: 15px;
            border-radius: 6px;
            background: white;
            overflow-x: hidden;
            overflow-y: auto;
            font-size: 1.1rem;
            line-height: 1.6;
            border: 1px solid #f3f4f6;
            word-break: break-word;
        }

    
        /* ツールペイン */
        .tools-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 15px;
        }

        /* サンプル数式チップ */
        .sample-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 15px;
        }

        /* 分野タブ */
        .field-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
            padding: 0 10px;
        }

        .field-tab {
            padding: 8px 16px;
            background: transparent;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .field-tab.active {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

        .field-tab:hover:not(.active) {
            background: var(--hover-bg);
            color: var(--text-color);
        }

        /* 分野コンテンツ */
        .field-content {
            animation: fadeIn 0.3s ease-in-out;
        }

        .subsection-header {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-color);
            margin: 15px 0 10px 0;
            padding-left: 5px;
            border-left: 3px solid var(--primary-color);
        }

        .subsection-header:first-of-type {
            margin-top: 0;
        }

        .sample-chip {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
            font-family: 'Noto Sans JP', 'Courier New', Consolas, monospace;
            -webkit-touch-callout: none;
            -webkit-user-drag: none;
            -khtml-user-drag: none;
            -moz-user-drag: none;
            -o-user-drag: none;
            user-drag: none;
            touch-action: manipulation;
        }

        .sample-chip:hover {
            background: var(--hover-bg);
            transform: translateY(-1px);
        }

        .sample-chip:active {
            background: var(--primary-color);
            color: white;
        }

        /* 状態表示 */
        .status-area {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            min-height: 60px;
        }

        .status-message {
            padding: 8px 10px;
            border-radius: 4px;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .status-message.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid var(--success-color);
        }

        .status-message.warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid var(--warning-color);
        }

        .status-message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid var(--error-color);
        }

        /* 保存エリア */
        .save-section {
            background: white;
            border-top: 2px solid var(--border-color);
            padding: 12px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 500;
            margin-bottom: 4px;
            color: #374151;
            font-size: 0.85rem;
        }

        .form-group input,
        .form-group select {
            padding: 6px 8px;
            border: 2px solid #e5e7eb;
            border-radius: 4px;
            font-size: 0.85rem;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .save-button {
            grid-column: 1 / -1;
            padding: 10px 16px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .save-button:hover {
            background: var(--secondary-color);
            transform: translateY(-1px);
        }

        /* モバイル最適化 - スマホファースト設計 */
        @media (max-width: 1024px) {
            .triple-pane-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto 1fr;
                height: auto;
                min-height: calc(100vh - 80px);
            }

            .input-pane,
            .preview-pane,
            .tools-pane {
                border-right: none;
                border-bottom: 2px solid var(--border-color);
            }

            .tools-pane {
                order: -1; /* ツールペインを最上部に */
                max-height: 35vh;
                overflow-y: auto;
            }

            .latex-toolbar {
                grid-template-columns: repeat(auto-fit, minmax(85px, 1fr));
                gap: 10px;
                padding: 15px;
                max-height: 200px;
                overflow-y: scroll;
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
                overscroll-behavior: contain;
                touch-action: pan-y;
                scroll-snap-type: y mandatory;
                scroll-padding: 6px;
            }

            .latex-btn {
                min-height: 50px;
                font-size: 1rem;
                padding: 8px 4px;
            }

            .mode-selector {
                padding: 12px;
                gap: 8px;
            }

            .mode-btn {
                padding: 8px 12px;
                font-size: 0.9rem;
                min-height: 40px;
            }

            .sample-chips {
                gap: 8px;
                margin-bottom: 20px;
            }

            .sample-chip {
                padding: 8px 12px;
                font-size: 0.9rem;
                min-height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.1rem;
            }

            .header-content {
                padding: 10px 15px;
            }

            .latex-toolbar {
                grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
                gap: 12px;
                padding: 15px;
                overflow-y: scroll;
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
                overscroll-behavior: contain;
                touch-action: pan-y;
                scroll-snap-type: y mandatory;
                scroll-padding: 6px;
            }

            .latex-btn {
                min-height: 55px;
                font-size: 1.1rem;
                border-radius: 8px;
            }

            .mode-btn {
                min-height: 45px;
                border-radius: 20px;
                font-weight: 600;
            }

            .input-textarea {
                font-size: 1.1rem;
                padding: 15px;
                line-height: 1.6;
            }

            .section-header {
                font-size: 1.1rem;
                padding: 10px 15px;
            }

            .save-button {
                padding: 15px 20px;
                font-size: 1.1rem;
                border-radius: 8px;
                margin-top: 15px;
            }

            .form-group input,
            .form-group select {
                padding: 12px;
                font-size: 1rem;
                border-radius: 8px;
            }
        }

        @media (max-width: 480px) {
            .header-content {
                flex-direction: column;
                gap: 8px;
                text-align: center;
            }

            .latex-toolbar {
                grid-template-columns: repeat(auto-fit, minmax(65px, 1fr));
                gap: 14px;
                padding: 20px 15px;
                overflow-y: scroll;
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
                overscroll-behavior: contain;
                touch-action: pan-y;
                scroll-snap-type: y mandatory;
                scroll-padding: 8px;
            }

            .latex-btn {
                min-height: 60px;
                font-size: 1.2rem;
                border-radius: 10px;
                border-width: 2px;
            }

            .mode-selector {
                padding: 15px;
                gap: 10px;
                justify-content: center;
            }

            .mode-btn {
                min-height: 50px;
                padding: 10px 15px;
                font-size: 1rem;
                border-radius: 25px;
                font-weight: 700;
                min-width: 80px;
            }

            .sample-chip {
                min-height: 45px;
                padding: 10px 15px;
                font-size: 1rem;
                border-radius: 15px;
                font-weight: 600;
            }

            .input-section,
            .preview-section,
            .tools-section {
                padding: 20px 15px;
            }

            .input-textarea {
                font-size: 1.2rem;
                padding: 20px;
                border-radius: 10px;
                border-width: 3px;
                font-family: 'Noto Sans JP', 'Courier New', Consolas, monospace;
            }

            .preview-content {
                padding: 20px;
                border-radius: 10px;
                font-size: 1.2rem;
                border: 1px solid #f3f4f6;
                overflow-x: hidden;
                overflow-y: auto;
                word-break: break-word;
            }

            .save-section {
                padding: 20px 15px;
                gap: 15px;
                grid-template-columns: 1fr;
            }

            .save-button {
                padding: 18px 25px;
                font-size: 1.2rem;
                font-weight: 700;
                border-radius: 10px;
                margin-top: 20px;
            }

            .form-group {
                margin-bottom: 15px;
            }

            .form-group label {
                font-size: 1rem;
                margin-bottom: 8px;
                font-weight: 600;
            }

            .form-group input,
            .form-group select {
                padding: 15px;
                font-size: 1.1rem;
                border-radius: 10px;
                border-width: 3px;
                min-height: 50px;
            }

            .normalized-output {
                padding: 15px;
                font-size: 1rem;
                border-radius: 10px;
                font-family: 'Noto Sans JP', 'Courier New', Consolas, monospace;
                border: 1px solid #dbeafe;
            }

            .status-area {
                padding: 15px;
                border-radius: 10px;
                border-width: 3px;
                min-height: 80px;
            }

            .status-message {
                padding: 12px;
                font-size: 1rem;
                border-radius: 8px;
            }
        }

        /* KaTeX スタイル最適化 */
        .katex {
            font-size: 1.1rem !important;
        }

        .katex-display {
            margin: 10px 0 !important;
        }

        /* プレースホルダー */
        .preview-placeholder {
            color: #9ca3af;
            font-style: italic;
            text-align: center;
            opacity: 0.7;
            margin-top: 30px;
        }

        /* スクロールバー最適化 */
        .latex-toolbar::-webkit-scrollbar,
        .preview-content::-webkit-scrollbar,
        .tools-section::-webkit-scrollbar {
            width: 4px;
        }

        .latex-toolbar::-webkit-scrollbar-track,
        .preview-content::-webkit-scrollbar-track,
        .tools-section::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 2px;
        }

        .latex-toolbar::-webkit-scrollbar-thumb,
        .preview-content::-webkit-scrollbar-thumb,
        .tools-section::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-custom">
        <div class="container-fluid">
            <a class="navbar-brand" href="../">
                <i class="fas fa-calculator me-2"></i>Math Creator
            </a>

            <div class="d-flex align-items-center">
                <!-- 認証ステータス -->
                <div id="authStatus" class="auth-status logged-out me-3">
                    <i class="fas fa-user-times me-1"></i>
                    <span>未ログイン</span>
                </div>

                <!-- ログイン/ログアウトボタン -->
                <button id="authButton" class="btn btn-outline-light btn-sm" onclick="handleAuth()">
                    <i class="fas fa-sign-in-alt me-1"></i>
                    ログイン
                </button>
            </div>
        </div>
    </nav>

    <!-- メインコンテンツ -->
    <div class="main-container">
        <!-- 認証チェック -->
        <div id="authWarning" class="alert alert-warning" style="display: none;">
            <i class="fas fa-exclamation-triangle me-2"></i>
            問題を投稿するにはログインが必要です。
            <button class="btn btn-primary btn-sm ms-2" onclick="handleAuth()">
                <i class="fas fa-sign-in-alt me-1"></i>
                ログイン
            </button>
        </div>

        <!-- エディタカード -->
        <div class="custom-card" id="editorCard">
            <div class="card-body">
                <div class="triple-pane-container">
                    <!-- 入力ペイン -->
                    <div class="input-pane">
                <!-- モード選択 -->
                <div class="mode-selector">
                    <button class="mode-btn active" data-mode="symbols">文字</button>
                    <button class="mode-btn" data-mode="structures">構造</button>
                    <button class="mode-btn" data-mode="operators">演算子</button>
                    <button class="mode-btn" data-mode="relations">関係記号</button>
                </div>

                <!-- 文字ツールバー -->
                <div class="latex-toolbar" id="symbolsToolbar" style="display: grid;">
                    <!-- ギリシャ文字（小文字） -->
                    <button class="latex-btn" data-latex="\alpha" title="アルファ">$\alpha$</button>
                    <button class="latex-btn" data-latex="\beta" title="ベータ">$\beta$</button>
                    <button class="latex-btn" data-latex="\gamma" title="ガンマ">$\gamma$</button>
                    <button class="latex-btn" data-latex="\delta" title="デルタ">$\delta$</button>
                    <button class="latex-btn" data-latex="\epsilon" title="イプシロン">$\epsilon$</button>
                    <button class="latex-btn" data-latex="\zeta" title="ゼータ">$\zeta$</button>
                    <button class="latex-btn" data-latex="\eta" title="イータ">$\eta$</button>
                    <button class="latex-btn" data-latex="\theta" title="シータ">$\theta$</button>
                    <button class="latex-btn" data-latex="\iota" title="イオタ">$\iota$</button>
                    <button class="latex-btn" data-latex="\kappa" title="カッパ">$\kappa$</button>
                    <button class="latex-btn" data-latex="\lambda" title="ラムダ">$\lambda$</button>
                    <button class="latex-btn" data-latex="\mu" title="ミュー">$\mu$</button>
                    <button class="latex-btn" data-latex="\nu" title="ニュー">$\nu$</button>
                    <button class="latex-btn" data-latex="\xi" title="クシー">$\xi$</button>
                    <button class="latex-btn" data-latex="\omicron" title="オミクロン">$\omicron$</button>
                    <button class="latex-btn" data-latex="\pi" title="パイ">$\pi$</button>
                    <button class="latex-btn" data-latex="\rho" title="ロー">$\rho$</button>
                    <button class="latex-btn" data-latex="\sigma" title="シグマ">$\sigma$</button>
                    <button class="latex-btn" data-latex="\tau" title="タウ">$\tau$</button>
                    <button class="latex-btn" data-latex="\upsilon" title="ウプシロン">$\upsilon$</button>
                    <button class="latex-btn" data-latex="\phi" title="ファイ">$\phi$</button>
                    <button class="latex-btn" data-latex="\chi" title="カイ">$\chi$</button>
                    <button class="latex-btn" data-latex="\psi" title="プシー">$\psi$</button>
                    <button class="latex-btn" data-latex="\omega" title="オメガ">$\omega$</button>

                    <!-- ギリシャ文字（大文字） -->
                    <button class="latex-btn" data-latex="\Gamma" title="ガンマ（大文字）">$\Gamma$</button>
                    <button class="latex-btn" data-latex="\Delta" title="デルタ（大文字）">$\Delta$</button>
                    <button class="latex-btn" data-latex="\Theta" title="シータ（大文字）">$\Theta$</button>
                    <button class="latex-btn" data-latex="\Lambda" title="ラムダ（大文字）">$\Lambda$</button>
                    <button class="latex-btn" data-latex="\Xi" title="クシー（大文字）">$\Xi$</button>
                    <button class="latex-btn" data-latex="\Pi" title="パイ（大文字）">$\Pi$</button>
                    <button class="latex-btn" data-latex="\Sigma" title="シグマ（大文字）">$\Sigma$</button>
                    <button class="latex-btn" data-latex="\Upsilon" title="ウプシロン（大文字）">$\Upsilon$</button>
                    <button class="latex-btn" data-latex="\Phi" title="ファイ（大文字）">$\Phi$</button>
                    <button class="latex-btn" data-latex="\Psi" title="プシー（大文字）">$\Psi$</button>
                    <button class="latex-btn" data-latex="\Omega" title="オメガ（大文字）">$\Omega$</button>

                    <!-- 数学定数・特殊記号 -->
                    <button class="latex-btn" data-latex="e" title="ネイピア数">$e$</button>
                    <button class="latex-btn" data-latex="i" title="虚数単位">$i$</button>
                    <button class="latex-btn" data-latex="\infty" title="無限大">$\infty$</button>
                    <button class="latex-btn" data-latex="\emptyset" title="空集合">$\emptyset$</button>
                    <button class="latex-btn" data-latex="\nabla" title="ナブラ">$\nabla$</button>
                    <button class="latex-btn" data-latex="\partial" title="偏微分記号">$\partial$</button>
                    <button class="latex-btn" data-latex="\hbar" title="換算プランク定数">$\hbar$</button>
                    <button class="latex-btn" data-latex="\Re" title="実部">$\Re$</button>
                    <button class="latex-btn" data-latex="\Im" title="虚部">$\Im$</button>
                    <button class="latex-btn" data-latex="\ell" title="手書きのl">$\ell$</button>

                    <!-- 数学的記号 -->
                    <button class="latex-btn" data-latex="\prime" title="プライム">$'$</button>
                    <button class="latex-btn" data-latex="\backprime" title="バックプライム">$\backprime$</button>
                    <button class="latex-btn" data-latex="\ast" title="アスタリスク">$\ast$</button>
                    <button class="latex-btn" data-latex="\star" title="スター">$\star$</button>
                    <button class="latex-btn" data-latex"\dagger" title="ダガー">$\dagger$</button>
                    <button class="latex-btn" data-latex="\ddagger" title="ダブルダガー">$\ddagger$</button>

                    <!-- 無限集合・区間 -->
                    <button class="latex-btn" data-latex="\mathbb{N}" title="自然数">$\mathbb{N}$</button>
                    <button class="latex-btn" data-latex="\mathbb{Z}" title="整数">$\mathbb{Z}$</button>
                    <button class="latex-btn" data-latex="\mathbb{Q}" title="有理数">$\mathbb{Q}$</button>
                    <button class="latex-btn" data-latex="\mathbb{R}" title="実数">$\mathbb{R}$</button>
                    <button class="latex-btn" data-latex="\mathbb{C}" title="複素数">$\mathbb{C}$</button>
                    <button class="latex-btn" data-latex="\mathbb{F}" title="体">$\mathbb{F}$</button>
                    <button class="latex-btn" data-latex="\mathbb{H}" title="四元数">$\mathbb{H}$</button>
                    <button class="latex-btn" data-latex="\mathbb{Z}_n" title="整数剰余類">$\mathbb{Z}_n$</button>
                </div>

                <!-- 構造ツールバー -->
                <div class="latex-toolbar" id="structuresToolbar" style="display: none;">
                    <!-- 基本的な分数・べき乗 -->
                    <button class="latex-btn" data-latex="\frac{a}{b}" title="分数">$\frac{a}{b}$</button>
                    <button class="latex-btn" data-latex="\frac{a+b}{c+d}" title="複雑な分数">$\frac{a+b}{c+d}$</button>
                    <button class="latex-btn" data-latex="\frac{\partial f}{\partial x}" title="偏微分分数">$\frac{\partial f}{\partial x}$</button>
                    <button class="latex-btn" data-latex="x^{n}" title="べき乗">$x^{n}$</button>
                    <button class="latex-btn" data-latex="x_{i}" title="下付き">$x_{i}$</button>
                    <button class="latex-btn" data-latex="x_{i}^{n}" title="べき乗と下付き">$x_{i}^{n}$</button>
                    <button class="latex-btn" data-latex="a^{b+c}" title="複雑なべき乗">$a^{b+c}$</button>
                    <button class="latex-btn" data-latex="e^{x}" title="指数関数">$e^{x}$</button>
                    <button class="latex-btn" data-latex="a^{-1}" title="逆数">$a^{-1}$</button>

                    <!-- 平方根・n乗根 -->
                    <button class="latex-btn" data-latex="\sqrt{x}" title="平方根">$\sqrt{x}$</button>
                    <button class="latex-btn" data-latex="\sqrt[n]{x}" title="n乗根">$\sqrt[n]{x}$</button>
                    <button class="latex-btn" data-latex="\sqrt[3]{x}" title="立方根">$\sqrt[3]{x}$</button>
                    <button class="latex-btn" data-latex="\sqrt{x^{2}+y^{2}}" title="複雑な平方根">$\sqrt{x^{2}+y^{2}}$</button>
                    <button class="latex-btn" data-latex="\sqrt{\frac{a}{b}}" title="分数の平方根">$\sqrt{\frac{a}{b}}$</button>

                    <!-- 組み合わせ・二項係数 -->
                    <button class="latex-btn" data-latex="\binom{n}{k}" title="二項係数">$\binom{n}{k}$</button>
                    <button class="latex-btn" data-latex="\binom{n+1}{k-1}" title="複雑な二項係数">$\binom{n+1}{k-1}$</button>
                    <button class="latex-btn" data-latex="\left(\begin{matrix}n\\k\end{matrix}\right)" title="行列形式">$\left(\begin{matrix}n\\k\end{matrix}\right)$</button>

                    <!-- 行列 -->
                    <button class="latex-btn" data-latex="\begin{pmatrix} a & b \\ c & d \end{pmatrix}" title="行列">$\begin{pmatrix} a & b \\ c & d \end{pmatrix}$</button>
                    <button class="latex-btn" data-latex="\begin{bmatrix} a & b \\ c & d \end{bmatrix}" title="角括弧行列">$\begin{bmatrix} a & b \\ c & d \end{bmatrix}$</button>
                    <button class="latex-btn" data-latex="\begin{vmatrix} a & b \\ c & d \end{vmatrix}" title="行列式">$\begin{vmatrix} a & b \\ c & d \end{vmatrix}$</button>
                    <button class="latex-btn" data-latex="\begin{Vmatrix} a & b \\ c & d \end{Vmatrix}" title="ノルム行列">$\begin{Vmatrix} a & b \\ c & d \end{Vmatrix}$</button>
                    <button class="latex-btn" data-latex="\mathbf{A}" title="太字行列">$\mathbf{A}$</button>

                    <!-- ベクトル -->
                    <button class="latex-btn" data-latex="\vec{v}" title="ベクトル">$\vec{v}$</button>
                    <button class="latex-btn" data-latex="\overrightarrow{AB}" title="矢印ベクトル">$\overrightarrow{AB}$</button>
                    <button class="latex-btn" data-latex="\overline{v}" title="上線ベクトル">$\overline{v}$</button>
                    <button class="latex-btn" data-latex="\underline{v}" title="下線ベクトル">$\underline{v}$</button>
                    <button class="latex-btn" data-latex="\mathbf{v}" title="太字ベクトル">$\mathbf{v}$</button>
                    <button class="latex-btn" data-latex="\hat{v}" title="単位ベクトル">$\hat{v}$</button>

                    <!-- 絶対値・ノルム -->
                    <button class="latex-btn" data-latex="|x|" title="絶対値">$|x|$</button>
                    <button class="latex-btn" data-latex="\left| x \right|" title="絶対値（拡大）">$\left| x \right|$</button>
                    <button class="latex-btn" data-latex="\| x \|" title="ノルム">$\| x \|$</button>
                    <button class="latex-btn" data-latex="\left\| x \right\|" title="ノルム（拡大）">$\left\| x \right\|$</button>
                    <button class="latex-btn" data-latex="\langle x, y \rangle" title="内積">$\langle x, y \rangle$</button>

                    <!-- 集合 -->
                    <button class="latex-btn" data-latex="\{ a, b, c \}" title="集合">$\{ a, b, c \}$</button>
                    <button class="latex-btn" data-latex="\left\{ x \mid P(x) \right\}" title="条件付き集合">$\left\{ x \mid P(x) \right\}$</button>
                    <button class="latex-btn" data-latex="[a,b]" title="閉区間">$[a,b]$</button>
                    <button class="latex-btn" data-latex="(a,b)" title="開区間">$(a,b)$</button>
                    <button class="latex-btn" data-latex="[a,b)" title="半開区間">$[a,b)$</button>
                    <button class="latex-btn" data-latex="(a,b]" title="半開区間">$(a,b]$</button>

                    <!-- 関数 -->
                    <button class="latex-btn" data-latex="f(x)" title="関数">$f(x)$</button>
                    <button class="latex-btn" data-latex="f: X \to Y" title="写像">$f: X \to Y$</button>
                    <button class="latex-btn" data-latex="f \circ g" title="合成関数">$f \circ g$</button>
                    <button class="latex-btn" data-latex="f^{-1}(x)" title="逆関数">$f^{-1}(x)$</button>
                    <button class="latex-btn" data-latex="f'(x)" title="導関数">$f'(x)$</button>
                    <button class="latex-btn" data-latex="f''(x)" title="二階導関数">$f''(x)$</button>

                    <!-- 数列・級数 -->
                    <button class="latex-btn" data-latex="a_n" title="数列">$a_n$</button>
                    <button class="latex-btn" data-latex="\{a_n\}_{n=1}^{\infty}" title="無限数列">$\{a_n\}_{n=1}^{\infty}$</button>
                    <button class="latex-btn" data-latex="\sum_{n=1}^{\infty} a_n" title="無限級数">$\sum_{n=1}^{\infty} a_n$</button>
                    <button class="latex-btn" data-latex="\prod_{n=1}^{\infty} a_n" title="無限積">$\prod_{n=1}^{\infty} a_n$</button>

                    <!-- 極限 -->
                    <button class="latex-btn" data-latex="\lim_{x \to a} f(x)" title="極限">$\lim_{x \to a} f(x)$</button>
                    <button class="latex-btn" data-latex="\lim_{x \to a^{+}} f(x)" title="右極限">$\lim_{x \to a^{+}} f(x)$</button>
                    <button class="latex-btn" data-latex="\lim_{x \to a^{-}} f(x)" title="左極限">$\lim_{x \to a^{-}} f(x)$</button>
                    <button class="latex-btn" data-latex="\lim_{x \to \infty} f(x)" title="無限極限">$\lim_{x \to \infty} f(x)$</button>
                </div>

                <!-- 演算子ツールバー -->
                <div class="latex-toolbar" id="operatorsToolbar" style="display: none;">
                    <!-- 和と積 -->
                    <button class="latex-btn" data-latex="\sum_{i=1}^{n} a_i" title="和">$\sum_{i=1}^{n} a_i$</button>
                    <button class="latex-btn" data-latex="\sum_{i=1}^{\infty} a_i" title="無限和">$\sum_{i=1}^{\infty} a_i$</button>
                    <button class="latex-btn" data-latex="\prod_{i=1}^{n} a_i" title="積">$\prod_{i=1}^{n} a_i$</button>
                    <button class="latex-btn" data-latex="\prod_{i=1}^{\infty} a_i" title="無限積">$\prod_{i=1}^{\infty} a_i$</button>
                    <button class="latex-btn" data-latex="\bigcup_{i=1}^{n} A_i" title="集合の和">$\bigcup_{i=1}^{n} A_i$</button>
                    <button class="latex-btn" data-latex="\bigcap_{i=1}^{n} A_i" title="集合の積">$\bigcap_{i=1}^{n} A_i$</button>

                    <!-- 積分 -->
                    <button class="latex-btn" data-latex="\int f(x) dx" title="不定積分">$\int f(x) dx$</button>
                    <button class="latex-btn" data-latex="\int_{a}^{b} f(x) dx" title="定積分">$\int_{a}^{b} f(x) dx$</button>
                    <button class="latex-btn" data-latex="\int_{-\infty}^{\infty} f(x) dx" title="広義積分">$\int_{-\infty}^{\infty} f(x) dx$</button>
                    <button class="latex-btn" data-latex="\oint f(z) dz" title="線積分">$\oint f(z) dz$</button>
                    <button class="latex-btn" data-latex="\iint_D f(x,y) dx dy" title="二重積分">$\iint_D f(x,y) dx dy$</button>
                    <button class="latex-btn" data-latex="\iiint_V f(x,y,z) dx dy dz" title="三重積分">$\iiint_V f(x,y,z) dx dy dz$</button>

                    <!-- 微分 -->
                    <button class="latex-btn" data-latex="\frac{d}{dx} f(x)" title="微分">$\frac{d}{dx} f(x)$</button>
                    <button class="latex-btn" data-latex="\frac{\partial f}{\partial x}" title="偏微分">$\frac{\partial f}{\partial x}$</button>
                    <button class="latex-btn" data-latex="\frac{\partial^2 f}{\partial x^2}" title="二階偏微分">$\frac{\partial^2 f}{\partial x^2}$</button>
                    <button class="latex-btn" data-latex="\nabla f" title="勾配">$\nabla f$</button>
                    <button class="latex-btn" data-latex="\Delta f" title="ラプラシアン">$\Delta f$</button>
                    <button class="latex-btn" data-latex="\dot{x}" title="時間微分">$\dot{x}$</button>
                    <button class="latex-btn" data-latex="\ddot{x}" title="二階時間微分">$\ddot{x}$</button>

                    <!-- 三角関数 -->
                    <button class="latex-btn" data-latex="\sin x" title="正弦">$\sin x$</button>
                    <button class="latex-btn" data-latex="\cos x" title="余弦">$\cos x$</button>
                    <button class="latex-btn" data-latex="\tan x" title="正接">$\tan x$</button>
                    <button class="latex-btn" data-latex="\cot x" title="余接">$\cot x$</button>
                    <button class="latex-btn" data-latex="\sec x" title="正割">$\sec x$</button>
                    <button class="latex-btn" data-latex="\csc x" title="余割">$\csc x$</button>

                    <!-- 逆三角関数 -->
                    <button class="latex-btn" data-latex="\arcsin x" title="逆正弦">$\arcsin x$</button>
                    <button class="latex-btn" data-latex="\arccos x" title="逆余弦">$\arccos x$</button>
                    <button class="latex-btn" data-latex="\arctan x" title="逆正接">$\arctan x$</button>
                    <button class="latex-btn" data-latex="\arccot x" title="逆余接">$\arccot x$</button>
                    <button class="latex-btn" data-latex="\arcsec x" title="逆正割">$\arcsec x$</button>
                    <button class="latex-btn" data-latex="\arccsc x" title="逆余割">$\arccsc x$</button>

                    <!-- 双曲線関数 -->
                    <button class="latex-btn" data-latex="\sinh x" title="双曲線正弦">$\sinh x$</button>
                    <button class="latex-btn" data-latex="\cosh x" title="双曲線余弦">$\cosh x$</button>
                    <button class="latex-btn" data-latex="\tanh x" title="双曲線正接">$\tanh x$</button>
                    <button class="latex-btn" data-latex="\coth x" title="双曲線余接">$\coth x$</button>
                    <button class="latex-btn" data-latex="\sech x" title="双曲線正割">$\sech x$</button>
                    <button class="latex-btn" data-latex="\csch x" title="双曲線余割">$\csch x$</button>

                    <!-- 指数・対数 -->
                    <button class="latex-btn" data-latex="e^{x}" title="指数関数">$e^{x}$</button>
                    <button class="latex-btn" data-latex="a^{x}" title="一般指数">$a^{x}$</button>
                    <button class="latex-btn" data-latex="\log x" title="自然対数">$\log x$</button>
                    <button class="latex-btn" data-latex="\ln x" title="自然対数">$\ln x$</button>
                    <button class="latex-btn" data-latex="\log_a x" title="一般対数">$\log_a x$</button>
                    <button class="latex-btn" data-latex="\log_{10} x" title="常用対数">$\log_{10} x$</button>

                    <!-- 極限 -->
                    <button class="latex-btn" data-latex="\lim_{x \to a} f(x)" title="極限">$\lim_{x \to a} f(x)$</button>
                    <button class="latex-btn" data-latex="\lim_{x \to \infty} f(x)" title="無限極限">$\lim_{x \to \infty} f(x)$</button>
                    <button class="latex-btn" data-latex="\lim_{x \to 0} f(x)" title="原点極限">$\lim_{x \to 0} f(x)$</button>
                    <button class="latex-btn" data-latex="\lim_{n \to \infty} a_n" title="数列の極限">$\lim_{n \to \infty} a_n$</button>
                    <button class="latex-btn" data-latex="\limsup_{n \to \infty} a_n" title="上極限">$\limsup_{n \to \infty} a_n$</button>
                    <button class="latex-btn" data-latex="\liminf_{n \to \infty} a_n" title="下極限">$\liminf_{n \to \infty} a_n$</button>

                    <!-- 期待値・確率 -->
                    <button class="latex-btn" data-latex="\mathbb{E}[X]" title="期待値">$\mathbb{E}[X]$</button>
                    <button class="latex-btn" data-latex="\text{Var}(X)" title="分散">$\text{Var}(X)$</button>
                    <button class="latex-btn" data-latex="\text{Cov}(X,Y)" title="共分散">$\text{Cov}(X,Y)$</button>
                    <button class="latex-btn" data-latex="\Pr(A)" title="確率">$\Pr(A)$</button>
                    <button class="latex-btn" data-latex="P(A|B)" title="条件付き確率">$P(A|B)$</button>

                    <!-- その他の演算子 -->
                    <button class="latex-btn" data-latex="\max\{x_1, \ldots, x_n\}" title="最大値">$\max\{x_1, \ldots, x_n\}$</button>
                    <button class="latex-btn" data-latex="\min\{x_1, \ldots, x_n\}" title="最小値">$\min\{x_1, \ldots, x_n\}$</button>
                    <button class="latex-btn" data-latex="\sup S" title="上限">$\sup S$</button>
                    <button class="latex-btn" data-latex="\inf S" title="下限">$\inf S$</button>
                    <button class="latex-btn" data-latex="\det A" title="行列式">$\det A$</button>
                    <button class="latex-btn" data-latex="\text{tr}(A)" title="トレース">$\text{tr}(A)$</button>
                    <button class="latex-btn" data-latex="\text{rank}(A)" title="ランク">$\text{rank}(A)$</button>
                </div>

                <!-- 関係記号ツールバー -->
                <div class="latex-toolbar" id="relationsToolbar" style="display: none;">
                    <!-- 基本関係 -->
                    <button class="latex-btn" data-latex="=" title="イコール">$=$</button>
                    <button class="latex-btn" data-latex="\neq" title="不等号">$\neq$</button>
                    <button class="latex-btn" data-latex="\lt" title="小なり">$\lt$</button>
                    <button class="latex-btn" data-latex="\gt" title="大なり">$\gt$</button>
                    <button class="latex-btn" data-latex="\leq" title="小なりイコール">$\leq$</button>
                    <button class="latex-btn" data-latex="\geq" title="大なりイコール">$\geq$</button>
                    <button class="latex-btn" data-latex="\ll" title="はるかに小なり">$\ll$</button>
                    <button class="latex-btn" data-latex="\gg" title="はるかに大なり">$\gg$</button>

                    <!-- 集合関係 -->
                    <button class="latex-btn" data-latex="\in" title="属する">$\in$</button>
                    <button class="latex-btn" data-latex="\notin" title="属さない">$\notin$</button>
                    <button class="latex-btn" data-latex="\subset" title="部分集合">$\subset$</button>
                    <button class="latex-btn" data-latex="\supset" title="上位集合">$\supset$</button>
                    <button class="latex-btn" data-latex="\subseteq" title="部分集合（等号含む）">$\subseteq$</button>
                    <button class="latex-btn" data-latex="\supseteq" title="上位集合（等号含む）">$\supseteq$</button>
                    <button class="latex-btn" data-latex="\subsetneq" title="真部分集合">$\subsetneq$</button>
                    <button class="latex-btn" data-latex="\supsetneq" title="真上位集合">$\supsetneq$</button>
                    <button class="latex-btn" data-latex="\cup" title="和集合">$\cup$</button>
                    <button class="latex-btn" data-latex="\cap" title="積集合">$\cap$</button>
                    <button class="latex-btn" data-latex="\setminus" title="差集合">$\setminus$</button>
                    <button class="latex-btn" data-latex="\emptyset" title="空集合">$\emptyset$</button>

                    <!-- 同値・同型 -->
                    <button class="latex-btn" data-latex="\equiv" title="合同">$\equiv$</button>
                    <button class="latex-btn" data-latex="\cong" title="同型">$\cong$</button>
                    <button class="latex-btn" data-latex="\sim" title="相似">$\sim$</button>
                    <button class="latex-btn" data-latex="\simeq" title="概ね等しい">$\simeq$</button>
                    <button class="latex-btn" data-latex="\approx" title="近似的に等しい">$\approx$</button>
                    <button class="latex-btn" data-latex="\propto" title="比例する">$\propto$</button>

                    <!-- 論理関係 -->
                    <button class="latex-btn" data-latex="\implies" title="ならば">$\implies$</button>
                    <button class="latex-btn" data-latex="\impliedby" title="ならば（逆）">$\impliedby$</button>
                    <button class="latex-btn" data-latex="\iff" title="同値">$\iff$</button>
                    <button class="latex-btn" data-latex="\therefore" title="ゆえに">$\therefore$</button>
                    <button class="latex-btn" data-latex="\because" title="なぜなら">$\because$</button>
                    <button class="latex-btn" data-latex="\forall" title="すべての">$\forall$</button>
                    <button class="latex-btn" data-latex="\exists" title="存在する">$\exists$</button>
                    <button class="latex-btn" data-latex="\nexists" title="存在しない">$\nexists$</button>

                    <!-- 漸近関係 -->
                    <button class="latex-btn" data-latex="f \circ g" title="関数合成">$f \circ g$</button>
                    <button class="latex-btn" data-latex="\to" title="写像">$\to$</button>
                    <button class="latex-btn" data-latex="\mapsto" title="対応">$\mapsto$</button>
                    <button class="latex-btn" data-latex="\rightarrow" title="右矢印">$\rightarrow$</button>
                    <button class="latex-btn" data-latex="\leftarrow" title="左矢印">$\leftarrow$</button>
                    <button class="latex-btn" data-latex="\leftrightarrow" title="両方向矢印">$\leftrightarrow$</button>

                    <!-- 平行・垂直 -->
                    <button class="latex-btn" data-latex="\parallel" title="平行">$\parallel$</button>
                    <button class="latex-btn" data-latex="\perp" title="垂直">$\perp$</button>
                    <button class="latex-btn" data-latex="\angle" title="角">$\angle$</button>
                    <button class="latex-btn" data-latex="\triangle" title="三角形">$\triangle$</button>
                    <button class="latex-btn" data-latex="\square" title="四角形">$\square$</button>

                    <!-- 発散・収束 -->
                    <button class="latex-btn" data-latex="\to" title="収束">$\to$</button>
                    <button class="latex-btn" data-latex="\longrightarrow" title="収束（長い矢印）">$\longrightarrow$</button>
                    <button class="latex-btn" data-latex="\uparrow" title="上に発散">$\uparrow$</button>
                    <button class="latex-btn" data-latex="\downarrow" title="下に発散">$\downarrow$</button>
                    <button class="latex-btn" data-latex="\updownarrow" title="振動">$\updownarrow$</button>
                </div>

                <!-- 入力エリア -->
                <div class="input-section">
                    <div class="section-header">
                        <div><span class="material-symbols-outlined">edit</span> 数式入力</div>
                        <button id="clearButton" class="clear-button" title="数式をクリア">
                            <span class="material-symbols-outlined">clear</span>
                        </button>
                    </div>
                    <textarea
                        id="mathInput"
                        class="input-textarea"
                        placeholder="LaTeX形式で数式を入力してください
※ &lt; は \lt、&gt; は \gt を使用してください

例:
x^2 + 2x + 1 = 0
\frac{a + b}{2}
\sqrt{x^2 + y^2}
\int_0^1 x dx = \frac{1}{2}
x \lt 5, y \gt 3"></textarea>
                </div>
            </div>

            <!-- プレビューペイン -->
            <div class="preview-pane">
                <div class="preview-section">
                    <div class="section-header"><span class="material-symbols-outlined">visibility</span> リアルタイムプレビュー</div>
                    
                    <!-- 正規化出力 -->
                    <!-- レンダリング結果 -->
                    <div class="preview-container">
                        <div id="mathPreview" class="preview-content">
                            <div class="preview-placeholder">
                                数式を入力すると、ここにKaTeXでレンダリングされた結果が表示されます
                            </div>
                        </div>
                    </div>

                    </div>

                <!-- 保存エリア -->
                <div class="save-section">
                    <div class="form-group">
                        <label for="questionTitle">問題タイトル</label>
                        <input type="text" id="questionTitle" placeholder="問題のタイトル">
                    </div>
                    <div class="form-group">
                        <label for="fieldCode">分類</label>
                        <select id="fieldCode">
                            <option value="">選択してください</option>
                            <option value="symbols">文字</option>
                            <option value="structures">構造</option>
                            <option value="operators">演算子</option>
                            <option value="relations">関係記号</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="questionDifficulty">難易度</label>
                        <select id="questionDifficulty" class="form-select">
                            <option value="">選択してください</option>
                            <option value="1">☆</option>
                            <option value="2">☆☆</option>
                            <option value="3">☆☆☆</option>
                            <option value="4">☆☆☆☆</option>
                            <option value="5">☆☆☆☆☆</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="questionTags">タグ</label>
                        <div class="tag-input-wrapper">
                            <div class="tag-input-group">
                                <input
                                    type="text"
                                    id="tagInput"
                                    class="form-control tag-input-field"
                                    placeholder="#東大 #数学 #微積分"
                                    autocomplete="off"
                                    enterkeyhint="done"
                                    inputmode="text"
                                    autocorrect="off"
                                    autocapitalize="off"
                                >
                                <button type="button" id="tagAddButton" class="tag-add-button">
                                    追加
                                </button>
                            </div>
                            <div class="tag-display-container" id="tagDisplay" style="display: none;"></div>
                            <div class="tag-suggestions" id="tagSuggestions" style="display: none;"></div>
                        </div>
                        <small class="text-muted">+ボタンまたはスペースでタグを追加（最大100個まで）</small>
                    </div>
                    <button class="save-button" id="saveButton"><span class="material-symbols-outlined">save</span> 問題を保存</button>
                    <div id="saveMessage"></div>
                </div>
            </div>

            <!-- ツールペイン -->
            <div class="tools-pane">
                <div class="tools-section">
                    <div class="section-header"><span class="material-symbols-outlined">build</span> クイックツール</div>

                    <!-- 分野選択タブ -->
                    <div class="field-tabs">
                        <button class="field-tab active" data-field="algebra">代数学</button>
                        <button class="field-tab" data-field="analysis">解析学</button>
                        <button class="field-tab" data-field="geometry">幾何学</button>
                        <button class="field-tab" data-field="probability">確率統計</button>
                        <button class="field-tab" data-field="discrete">離散数学</button>
                    </div>

                    <!-- 代数学 -->
                    <div class="field-content" id="algebra-content">
                        <div class="subsection-header">基礎代数</div>
                        <div class="sample-chips">
                            <div class="sample-chip" data-sample="x^2 + 2x + 1 = 0">二次方程式</div>
                            <div class="sample-chip" data-sample="ax^2 + bx + c = 0">一般二次方程式</div>
                            <div class="sample-chip" data-sample="x = \frac{-b \pm \sqrt{b^2 - 4ac}}{2a}">解の公式</div>
                            <div class="sample-chip" data-sample="(a+b)^2 = a^2 + 2ab + b^2">展開公式</div>
                            <div class="sample-chip" data-sample="a^2 - b^2 = (a-b)(a+b)">因数分解</div>
                        </div>

                        <div class="subsection-header">線形代数</div>
                        <div class="sample-chips">
                            <div class="sample-chip" data-sample="\begin{pmatrix} a & b \\ c & d \end{pmatrix}">2x2行列</div>
                            <div class="sample-chip" data-sample="\det(A) = ad - bc">行列式</div>
                            <div class="sample-chip" data-sample="A\vec{x} = \lambda\vec{x}">固有値問題</div>
                            <div class="sample-chip" data-sample="\vec{v} \cdot \vec{w}">内積</div>
                            <div class="sample-chip" data-sample="||\vec{v}|| = \sqrt{\vec{v} \cdot \vec{v}}">ノルム</div>
                        </div>

                        <div class="subsection-header">抽象代数</div>
                        <div class="sample-chips">
                            <div class="sample-chip" data-sample="a \cdot b = b \cdot a">交換法則</div>
                            <div class="sample-chip" data-sample="(a \cdot b) \cdot c = a \cdot (b \cdot c)">結合法則</div>
                            <div class="sample-chip" data-sample="a \cdot (b + c) = a \cdot b + a \cdot c">分配法則</div>
                            <div class="sample-chip" data-sample="a + (-a) = 0">逆元</div>
                        </div>
                    </div>

                    <!-- 解析学 -->
                    <div class="field-content" id="analysis-content" style="display: none;">
                        <div class="subsection-header">微分積分学</div>
                        <div class="sample-chips">
                            <div class="sample-chip" data-sample="\frac{d}{dx}(x^n) = nx^{n-1}">べき乗の微分</div>
                            <div class="sample-chip" data-sample="\frac{d}{dx}(\sin x) = \cos x">三角関数の微分</div>
                            <div class="sample-chip" data-sample="\frac{d}{dx}(e^x) = e^x">指数関数の微分</div>
                            <div class="sample-chip" data-sample="\int x^n dx = \frac{x^{n+1}}{n+1} + C">べき乗の積分</div>
                            <div class="sample-chip" data-sample="\int_0^1 x dx = \frac{1}{2}">定積分</div>
                        </div>

                        <div class="subsection-header">極限と連続</div>
                        <div class="sample-chips">
                            <div class="sample-chip" data-sample="\lim_{x \to 0} \frac{\sin x}{x} = 1">重要極限</div>
                            <div class="sample-chip" data-sample="\lim_{x \to \infty} (1 + \frac{1}{x})^x = e">ネイピア数</div>
                            <div class="sample-chip" data-sample="\lim_{x \to a} f(x) = L">極限の定義</div>
                            <div class="sample-chip" data-sample="\lim_{x \to a^+} f(x) = \lim_{x \to a^-} f(x)">連続性</div>
                        </div>

                        <div class="subsection-header">級数展開</div>
                        <div class="sample-chips">
                            <div class="sample-chip" data-sample="e^x = \sum_{n=0}^{\infty} \frac{x^n}{n!}">テイラー展開</div>
                            <div class="sample-chip" data-sample="\sin x = x - \frac{x^3}{3!} + \frac{x^5}{5!} - \cdots">正弦関数展開</div>
                            <div class="sample-chip" data-sample="\cos x = 1 - \frac{x^2}{2!} + \frac{x^4}{4!} - \cdots">余弦関数展開</div>
                            <div class="sample-chip" data-sample="\sum_{n=1}^{\infty} \frac{1}{n^2} = \frac{\pi^2}{6}">バーゼル問題</div>
                        </div>
                    </div>

                    <!-- 幾何学 -->
                    <div class="field-content" id="geometry-content" style="display: none;">
                        <div class="subsection-header">平面幾何</div>
                        <div class="sample-chips">
                            <div class="sample-chip" data-sample="A = \pi r^2">円の面積</div>
                            <div class="sample-chip" data-sample="C = 2\pi r">円周</div>
                            <div class="sample-chip" data-sample="A = \frac{1}{2}bh">三角形の面積</div>
                            <div class="sample-chip" data-sample="a^2 + b^2 = c^2">ピタゴラスの定理</div>
                            <div class="sample-chip" data-sample="V = \frac{4}{3}\pi r^3">球の体積</div>
                        </div>

                        <div class="subsection-header">解析幾何</div>
                        <div class="sample-chips">
                            <div class="sample-chip" data-sample="d = \sqrt{(x_2-x_1)^2 + (y_2-y_1)^2}">距離公式</div>
                            <div class="sample-chip" data-sample="(x-h)^2 + (y-k)^2 = r^2">円の方程式</div>
                            <div class="sample-chip" data-sample="y = mx + b">直線の方程式</div>
                            <div class="sample-chip" data-sample="\frac{x^2}{a^2} + \frac{y^2}{b^2} = 1">楕円</div>
                        </div>

                        <div class="subsection-header">三角関数</div>
                        <div class="sample-chips">
                            <div class="sample-chip" data-sample="\sin^2\theta + \cos^2\theta = 1">基本恒等式</div>
                            <div class="sample-chip" data-sample="\sin(A+B) = \sin A \cos B + \cos A \sin B">加法定理</div>
                            <div class="sample-chip" data-sample="\cos(2\theta) = \cos^2\theta - \sin^2\theta">倍角公式</div>
                            <div class="sample-chip" data-sample="\tan\theta = \frac{\sin\theta}{\cos\theta}">正接の定義</div>
                        </div>
                    </div>

                    <!-- 確率統計 -->
                    <div class="field-content" id="probability-content" style="display: none;">
                        <div class="subsection-header">確率論</div>
                        <div class="sample-chips">
                            <div class="sample-chip" data-sample="P(A \cup B) = P(A) + P(B) - P(A \cap B)">加法定理</div>
                            <div class="sample-chip" data-sample="P(A|B) = \frac{P(A \cap B)}{P(B)}">条件付き確率</div>
                            <div class="sample-chip" data-sample="P(A \cap B) = P(A)P(B|A)">乗法定理</div>
                            <div class="sample-chip" data-sample="E[X] = \sum x P(X=x)">期待値</div>
                        </div>

                        <div class="subsection-header">確率分布</div>
                        <div class="sample-chips">
                            <div class="sample-chip" data-sample="f(x) = \frac{1}{\sqrt{2\pi}\sigma} e^{-\frac{(x-\mu)^2}{2\sigma^2}}">正規分布</div>
                            <div class="sample-chip" data-sample="P(X=k) = \binom{n}{k}p^k(1-p)^{n-k}">二項分布</div>
                            <div class="sample-chip" data-sample="P(X=k) = \frac{\lambda^k e^{-\lambda}}{k!}">ポアソン分布</div>
                            <div class="sample-chip" data-sample="f(x) = \lambda e^{-\lambda x}">指数分布</div>
                        </div>

                        <div class="subsection-header">統計量</div>
                        <div class="sample-chips">
                            <div class="sample-chip" data-sample="\bar{x} = \frac{1}{n}\sum_{i=1}^{n} x_i">標本平均</div>
                            <div class="sample-chip" data-sample="s^2 = \frac{1}{n-1}\sum_{i=1}^{n}(x_i - \bar{x})^2">標本分散</div>
                            <div class="sample-chip" data-sample="\sigma = \sqrt{E[(X-\mu)^2]}">標準偏差</div>
                            <div class="sample-chip" data-sample="Z = \frac{X - \mu}{\sigma}">標準化</div>
                        </div>
                    </div>

                    <!-- 離散数学 -->
                    <div class="field-content" id="discrete-content" style="display: none;">
                        <div class="subsection-header">数列と漸化式</div>
                        <div class="sample-chips">
                            <div class="sample-chip" data-sample="a_n = a_1 + (n-1)d">等差数列</div>
                            <div class="sample-chip" data-sample="S_n = \frac{n(a_1 + a_n)}{2}">等差数列の和</div>
                            <div class="sample-chip" data-sample="a_n = a_1 r^{n-1}">等比数列</div>
                            <div class="sample-chip" data-sample="a_{n} = a_{n-1} + a_{n-2}">フィボナッチ数列</div>
                        </div>

                        <div class="subsection-header">集合論</div>
                        <div class="sample-chips">
                            <div class="sample-chip" data-sample="A \cup B = \{x | x \in A \lor x \in B\}">和集合</div>
                            <div class="sample-chip" data-sample="A \cap B = \{x | x \in A \land x \in B\}">積集合</div>
                            <div class="sample-chip" data-sample="A \setminus B = \{x | x \in A \land x \notin B\}">差集合</div>
                            <div class="sample-chip" data-sample="A^c = \{x | x \notin A\}">補集合</div>
                        </div>

                        <div class="subsection-header">組み合わせ論</div>
                        <div class="sample-chips">
                            <div class="sample-chip" data-sample="\binom{n}{k} = \frac{n!}{k!(n-k)!}">組み合わせ</div>
                            <div class="sample-chip" data-sample="P(n,k) = \frac{n!}{(n-k)!}">順列</div>
                            <div class="sample-chip" data-sample="2^n">部分集合の数</div>
                            <div class="sample-chip" data-sample="\sum_{k=0}^{n} \binom{n}{k} = 2^n">二項定理</div>
                        </div>

                        <div class="subsection-header">論理学</div>
                        <div class="sample-chips">
                            <div class="sample-chip" data-sample="P \Rightarrow Q">含意</div>
                            <div class="sample-chip" data-sample="P \Leftrightarrow Q">同値</div>
                            <div class="sample-chip" data-sample="\forall x \in \mathbb{R}">全称量化</div>
                            <div class="sample-chip" data-sample="\exists x \in \mathbb{N}">存在量化</div>
                        </div>
                    </div>

                            </div>
            </div>
                </div>
            </div>
        </div>
    </div>

    <!-- KaTeX JavaScript -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js" integrity="sha384-cpW21h6RZv/phavutF+AuVYrr+dA8xD9zs6FwLpaCct6O9ctzYFfFr4dgmgccOTx" crossorigin="anonymous"></script>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    
    <script>
        // 認証チェック - シンプル化
        function checkAuth() {
            // 現在は認証なしで動作
            console.log('System initialized without authentication');
        }

        // 認証UI更新
        function updateAuthUI() {
            const authStatus = document.getElementById('authStatus');
            const authButton = document.getElementById('authButton');
            const authWarning = document.getElementById('authWarning');
            const editorCard = document.getElementById('editorCard');
            const saveButton = document.getElementById('saveButton');

            if (currentUser) {
                // ログイン済み
                authStatus.className = 'auth-status logged-in';
                authStatus.innerHTML = `
                    <i class="fas fa-user-check me-1"></i>
                    <span>${currentUser.name || currentUser.email}</span>
                `;
                authButton.innerHTML = '<i class="fas fa-sign-out-alt me-1"></i>ログアウト';
                authWarning.style.display = 'none';
                editorCard.style.display = 'block';
                if (saveButton) saveButton.disabled = false;
            } else {
                // 未ログイン
                authStatus.className = 'auth-status logged-out';
                authStatus.innerHTML = `
                    <i class="fas fa-user-times me-1"></i>
                    <span>未ログイン</span>
                `;
                authButton.innerHTML = '<i class="fas fa-sign-in-alt me-1"></i>ログイン';
                authWarning.style.display = 'block';
                editorCard.style.display = 'none';
                if (saveButton) saveButton.disabled = true;
            }
        }

        // 認証処理
        async function handleAuth() {
            if (currentUser) {
                // ログアウト
                try {
                    await authClient.signOut();
                    currentUser = null;
                    updateAuthUI();
                } catch (error) {
                    console.error('Logout failed:', error);
                }
            } else {
                // ログインページへリダイレクト
                window.location.href = 'auth.html';
            }
        }

          // 革命的KaTeX統合数学作成システム - input-demo.html inspired
        class RevolutionaryKaTeXSystem {
            constructor() {
                this.textarea = document.getElementById('mathInput');
                this.preview = document.getElementById('mathPreview');
                        this.isScrolling = false;
                this.scrollTimeout = null;
                this.currentMode = 'symbols';

                // タグ関連の初期化
                this.tagInput = document.getElementById('tagInput');
                this.tagDisplay = document.getElementById('tagDisplay');
                this.tagSuggestions = document.getElementById('tagSuggestions');
                this.tagAddButton = document.getElementById('tagAddButton');
                this.tags = [];

                this.init();
            }

            init() {
                console.log('RevolutionaryKaTeXSystem initializing...');

                // 要素の存在確認
                this.textarea = document.getElementById('mathInput');
                this.preview = document.getElementById('mathPreview');
        
                console.log('Elements found:', {
                    textarea: !!this.textarea,
                    preview: !!this.preview,
                    normalizedOutput: !!this.normalizedOutput,
                    statusArea: !!this.statusArea,
                    tagInput: !!this.tagInput,
                    tagDisplay: !!this.tagDisplay,
                    tagSuggestions: !!this.tagSuggestions,
                    tagAddButton: !!this.tagAddButton
                });

                this.setupLatexButtons();
                this.setupModeSelector();
                this.setupSampleChips();
                this.setupFieldTabs();
                this.setupRealtimePreview();
                this.setupSaveSystem();
                this.setupScrollDetection();
                this.setupTagSystem(); // タグシステムを追加
                this.setupClearButton(); // クリアボタンを追加
                this.waitForKaTeX();
            }

            // KaTeX読み込み待機
            waitForKaTeX() {
                const checkKaTeX = () => {
                    if (window.katex && typeof window.katex.renderToString === 'function') {
                        this.renderInitialMath();
                        this.updatePreview(); // 初期プレビューを更新
                    } else {
                        setTimeout(checkKaTeX, 100);
                    }
                };
                checkKaTeX();
            }

            // 超シンプル・確実なLaTeXボタンシステム
            setupLatexButtons() {
                document.querySelectorAll('.latex-btn').forEach(btn => {
                    let touchStartTime = 0;
                    let touchStartY = 0;

                    btn.addEventListener('touchstart', (e) => {
                        const touch = e.touches[0];
                        touchStartTime = Date.now();
                        touchStartY = touch.clientY;
                        btn.dataset.wasTapped = 'true';
                    }, { passive: true });

                    btn.addEventListener('touchend', (e) => {
                        const touch = e.changedTouches[0];
                        const touchEndTime = Date.now();
                        const touchDuration = touchEndTime - touchStartTime;
                        const touchDistance = Math.abs(touch.clientY - touchStartY);

                        // 短時間（300ms未満）かつ短距離（20px未満）のタッチのみ有効
                        if (touchDuration < 300 && touchDistance < 20 && !this.isScrolling) {
                            e.preventDefault();
                            this.insertLatex(btn.dataset.latex);
                            this.showButtonFeedback(btn);
                        } else {
                            e.preventDefault();
                            e.stopPropagation();
                        }
                    }, { passive: false });

                    btn.addEventListener('click', (e) => {
                        // スクロール中はタップを無効化
                        if (this.isScrolling) {
                            e.preventDefault();
                            e.stopPropagation();
                            return;
                        }

                        e.preventDefault();
                        this.insertLatex(btn.dataset.latex);
                        this.showButtonFeedback(btn);
                    });
                });
            }

            // モード選択システム
            setupModeSelector() {
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.currentMode = btn.dataset.mode;
                        this.updateToolbarForMode(this.currentMode);
                        // this.addStatus(`モード変更: ${btn.textContent}`, 'success');
                    });
                });

                // 初期モードでツールバーを更新
                this.updateToolbarForMode(this.currentMode);
            }

            // モードに応じてツールバー表示を更新
            updateToolbarForMode(mode) {
                // すべてのツールバーを非表示
                document.getElementById('symbolsToolbar').style.display = 'none';
                document.getElementById('structuresToolbar').style.display = 'none';
                document.getElementById('operatorsToolbar').style.display = 'none';
                document.getElementById('relationsToolbar').style.display = 'none';

                // 現在のモードに対応するツールバーを表示
                switch(mode) {
                    case 'symbols':
                        document.getElementById('symbolsToolbar').style.display = 'grid';
                        break;
                    case 'structures':
                        document.getElementById('structuresToolbar').style.display = 'grid';
                        break;
                    case 'operators':
                        document.getElementById('operatorsToolbar').style.display = 'grid';
                        break;
                    case 'relations':
                        document.getElementById('relationsToolbar').style.display = 'grid';
                        break;
                }
            }

            
            // サンプル数式チップ
            setupSampleChips() {
                document.querySelectorAll('.sample-chip').forEach(chip => {
                    let touchStartTime = 0;
                    let touchStartY = 0;

                    chip.addEventListener('touchstart', (e) => {
                        const touch = e.touches[0];
                        touchStartTime = Date.now();
                        touchStartY = touch.clientY;
                        chip.dataset.wasTapped = 'true';
                    }, { passive: true });

                    chip.addEventListener('touchend', (e) => {
                        const touch = e.changedTouches[0];
                        const touchEndTime = Date.now();
                        const touchDuration = touchEndTime - touchStartTime;
                        const touchDistance = Math.abs(touch.clientY - touchStartY);

                        // 短時間（300ms未満）かつ短距離（20px未満）のタッチのみ有効
                        if (touchDuration < 300 && touchDistance < 20 && !this.isScrolling) {
                            e.preventDefault();
                            e.stopPropagation();

                            const sample = chip.dataset.sample;
                            const currentValue = this.textarea.value;

                            // 現在の内容をクリアせずに追加
                            if (currentValue.trim()) {
                                // 既に内容がある場合は改行して追加
                                this.textarea.value = currentValue + '\n' + sample;
                            } else {
                                // 空の場合はそのまま追加
                                this.textarea.value = sample;
                            }

                            this.textarea.focus();
                            this.updatePreview();
                            // this.addStatus(`サンプル挿入: ${chip.textContent}`, 'success');
                        } else {
                            e.preventDefault();
                            e.stopPropagation();
                        }
                    }, { passive: false });

                    chip.addEventListener('click', (e) => {
                        // スクロール中はタップを無効化
                        if (this.isScrolling) {
                            e.preventDefault();
                            e.stopPropagation();
                            return;
                        }

                        const sample = chip.dataset.sample;
                        const currentValue = this.textarea.value;

                        // 現在の内容をクリアせずに追加
                        if (currentValue.trim()) {
                            // 既に内容がある場合は改行して追加
                            this.textarea.value = currentValue + '\n' + sample;
                        } else {
                            // 空の場合はそのまま追加
                            this.textarea.value = sample;
                        }

                        this.textarea.focus();
                        this.updatePreview();
                        // this.addStatus(`サンプル挿入: ${chip.textContent}`, 'success');
                    });
                });
            }

            // 即座のボタンフィードバック
            showButtonFeedback(btn) {
                btn.classList.add('flash');
                setTimeout(() => {
                    btn.classList.remove('flash');
                }, 200);
                
                if (navigator.vibrate) {
                    navigator.vibrate(15);
                }
            }

            // 確実なLaTeX挿入
            insertLatex(latex) {
                if (!this.textarea) return;
                
                const start = this.textarea.selectionStart;
                const end = this.textarea.selectionEnd;
                const text = this.textarea.value;
                const selectedText = text.substring(start, end);
                
                let insertion;
                if (latex.includes('{}')) {
                    insertion = selectedText ? 
                        latex.replace('{}', selectedText) : 
                        latex.replace('{}', '');
                } else {
                    insertion = latex + ' ';
                }
                
                this.textarea.value = text.substring(0, start) + insertion + text.substring(end);
                
                const newPos = start + insertion.length;
                this.textarea.focus();
                this.textarea.setSelectionRange(newPos, newPos);
                
                this.updatePreview();
            }

            // 分野タブシステム
            setupFieldTabs() {
                document.querySelectorAll('.field-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        // すべてのタブからactiveクラスを削除
                        document.querySelectorAll('.field-tab').forEach(t => t.classList.remove('active'));
                        // クリックされたタブにactiveクラスを追加
                        tab.classList.add('active');

                        // すべてのコンテンツを非表示
                        document.querySelectorAll('.field-content').forEach(content => {
                            content.style.display = 'none';
                        });

                        // 対応するコンテンツを表示
                        const field = tab.dataset.field;
                        const content = document.getElementById(field + '-content');
                        if (content) {
                            content.style.display = 'block';
                        }
                    });
                });
            }

            // リアルタイムプレビューシステム
            setupRealtimePreview() {
                if (!this.textarea) {
                    console.error('Textarea element not found for preview setup');
                    return;
                }

                console.log('Setting up realtime preview...');

                this.textarea.addEventListener('input', () => {
                    console.log('Input event triggered, updating preview...');
                    this.updatePreview();
                });

                this.textarea.addEventListener('keyup', () => {
                    this.updatePreview();
                });

                this.textarea.addEventListener('paste', () => {
                    setTimeout(() => this.updatePreview(), 10);
                });

                this.updatePreview();
            }

            updatePreview() {
                console.log('updatePreview called');

                if (!this.preview || !this.textarea) {
                    console.error('Preview or textarea element missing', {
                        preview: !!this.preview,
                        textarea: !!this.textarea
                    });
                    return;
                }

                const text = this.textarea.value.trim();
                console.log('Text to render:', text);

                if (!text) {
                    this.preview.innerHTML = '<div class="preview-placeholder">数式を入力すると、ここにKaTeXでレンダリングされた結果が表示されます</div>';
                    return;
                }

                // KaTeX レンダリング
                this.renderWithKaTeX(text);
            }

            // 数式正規化（簡略版）
            normalizeExpression(expr) {
                try {
                    // 基本的な正規化
                    let normalized = expr
                        .replace(/\\cdot/g, '*')
                        .replace(/\\times/g, '*')
                        .replace(/\\div/g, '/')
                        .replace(/\s+/g, ' ')
                        .trim();
                    
                    return `[${this.currentMode}] ${normalized}`;
                } catch (error) {
                    return `[エラー] ${expr}`;
                }
            }

            // KaTeX レンダリング
            renderWithKaTeX(text) {
                console.log('renderWithKaTeX called with text:', text);

                if (!window.katex) {
                    console.log('KaTeX not loaded yet');
                    this.preview.innerHTML = `<div style="color: #ef4444;">KaTeX読み込み中...</div>`;
                    return;
                }

                console.log('KaTeX available, attempting to render...');

                try {
                    // HTML記号をLaTeX記号に変換
                    let processedText = text
                        .replace(/</g, '\\lt ')
                        .replace(/>/g, '\\gt ')
                        .replace(/&lt;/g, '\\lt ')
                        .replace(/&gt;/g, '\\gt ');

                    // displaystyle を自動追加
                    if (!processedText.includes('\\displaystyle') && !processedText.includes('\\textstyle')) {
                        processedText = '\\displaystyle ' + processedText;
                    }

                    // インライン数式かブロック数式かを判定
                    const isDisplayMode = text.includes('\\\\') || text.includes('\\begin') || text.length > 30;

                    console.log('Rendering with KaTeX:', {
                        original: text,
                        processed: processedText,
                        displayMode: isDisplayMode
                    });

                    const rendered = window.katex.renderToString(processedText, {
                        throwOnError: false,
                        displayMode: isDisplayMode,
                        strict: false,
                        trust: true,
                        output: 'html'
                    });

                    console.log('KaTeX rendering successful:', rendered);

                    // 常にオーバーフロー対策を適用
                    this.preview.innerHTML = `<div class="long-math-container">${rendered}</div>`;

                    // this.addStatus('レンダリング完了', 'success');
                } catch (error) {
                    console.error('KaTeX rendering error:', error);
                    this.preview.innerHTML = `<div style="color: #ef4444;">レンダリングエラー: ${error.message}</div>`;
                    // this.addStatus(`レンダリングエラー: ${error.message}`, 'error');
                }
            }

    
            // 初期数式レンダリング
            renderInitialMath() {
                document.querySelectorAll('.latex-btn').forEach(btn => {
                    const latex = btn.innerHTML;
                    if (latex.includes('$')) {
                        try {
                            let mathExpr = latex.replace(/\$/g, '');
                            // displaystyle を自動追加（ボタン表示用）
                            if (!mathExpr.includes('\\displaystyle') && !mathExpr.includes('\\textstyle')) {
                                mathExpr = '\\displaystyle ' + mathExpr;
                            }
                            const rendered = window.katex.renderToString(mathExpr, {
                                throwOnError: false,
                                displayMode: false,
                                trust: true,
                                output: 'html'
                            });
                            btn.innerHTML = rendered;
                        } catch (error) {
                            console.error('Button rendering error:', error);
                            // エラーの場合は元のテキストのまま
                        }
                    }
                });
            }

            // 状態メッセージ
    
            // 保存システム
            setupSaveSystem() {
                const saveBtn = document.getElementById('saveButton');
                if (saveBtn) {
                    saveBtn.addEventListener('click', () => {
                        this.saveQuestion();
                    });
                }
            }

            async saveQuestion() {
                const title = document.getElementById('questionTitle').value.trim();
                const field = document.getElementById('fieldCode').value;
                const content = this.textarea.value.trim();

                if (!title || !field || !content) {
                    this.showMessage('すべてのフィールドを入力してください', 'error');
                    return;
                }

                const question = {
                    id: Date.now().toString(),
                    subject: 'math',
                    title,
                    field_code: field,
                    question_text: content,
                    normalized_content: this.normalizeExpression(content),
                    mode: this.currentMode,
                    created_at: new Date().toISOString()
                };

                try {
                    // D1に保存を試みる
                    const d1Success = await this.saveToD1(question);
                    if (d1Success) {
                        this.showMessage('D1に保存しました！', 'success');
                        // this.addStatus('D1に保存', 'success');
                    } else {
                        // D1保存に失敗した場合はlocalStorageにフォールバック
                        this.saveToLocalStorage(question);
                        this.showMessage('ローカルに保存しました', 'warning');
                        // this.addStatus('保存失敗、ローカルに保存', 'warning');
                    }
                } catch (error) {
                    console.error('保存エラー:', error);
                    // エラー時もlocalStorageにフォールバック
                    this.saveToLocalStorage(question);
                    this.showMessage('保存エラー、ローカルに保存', 'error');
                    // this.addStatus('保存エラー', 'error');
                }

                this.clearForm();
            }

            // D1保存メソッド
            async saveToD1(question) {
                // API無効化 - ローカルのみ
                console.log('Local save only - API disabled');
                return true;
            }

            // localStorage保存メソッド（フォールバック用）
            saveToLocalStorage(question) {
                const questions = JSON.parse(localStorage.getItem('katexStructuredMathQuestions') || '[]');
                questions.push(question);
                localStorage.setItem('katexStructuredMathQuestions', JSON.stringify(questions));
            }

            // スクロール検知メソッド
            setupScrollDetection() {
                const toolbars = document.querySelectorAll('.latex-toolbar, .tools-section');

                toolbars.forEach(toolbar => {
                    let touchStartY = 0;
                    let touchStartTime = 0;
                    let lastTouchY = 0;
                    let isScrolling = false;
                    let scrollVelocity = 0;
                    let lastTouchTime = 0;

                    // タッチ開始
                    toolbar.addEventListener('touchstart', (e) => {
                        const touch = e.touches[0];
                        touchStartY = touch.clientY;
                        lastTouchY = touch.clientY;
                        touchStartTime = Date.now();
                        lastTouchTime = Date.now();
                        isScrolling = false;
                        scrollVelocity = 0;

                        // すべてのボタンを即座に有効化
                        const buttons = toolbar.querySelectorAll('.latex-btn, .sample-chip');
                        buttons.forEach(btn => {
                            btn.style.pointerEvents = 'auto';
                            btn.style.opacity = '1';
                            btn.dataset.wasTapped = 'false';
                        });
                    }, { passive: true });

                    // タッチ移動
                    toolbar.addEventListener('touchmove', (e) => {
                        const touch = e.touches[0];
                        const currentY = touch.clientY;
                        const currentTime = Date.now();
                        const deltaTime = currentTime - lastTouchTime;
                        const deltaY = currentY - lastTouchY;

                        // スクロール速度を計算
                        if (deltaTime > 0) {
                            scrollVelocity = Math.abs(deltaY) / deltaTime;
                        }

                        const totalDeltaY = Math.abs(currentY - touchStartY);
                        const timeDelta = currentTime - touchStartTime;

                        // 5px以上移動かつ時間が100ms未満でスクロール判定
                        if (totalDeltaY > 5 && timeDelta < 100) {
                            isScrolling = true;
                        }

                        // スクロール中または高速移動中はボタンを無効化
                        if (isScrolling || scrollVelocity > 0.5) {
                            const buttons = toolbar.querySelectorAll('.latex-btn, .sample-chip');
                            buttons.forEach(btn => {
                                if (btn.dataset.wasTapped !== 'true') {
                                    btn.style.pointerEvents = 'none';
                                    btn.style.opacity = '0.5';
                                }
                            });

                            // スクロール状態をクリアするタイマー
                            clearTimeout(this.scrollTimeout);
                            this.scrollTimeout = setTimeout(() => {
                                isScrolling = false;
                                scrollVelocity = 0;
                                buttons.forEach(btn => {
                                    btn.style.pointerEvents = 'auto';
                                    btn.style.opacity = '1';
                                    delete btn.dataset.wasTapped;
                                });
                            }, 200);
                        }

                        lastTouchY = currentY;
                        lastTouchTime = currentTime;
                    }, { passive: true });

                    // タッチ終了
                    toolbar.addEventListener('touchend', (e) => {
                        const touch = e.changedTouches[0];
                        const totalDeltaY = Math.abs(touch.clientY - touchStartY);
                        const timeDelta = Date.now() - touchStartTime;

                        // 短時間での大きな移動はスクロールと判定
                        if (totalDeltaY > 15 && timeDelta < 200) {
                            isScrolling = true;

                            // スクロール終了後にボタンを再有効化
                            clearTimeout(this.scrollTimeout);
                            this.scrollTimeout = setTimeout(() => {
                                isScrolling = false;
                                const buttons = toolbar.querySelectorAll('.latex-btn, .sample-chip');
                                buttons.forEach(btn => {
                                    btn.style.pointerEvents = 'auto';
                                    btn.style.opacity = '1';
                                    delete btn.dataset.wasTapped;
                                });
                            }, 300);
                        }
                    });

                    // タッチキャンセル
                    toolbar.addEventListener('touchcancel', () => {
                        clearTimeout(this.scrollTimeout);
                        const buttons = toolbar.querySelectorAll('.latex-btn, .sample-chip');
                        buttons.forEach(btn => {
                            btn.style.pointerEvents = 'auto';
                            btn.style.opacity = '1';
                            delete btn.dataset.wasTapped;
                        });
                    });
                });

                // 全体のスクロール検知
                let scrollTimer;
                window.addEventListener('scroll', () => {
                    this.isScrolling = true;
                    clearTimeout(scrollTimer);
                    scrollTimer = setTimeout(() => {
                        this.isScrolling = false;
                    }, 150);
                }, { passive: true });
            }

            showMessage(text, type) {
                const messageEl = document.getElementById('saveMessage');
                if (!messageEl) return;
                
                const className = type === 'error' ? 'error-message' : 'success-message';
                messageEl.innerHTML = `<div class="${className}" style="margin-top: 8px; padding: 6px; border-radius: 4px;">${text}</div>`;
                
                setTimeout(() => {
                    messageEl.innerHTML = '';
                }, 3000);
            }

            // タグシステムのセットアップ
            setupTagSystem() {
                if (!this.tagInput || !this.tagDisplay || !this.tagSuggestions) {
                    console.warn('Tag elements not found:', {
                        tagInput: !!this.tagInput,
                        tagDisplay: !!this.tagDisplay,
                        tagSuggestions: !!this.tagSuggestions
                    });
                    return;
                }

                // 事前定義されたタグ候補
                this.predefinedTags = [
                    '二次方程式', '一次方程式', '連立方程式', '高次方程式',
                    '三角関数', '指数関数', '対数関数', '分数関数',
                    '微分', '積分', '極限', '級数',
                    '確率', '統計', '組み合わせ', '順列',
                    'ベクトル', '行列', '複素数', '四元数',
                    '図形', '座標幾何', '空間幾何', '立体幾何',
                    '数列', '級数', '漸化式', '数学的帰納法',
                    '不等式', '絶対値', '場合分け', '集合論',
                    '関数', '写像', '逆関数', '合成関数',
                    '多項式', '因数分解', '展開公式', '剰余定理',
                    '三角比', '三角方程式', '加法定理', '正弦余弦定理',
                    '指数法則', '対数法則', '自然対数', '常用対数',
                    '導関数', '偏微分', '全微分', 'テイラー展開',
                    '不定積分', '定積分', '置換積分', '部分積分',
                    '平均値', '分散', '標準偏差', '確率分布',
                    '場合の数', '期待値', '条件付き確率', 'ベイズ定理',
                    '内積', '外積', '行列式', '逆行列',
                    '固有値', '固有ベクトル', '対角化', 'ジョルダン標準形',
                    '円', '楕円', '双曲線', '放物線',
                    '球', '円柱', '円錐', '角錐',
                    '等差数列', '等比数列', 'フィボナッチ数列', '調和数列',
                    '収束', '発散', '連続性', '微分可能性'
                ];

                // タグ配列の初期化
                this.tags = this.tags || [];

                // イベントリスナーの設定
                this.tagInput.addEventListener('input', (e) => this.handleTagInput(e));
                this.tagInput.addEventListener('keydown', (e) => this.handleTagKeydown(e));

                // 初期レンダリング
                this.renderTags();

                console.log('Tag system initialized successfully');
            }

            // タグ入力処理
            handleTagInput(e) {
                const value = e.target.value;

                // スペースが入力されたらタグを処理
                if (value.includes(' ')) {
                    this.processTagInput(value);
                    this.tagInput.value = '';
                }

                // 入力中はサジェストを非表示（自由入力形式のため）
                this.hideTagSuggestions();
            }

            // タグキーダウン処理
            handleTagKeydown(e) {
                const value = e.target.value.trim();

                if (e.key === 'Enter' && value) {
                    e.preventDefault();
                    this.processTagInput(value);
                    this.tagInput.value = '';
                    this.hideTagSuggestions();
                } else if (e.key === 'Backspace' && !value && this.tags.length > 0) {
                    e.preventDefault();
                    this.removeTag(this.tags.length - 1);
                }
            }

            // イベントリスナーの設定に変更を加える
            setupTagSystem() {
                if (!this.tagInput || !this.tagDisplay || !this.tagSuggestions) {
                    console.warn('Tag elements not found:', {
                        tagInput: !!this.tagInput,
                        tagDisplay: !!this.tagDisplay,
                        tagSuggestions: !!this.tagSuggestions
                    });
                    return;
                }

                // 事前定義されたタグ候補（自由入力形式のため未使用）
                this.predefinedTags = [];

                // タグ配列の初期化
                this.tags = this.tags || [];

                // イベントリスナーの設定
                this.tagInput.addEventListener('input', (e) => this.handleTagInput(e));
                this.tagInput.addEventListener('keydown', (e) => this.handleTagKeydown(e));

                // タグ追加ボタンのイベントリスナー
                if (this.tagAddButton) {
                    this.tagAddButton.addEventListener('click', () => {
                        const value = this.tagInput.value.trim();
                        if (value) {
                            this.processTagInput(value);
                            this.tagInput.value = '';
                            this.tagInput.focus(); // 追加後もフォーカスを維持
                        }
                    });
                }

                // スマホ向け：フォーカスが外れたときに残りの入力を処理
                this.tagInput.addEventListener('blur', () => {
                    setTimeout(() => {
                        const remainingValue = this.tagInput.value.trim();
                        if (remainingValue) {
                            this.processTagInput(remainingValue);
                            this.tagInput.value = '';
                        }
                    }, 200);
                });

                // 初期レンダリング
                this.renderTags();

                console.log('Tag system initialized successfully');
            }

            // クリアボタンの設定
            setupClearButton() {
                const clearButton = document.getElementById('clearButton');
                if (clearButton) {
                    clearButton.addEventListener('click', () => {
                        if (this.textarea) {
                            this.textarea.value = '';
                            this.textarea.focus();
                            this.updatePreview();
                        }
                    });
                }
            }

            // タグ入力を処理（#記号とスペース区切りに対応）
            processTagInput(input) {
                // スペースで区切られたタグを処理
                const tagCandidates = input.split(/\s+/).filter(tag => tag.trim());

                tagCandidates.forEach(candidate => {
                    if (candidate.startsWith('#')) {
                        // #で始まる場合、#を含めてタグとして追加
                        this.addTag(candidate);
                    } else if (candidate.length > 0) {
                        // #で始まらない場合、#を付けて追加
                        this.addTag('#' + candidate);
                    }
                });

                // スマホ用のフィードバック
                if (tagCandidates.length > 0) {
                    this.vibrate(); // スマホの振動フィードバック
                }
            }

            // スマホの振動フィードバック
            vibrate() {
                if (navigator.vibrate && window.innerWidth <= 768) {
                    navigator.vibrate(50); // 50msの短い振動
                }
            }

            // タグを追加
            addTag(tagText) {
                const cleanedTag = tagText.trim();

                if (!cleanedTag) return;

                // 重複チェック（大文字小文字を区別しない）
                const normalizedTag = cleanedTag.toLowerCase();
                const isDuplicate = this.tags.some(existingTag =>
                    existingTag.toLowerCase() === normalizedTag
                );

                if (isDuplicate) {
                    this.showMessage('このタグは既に追加されています', 'warning');
                    return;
                }

                // タグ数制限（最大100個）
                if (this.tags.length >= 100) {
                    this.showMessage('タグは最大100個までです', 'warning');
                    return;
                }

                this.tags.push(cleanedTag);
                this.renderTags();
                this.hideTagSuggestions();
                this.showMessage(`タグ「${cleanedTag}」を追加しました (${this.tags.length}/100)`, 'success');
            }

            // タグを削除
            removeTag(index) {
                const removedTag = this.tags[index];
                this.tags.splice(index, 1);
                this.renderTags();
                this.showMessage(`タグ「${removedTag}」を削除しました (${this.tags.length}/100)`, 'info');
            }

            // タグをレンダリング
            renderTags() {
                this.tagDisplay.innerHTML = '';

                if (this.tags.length === 0) {
                    this.tagDisplay.style.display = 'none';
                    return;
                }

                this.tagDisplay.style.display = 'flex';

                // タグカウンターを追加
                const counterElement = document.createElement('div');
                counterElement.className = 'tag-counter';
                counterElement.textContent = `${this.tags.length}/100`;
                counterElement.style.cssText = `
                    font-size: 0.8em;
                    color: #6c757d;
                    margin-bottom: 4px;
                    font-weight: 500;
                `;
                this.tagDisplay.appendChild(counterElement);

                // タグを追加
                this.tags.forEach((tag, index) => {
                    const tagElement = document.createElement('div');
                    tagElement.className = 'tag';
                    tagElement.innerHTML = `
                        <span>${tag}</span>
                        <span class="tag-remove" data-index="${index}">×</span>
                    `;

                    tagElement.querySelector('.tag-remove').addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.removeTag(index);
                    });

                    this.tagDisplay.appendChild(tagElement);
                });
            }

            // タグ候補を表示（自由入力形式のため無効化）
            showTagSuggestions(filter = '') {
                // 自由入力形式のためサジェストは非表示
                return;
            }

            // タグ候補を非表示
            hideTagSuggestions() {
                this.tagSuggestions.style.display = 'none';
            }

            clearForm() {
                document.getElementById('questionTitle').value = '';
                document.getElementById('fieldCode').value = '';
                document.getElementById('questionDifficulty').value = '';
                this.textarea.value = '';
                this.tags = [];
                this.renderTags();
                this.updatePreview();
            }
        }

        // RevolutionaryKaTeXSystemに認証チェックを追加
        const originalSaveQuestion = RevolutionaryKaTeXSystem.prototype.saveQuestion;
        RevolutionaryKaTeXSystem.prototype.saveQuestion = async function() {
            if (!currentUser) {
                this.showMessage('問題を投稿するにはログインが必要です', 'error');
                handleAuth();
                return;
            }

            // ユーザー情報を問題オブジェクトに追加
            const title = document.getElementById('questionTitle').value.trim();
            const field = document.getElementById('fieldCode').value;
            const content = this.textarea.value.trim();

            if (!title || !field || !content) {
                this.showMessage('タイトル、分野、内容をすべて入力してください', 'error');
                return;
            }

            // 現在の日時を取得
            const now = new Date();
            const created = now.toISOString();
            const normalized = this.normalizeExpression(content);

            const question = {
                id: Date.now().toString(),
                user_id: currentUser.id,
                user_name: currentUser.name || currentUser.email,
                title: title,
                field: field,
                subject: 'math',
                content: content,
                normalized: normalized,
                mode: this.currentMode,
                created: created,
                updated: created,
                tags: this.tags || [], // タグ情報を追加
                difficulty: parseInt(document.getElementById('questionDifficulty').value) || 0 // 難易度情報を追加
            };

            try {
                // D1に保存を試みる
                const apiUrl = getComputedStyle(document.documentElement).getPropertyValue('--api-base-url').trim();
                    const response = await fetch(`${apiUrl}/api/questions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(question)
                });

                const data = await response.json();

                if (data.success) {
                    this.showMessage('問題をD1に保存しました', 'success');
                    // this.addStatus('✅ D1保存完了', 'success');
                } else {
                    throw new Error(data.error || '保存に失敗しました');
                }
            } catch (error) {
                console.error('D1保存エラー:', error);
                this.showMessage('保存エラー、ローカルに保存', 'error');
                // this.addStatus('保存エラー', 'error');
            }

            this.clearForm();
        };

        // システム初期化
        function initializeSystem() {
            console.log('Initializing system...');

            // KaTeXの読み込みを確認
            if (window.katex && typeof window.katex.renderToString === 'function') {
                console.log('KaTeX is ready, initializing RevolutionaryKaTeXSystem...');
                window.revolutionaryKaTeXSystem = new RevolutionaryKaTeXSystem();
            } else {
                console.log('KaTeX not ready yet, waiting...');
                setTimeout(initializeSystem, 100);
            }
        }

        // DOM読み込み完了後に初期化開始
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, starting system initialization...');
            initializeSystem();
        });
    </script>
</body>
</html>
