<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¯ å•é¡Œç·´ç¿’ - å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        :root {
            --primary-color: #ec4899;
            --secondary-color: #be185d;
            --accent-color: #f472b6;
            --bg-color: #fdf2f8;
            --text-color: #1f2937;
            --border-color: #fbcfe8;
            --hover-bg: #fce7f3;
            --success-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Hiragino Sans', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 5px solid var(--primary-color);
        }

        .header h1 {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .nav-breadcrumb {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .nav-breadcrumb a {
            color: var(--primary-color);
            text-decoration: none;
            margin-right: 10px;
        }

        .practice-modes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .mode-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .mode-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-color);
        }

        .mode-card.selected {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, white, #fdf2f8);
        }

        .mode-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            text-align: center;
            color: var(--primary-color);
        }

        .mode-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-color);
            text-align: center;
        }

        .mode-description {
            color: #6b7280;
            text-align: center;
            margin-bottom: 15px;
        }

        .mode-features {
            list-style: none;
            font-size: 0.9rem;
            color: #6b7280;
        }

        .mode-features li {
            padding: 3px 0;
        }

        .mode-features li:before {
            content: "âœ“ ";
            color: var(--primary-color);
            font-weight: bold;
        }

        .settings-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: none;
        }

        .settings-section.show {
            display: block;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .setting-group {
            display: flex;
            flex-direction: column;
        }

        .setting-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-color);
        }

        .setting-group select,
        .setting-group input {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .setting-group select:focus,
        .setting-group input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .practice-area {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: none;
        }

        .practice-area.show {
            display: block;
        }

        .progress-bar {
            background: #e5e7eb;
            border-radius: 10px;
            height: 12px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            height: 100%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .question-display {
            background: #f8fafc;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 4px solid var(--primary-color);
        }

        .question-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: #6b7280;
        }

        .question-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .question-content {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .choices-area {
            margin: 20px 0;
        }

        .choice-item {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .choice-item:hover {
            border-color: var(--primary-color);
            background: var(--hover-bg);
        }

        .choice-item.selected {
            border-color: var(--primary-color);
            background: #fce7f3;
        }

        .choice-item.correct {
            border-color: var(--success-color);
            background: #d1fae5;
        }

        .choice-item.incorrect {
            border-color: var(--error-color);
            background: #fee2e2;
        }

        .answer-input {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1.1rem;
            margin: 15px 0;
        }

        .answer-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .result-display {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            text-align: center;
            display: none;
        }

        .result-display.show {
            display: block;
        }

        .result-display.correct {
            border: 3px solid var(--success-color);
            background: linear-gradient(135deg, #d1fae5, white);
        }

        .result-display.incorrect {
            border: 3px solid var(--error-color);
            background: linear-gradient(135deg, #fee2e2, white);
        }

        .result-icon {
            font-size: 4rem;
            margin-bottom: 15px;
        }

        .result-message {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .explanation-area {
            background: #f8fafc;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
            text-align: left;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-large {
            padding: 15px 40px;
            font-size: 1.1rem;
        }

        .stats-summary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .stat-item h3 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .stat-item p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .timer {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .timer-display {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .practice-modes {
                grid-template-columns: 1fr;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .question-meta {
                flex-direction: column;
                align-items: stretch;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav-breadcrumb">
            <a href="../">ğŸ”¢ Math Manager</a> â†’ <span>ğŸ¯ å•é¡Œç·´ç¿’</span>
        </div>

        <div class="header">
            <h1>ğŸ¯ å•é¡Œç·´ç¿’</h1>
            <p>å®Ÿéš›ã«æ•°å­¦å•é¡Œã‚’è§£ã„ã¦å­¦ç¿’ä½“é¨“</p>
        </div>

        <div class="stats-summary">
            <h3>å­¦ç¿’é€²æ—</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <h3 id="totalAttempts">0</h3>
                    <p>ç·è§£ç­”æ•°</p>
                </div>
                <div class="stat-item">
                    <h3 id="correctRate">0%</h3>
                    <p>æ­£ç­”ç‡</p>
                </div>
                <div class="stat-item">
                    <h3 id="streakCount">0</h3>
                    <p>é€£ç¶šæ­£è§£</p>
                </div>
                <div class="stat-item">
                    <h3 id="averageTime">0s</h3>
                    <p>å¹³å‡æ™‚é–“</p>
                </div>
            </div>
        </div>

        <!-- ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰é¸æŠ -->
        <div class="practice-modes" id="practiceModesSection">
            <div class="mode-card" onclick="selectMode('random')">
                <div class="mode-icon">ğŸ²</div>
                <div class="mode-title">ãƒ©ãƒ³ãƒ€ãƒ ç·´ç¿’</div>
                <div class="mode-description">å…¨å•é¡Œã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«å‡ºé¡Œ</div>
                <ul class="mode-features">
                    <li>ãƒãƒ©ãƒ³ã‚¹ã‚ˆãå­¦ç¿’</li>
                    <li>å¼±ç‚¹ç™ºè¦‹ã«åŠ¹æœçš„</li>
                    <li>å…¨åˆ†é‡å¯¾å¿œ</li>
                </ul>
            </div>
            
            <div class="mode-card" onclick="selectMode('difficulty')">
                <div class="mode-icon">ğŸ“Š</div>
                <div class="mode-title">é›£æ˜“åº¦åˆ¥ç·´ç¿’</div>
                <div class="mode-description">é›£æ˜“åº¦ã‚’æŒ‡å®šã—ã¦é›†ä¸­å­¦ç¿’</div>
                <ul class="mode-features">
                    <li>æ®µéšçš„ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—</li>
                    <li>åŸºç¤å›ºã‚ã«æœ€é©</li>
                    <li>æ˜“ãƒ»ä¸­ãƒ»é›£ã‹ã‚‰é¸æŠ</li>
                </ul>
            </div>

            <div class="mode-card" onclick="selectMode('category')">
                <div class="mode-icon">ğŸ“š</div>
                <div class="mode-title">åˆ†é‡åˆ¥ç·´ç¿’</div>
                <div class="mode-description">ç‰¹å®šåˆ†é‡ã‚’é›†ä¸­çš„ã«å­¦ç¿’</div>
                <ul class="mode-features">
                    <li>è‹¦æ‰‹åˆ†é‡å…‹æœ</li>
                    <li>å°‚é–€åˆ†é‡å¼·åŒ–</li>
                    <li>åŠ¹ç‡çš„å­¦ç¿’</li>
                </ul>
            </div>

            <div class="mode-card" onclick="selectMode('timed')">
                <div class="mode-icon">â±ï¸</div>
                <div class="mode-title">æ™‚é–“åˆ¶é™ç·´ç¿’</div>
                <div class="mode-description">åˆ¶é™æ™‚é–“å†…ã§ã®å®Ÿæˆ¦ç·´ç¿’</div>
                <ul class="mode-features">
                    <li>è©¦é¨“å¯¾ç­–ã«æœ€é©</li>
                    <li>æ™‚é–“æ„Ÿè¦šã‚’é¤Šæˆ</li>
                    <li>é›†ä¸­åŠ›å‘ä¸Š</li>
                </ul>
            </div>
        </div>

        <!-- è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="settings-section" id="settingsSection">
            <h3 style="color: var(--primary-color); margin-bottom: 20px;">ğŸ“‹ ç·´ç¿’è¨­å®š</h3>
            <div class="settings-grid">
                <div class="setting-group">
                    <label for="questionCount">å•é¡Œæ•°</label>
                    <select id="questionCount">
                        <option value="5">5å•</option>
                        <option value="10" selected>10å•</option>
                        <option value="15">15å•</option>
                        <option value="20">20å•</option>
                        <option value="all">ã™ã¹ã¦</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label for="difficultyFilter">é›£æ˜“åº¦</label>
                    <select id="difficultyFilter">
                        <option value="">ã™ã¹ã¦</option>
                        <option value="æ˜“">æ˜“ (åŸºç¤)</option>
                        <option value="ä¸­">ä¸­ (æ¨™æº–)</option>
                        <option value="é›£">é›£ (ç™ºå±•)</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label for="categoryFilter">åˆ†é‡</label>
                    <select id="categoryFilter">
                        <option value="">ã™ã¹ã¦</option>
                    </select>
                </div>
                <div class="setting-group" id="timerSetting" style="display: none;">
                    <label for="timeLimit">åˆ¶é™æ™‚é–“ (ç§’)</label>
                    <input type="number" id="timeLimit" value="60" min="30" max="600">
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary btn-large" onclick="startPractice()">ğŸš€ ç·´ç¿’é–‹å§‹</button>
                <button class="btn btn-secondary" onclick="goBack()">â† æˆ»ã‚‹</button>
            </div>
        </div>

        <!-- ç·´ç¿’ã‚¨ãƒªã‚¢ -->
        <div class="practice-area" id="practiceArea">
            <div class="timer" id="timerDisplay" style="display: none;">
                <div>æ®‹ã‚Šæ™‚é–“</div>
                <div class="timer-display" id="timeRemaining">60</div>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%;">
                    <span id="progressText">0/0</span>
                </div>
            </div>

            <div class="question-display" id="questionDisplay">
                <!-- å•é¡ŒãŒè¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>

            <div class="result-display" id="resultDisplay">
                <!-- çµæœãŒè¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary btn-large" id="submitAnswer" onclick="submitAnswer()" style="display: none;">å›ç­”ã™ã‚‹</button>
                <button class="btn btn-success" id="nextQuestion" onclick="nextQuestion()" style="display: none;">æ¬¡ã®å•é¡Œ â†’</button>
                <button class="btn btn-warning" onclick="finishPractice()" id="finishButton" style="display: none;">ç·´ç¿’çµ‚äº†</button>
                <button class="btn btn-secondary" onclick="goToModeSelection()">â† ãƒ¢ãƒ¼ãƒ‰é¸æŠã«æˆ»ã‚‹</button>
            </div>
        </div>
    </div>

    <script>
        // å•é¡Œç·´ç¿’ã‚·ã‚¹ãƒ†ãƒ 
        class PracticeSystem {
            constructor() {
                this.questions = [];
                this.currentMode = null;
                this.practiceQuestions = [];
                this.currentQuestionIndex = 0;
                this.userAnswers = [];
                this.stats = this.loadStats();
                this.timer = null;
                this.startTime = null;
                this.init();
            }

            init() {
                this.loadQuestions();
                this.populateFilters();
                this.updateStatsDisplay();
            }

            loadQuestions() {
                this.questions = JSON.parse(localStorage.getItem('mathQuestions') || '[]')
                    .filter(q => (q.approvals || 0) >= 3); // æ‰¿èªæ¸ˆã¿ã®ã¿
            }

            loadStats() {
                return JSON.parse(localStorage.getItem('practiceStats') || JSON.stringify({
                    totalAttempts: 0,
                    correctAnswers: 0,
                    totalTime: 0,
                    streak: 0,
                    bestStreak: 0
                }));
            }

            saveStats() {
                localStorage.setItem('practiceStats', JSON.stringify(this.stats));
            }

            populateFilters() {
                const categories = [...new Set(this.questions.map(q => q.category).filter(Boolean))];
                const categorySelect = document.getElementById('categoryFilter');
                
                categorySelect.innerHTML = '<option value="">ã™ã¹ã¦</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categorySelect.appendChild(option);
                });
            }

            updateStatsDisplay() {
                const correctRate = this.stats.totalAttempts > 0 ? 
                    Math.round((this.stats.correctAnswers / this.stats.totalAttempts) * 100) : 0;
                const averageTime = this.stats.totalAttempts > 0 ?
                    Math.round(this.stats.totalTime / this.stats.totalAttempts) : 0;

                document.getElementById('totalAttempts').textContent = this.stats.totalAttempts;
                document.getElementById('correctRate').textContent = correctRate + '%';
                document.getElementById('streakCount').textContent = this.stats.streak;
                document.getElementById('averageTime').textContent = averageTime + 's';
            }

            selectMode(mode) {
                this.currentMode = mode;
                
                // ãƒ¢ãƒ¼ãƒ‰ã‚«ãƒ¼ãƒ‰ã®é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
                document.querySelectorAll('.mode-card').forEach(card => {
                    card.classList.remove('selected');
                });
                event.currentTarget.classList.add('selected');

                // è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
                document.getElementById('practiceModesSection').style.display = 'none';
                document.getElementById('settingsSection').classList.add('show');

                // æ™‚é–“åˆ¶é™ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ã‚¿ã‚¤ãƒãƒ¼è¨­å®šã‚’è¡¨ç¤º
                const timerSetting = document.getElementById('timerSetting');
                if (mode === 'timed') {
                    timerSetting.style.display = 'block';
                } else {
                    timerSetting.style.display = 'none';
                }
            }

            startPractice() {
                const questionCount = document.getElementById('questionCount').value;
                const difficultyFilter = document.getElementById('difficultyFilter').value;
                const categoryFilter = document.getElementById('categoryFilter').value;

                // å•é¡Œã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                let filteredQuestions = [...this.questions];
                
                if (difficultyFilter) {
                    filteredQuestions = filteredQuestions.filter(q => q.difficulty === difficultyFilter);
                }
                
                if (categoryFilter) {
                    filteredQuestions = filteredQuestions.filter(q => q.category === categoryFilter);
                }

                if (filteredQuestions.length === 0) {
                    alert('æ¡ä»¶ã«åˆã†å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®šã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                // å•é¡Œæ•°ã‚’æ±ºå®š
                const maxQuestions = questionCount === 'all' ? filteredQuestions.length : parseInt(questionCount);
                
                // å•é¡Œã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦é¸æŠ
                this.practiceQuestions = this.shuffleArray([...filteredQuestions]).slice(0, maxQuestions);
                this.currentQuestionIndex = 0;
                this.userAnswers = [];

                // ç·´ç¿’é–‹å§‹
                document.getElementById('settingsSection').classList.remove('show');
                document.getElementById('practiceArea').classList.add('show');

                this.displayCurrentQuestion();
            }

            shuffleArray(array) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }

            displayCurrentQuestion() {
                if (this.currentQuestionIndex >= this.practiceQuestions.length) {
                    this.showResults();
                    return;
                }

                const question = this.practiceQuestions[this.currentQuestionIndex];
                this.startTime = Date.now();

                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ›´æ–°
                const progress = ((this.currentQuestionIndex) / this.practiceQuestions.length) * 100;
                document.getElementById('progressFill').style.width = progress + '%';
                document.getElementById('progressText').textContent = 
                    `${this.currentQuestionIndex + 1}/${this.practiceQuestions.length}`;

                // å•é¡Œè¡¨ç¤º
                const questionDisplay = document.getElementById('questionDisplay');
                questionDisplay.innerHTML = `
                    <div class="question-meta">
                        <div>
                            <span class="tag">${question.type}</span>
                            <span class="tag">${question.difficulty}</span>
                            <span class="tag">${question.category}</span>
                        </div>
                        <div>å•é¡Œ ${this.currentQuestionIndex + 1} / ${this.practiceQuestions.length}</div>
                    </div>
                    <div class="question-title">${question.title}</div>
                    <div class="question-content">${question.question}</div>
                    <div id="answerArea">${this.renderAnswerArea(question)}</div>
                `;

                // ãƒœã‚¿ãƒ³è¡¨ç¤ºèª¿æ•´
                document.getElementById('submitAnswer').style.display = 'inline-block';
                document.getElementById('nextQuestion').style.display = 'none';
                document.getElementById('resultDisplay').classList.remove('show');

                // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹ï¼ˆæ™‚é–“åˆ¶é™ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆï¼‰
                if (this.currentMode === 'timed') {
                    this.startTimer();
                }
            }

            renderAnswerArea(question) {
                if (question.type === 'A1') {
                    return `
                        <div class="choices-area">
                            ${question.choices.map((choice, index) => `
                                <div class="choice-item" onclick="selectChoice(${index})">
                                    ${index + 1}. ${choice}
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    return `
                        <textarea class="answer-input" id="freeAnswer" 
                                  placeholder="${question.type === 'F1' ? 'æ•°å€¤ã‚„çŸ­ã„ç­”ãˆã‚’å…¥åŠ›' : 'è©³ç´°ãªè§£ç­”ã‚’è¨˜è¿°'}"></textarea>
                    `;
                }
            }

            startTimer() {
                const timeLimit = parseInt(document.getElementById('timeLimit').value);
                let timeRemaining = timeLimit;
                
                document.getElementById('timerDisplay').style.display = 'block';
                
                this.timer = setInterval(() => {
                    timeRemaining--;
                    document.getElementById('timeRemaining').textContent = timeRemaining;
                    
                    if (timeRemaining <= 0) {
                        this.submitAnswer();
                    }
                }, 1000);
            }

            stopTimer() {
                if (this.timer) {
                    clearInterval(this.timer);
                    this.timer = null;
                }
                document.getElementById('timerDisplay').style.display = 'none';
            }

            selectChoice(choiceIndex) {
                // æ—¢å­˜ã®é¸æŠã‚’è§£é™¤
                document.querySelectorAll('.choice-item').forEach(item => {
                    item.classList.remove('selected');
                });
                
                // æ–°ã—ã„é¸æŠã‚’è¨­å®š
                document.querySelectorAll('.choice-item')[choiceIndex].classList.add('selected');
                
                // é¸æŠã—ãŸç­”ãˆã‚’è¨˜éŒ²
                this.selectedChoice = choiceIndex;
            }

            submitAnswer() {
                const question = this.practiceQuestions[this.currentQuestionIndex];
                const endTime = Date.now();
                const timeSpent = Math.round((endTime - this.startTime) / 1000);
                
                this.stopTimer();

                let userAnswer = null;
                let isCorrect = false;

                if (question.type === 'A1') {
                    userAnswer = this.selectedChoice;
                    isCorrect = userAnswer === question.correct;
                } else {
                    userAnswer = document.getElementById('freeAnswer').value.trim();
                    // F1/F2ã®æ­£è§£åˆ¤å®šã¯ç°¡ç•¥åŒ–ï¼ˆå®Ÿéš›ã¯ã‚ˆã‚Šè¤‡é›‘ãªåˆ¤å®šãŒå¿…è¦ï¼‰
                    isCorrect = userAnswer.toLowerCase() === (question.answer || '').toLowerCase();
                }

                // çµ±è¨ˆæ›´æ–°
                this.stats.totalAttempts++;
                this.stats.totalTime += timeSpent;
                
                if (isCorrect) {
                    this.stats.correctAnswers++;
                    this.stats.streak++;
                    this.stats.bestStreak = Math.max(this.stats.bestStreak, this.stats.streak);
                } else {
                    this.stats.streak = 0;
                }

                this.saveStats();
                this.updateStatsDisplay();

                // çµæœä¿å­˜
                this.userAnswers.push({
                    question: question,
                    userAnswer: userAnswer,
                    isCorrect: isCorrect,
                    timeSpent: timeSpent
                });

                // çµæœè¡¨ç¤º
                this.showAnswerResult(question, userAnswer, isCorrect);
                
                // ãƒœã‚¿ãƒ³è¡¨ç¤ºèª¿æ•´
                document.getElementById('submitAnswer').style.display = 'none';
                if (this.currentQuestionIndex < this.practiceQuestions.length - 1) {
                    document.getElementById('nextQuestion').style.display = 'inline-block';
                } else {
                    document.getElementById('finishButton').style.display = 'inline-block';
                }
            }

            showAnswerResult(question, userAnswer, isCorrect) {
                const resultDisplay = document.getElementById('resultDisplay');
                const resultClass = isCorrect ? 'correct' : 'incorrect';
                const resultIcon = isCorrect ? 'ğŸ‰' : 'ğŸ˜…';
                const resultMessage = isCorrect ? 'æ­£è§£ã§ã™ï¼' : 'ä¸æ­£è§£ã§ã™';

                resultDisplay.className = `result-display show ${resultClass}`;
                resultDisplay.innerHTML = `
                    <div class="result-icon">${resultIcon}</div>
                    <div class="result-message">${resultMessage}</div>
                    ${!isCorrect && question.type === 'A1' ? `
                        <p><strong>æ­£è§£:</strong> ${question.choices[question.correct]}</p>
                    ` : ''}
                    ${!isCorrect && (question.type === 'F1' || question.type === 'F2') ? `
                        <p><strong>æ­£è§£:</strong> ${question.answer}</p>
                    ` : ''}
                    ${question.explanation ? `
                        <div class="explanation-area">
                            <strong>è§£èª¬:</strong><br>
                            ${question.explanation}
                        </div>
                    ` : ''}
                `;

                // A1æŠã®å ´åˆã€æ­£è§£/ä¸æ­£è§£ã‚’ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«è¡¨ç¤º
                if (question.type === 'A1') {
                    document.querySelectorAll('.choice-item').forEach((item, index) => {
                        if (index === question.correct) {
                            item.classList.add('correct');
                        } else if (index === userAnswer && !isCorrect) {
                            item.classList.add('incorrect');
                        }
                    });
                }
            }

            nextQuestion() {
                this.currentQuestionIndex++;
                this.selectedChoice = null;
                this.displayCurrentQuestion();
            }

            showResults() {
                const correct = this.userAnswers.filter(a => a.isCorrect).length;
                const total = this.userAnswers.length;
                const accuracy = Math.round((correct / total) * 100);
                const totalTime = this.userAnswers.reduce((sum, a) => sum + a.timeSpent, 0);
                const averageTime = Math.round(totalTime / total);

                document.getElementById('practiceArea').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <h2 style="color: var(--primary-color); margin-bottom: 30px;">
                            ğŸ¯ ç·´ç¿’å®Œäº†ï¼
                        </h2>
                        
                        <div class="stats-summary">
                            <h3>ä»Šå›ã®çµæœ</h3>
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <h3>${correct}/${total}</h3>
                                    <p>æ­£è§£æ•°</p>
                                </div>
                                <div class="stat-item">
                                    <h3>${accuracy}%</h3>
                                    <p>æ­£ç­”ç‡</p>
                                </div>
                                <div class="stat-item">
                                    <h3>${totalTime}s</h3>
                                    <p>åˆè¨ˆæ™‚é–“</p>
                                </div>
                                <div class="stat-item">
                                    <h3>${averageTime}s</h3>
                                    <p>å¹³å‡æ™‚é–“</p>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 30px;">
                            <button class="btn btn-primary btn-large" onclick="restartPractice()">
                                ğŸ”„ ã‚‚ã†ä¸€åº¦ç·´ç¿’
                            </button>
                            <button class="btn btn-secondary" onclick="goToModeSelection()">
                                â† ãƒ¢ãƒ¼ãƒ‰é¸æŠã«æˆ»ã‚‹
                            </button>
                        </div>
                    </div>
                `;
            }

            finishPractice() {
                this.showResults();
            }

            restartPractice() {
                this.currentQuestionIndex = 0;
                this.userAnswers = [];
                this.selectedChoice = null;
                this.displayCurrentQuestion();
            }

            goToModeSelection() {
                document.getElementById('practiceArea').classList.remove('show');
                document.getElementById('settingsSection').classList.remove('show');
                document.getElementById('practiceModesSection').style.display = 'grid';
                
                this.stopTimer();
                document.querySelectorAll('.mode-card').forEach(card => {
                    card.classList.remove('selected');
                });
                
                this.currentMode = null;
            }

            goBack() {
                this.goToModeSelection();
            }
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
        function selectMode(mode) {
            window.practiceSystem.selectMode(mode);
        }

        function startPractice() {
            window.practiceSystem.startPractice();
        }

        function selectChoice(choiceIndex) {
            window.practiceSystem.selectChoice(choiceIndex);
        }

        function submitAnswer() {
            window.practiceSystem.submitAnswer();
        }

        function nextQuestion() {
            window.practiceSystem.nextQuestion();
        }

        function finishPractice() {
            window.practiceSystem.finishPractice();
        }

        function restartPractice() {
            window.practiceSystem.restartPractice();
        }

        function goToModeSelection() {
            window.practiceSystem.goToModeSelection();
        }

        function goBack() {
            window.practiceSystem.goBack();
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            window.practiceSystem = new PracticeSystem();
            
            // ã‚µãƒ³ãƒ—ãƒ«å•é¡ŒãŒãªã„å ´åˆã¯èª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            const questions = JSON.parse(localStorage.getItem('mathQuestions') || '[]');
            if (questions.length === 0) {
                const container = document.querySelector('.container');
                const sampleSection = document.createElement('div');
                sampleSection.style.cssText = 'background: white; border-radius: 12px; padding: 30px; margin-bottom: 20px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.1);';
                sampleSection.innerHTML = `
                    <h3 style="color: var(--primary-color); margin-bottom: 15px;">ğŸ“ å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“</h3>
                    <p style="margin-bottom: 20px;">ç·´ç¿’ã‚’å§‹ã‚ã‚‹ã«ã¯å•é¡ŒãŒå¿…è¦ã§ã™ã€‚ã‚µãƒ³ãƒ—ãƒ«å•é¡Œã‚’èª­ã¿è¾¼ã‚€ã‹ã€æ–°ã—ã„å•é¡Œã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚</p>
                    <button class="btn btn-primary" onclick="loadSampleData()">ğŸ“¥ ã‚µãƒ³ãƒ—ãƒ«å•é¡Œèª­ã¿è¾¼ã¿</button>
                    <a href="../creator/" class="btn btn-secondary">âœ¨ å•é¡Œä½œæˆ</a>
                `;
                container.insertBefore(sampleSection, document.getElementById('practiceModesSection'));
            }
        });

        function loadSampleData() {
            const sampleData = [
                {
                    id: 'math_001',
                    type: 'A1',
                    title: 'äºŒæ¬¡æ–¹ç¨‹å¼ã®è§£',
                    question: 'xÂ² - 5x + 6 = 0 ã®è§£ã¯ï¼Ÿ',
                    choices: ['x = 1, 6', 'x = 2, 3', 'x = -2, -3', 'x = -1, -6'],
                    correct: 1,
                    difficulty: 'ä¸­',
                    category: 'ä»£æ•°',
                    explanation: 'å› æ•°åˆ†è§£ã™ã‚‹ã¨ (x-2)(x-3) = 0 ã‚ˆã‚Š x = 2, 3',
                    created: new Date().toISOString(),
                    approvals: 3,
                    rating: 4.2
                },
                {
                    id: 'math_002',
                    type: 'F1',
                    title: 'ä¸‰è§’é–¢æ•°ã®å€¤',
                    question: 'sin 60Â° ã®å€¤ã‚’æ±‚ã‚ãªã•ã„ã€‚',
                    answer: 'âˆš3/2',
                    difficulty: 'æ˜“',
                    category: 'ä¸‰è§’é–¢æ•°',
                    explanation: 'ç‰¹åˆ¥è§’ã®å€¤ã¨ã—ã¦è¦šãˆã‚‹åŸºæœ¬å€¤',
                    created: new Date().toISOString(),
                    approvals: 4,
                    rating: 4.0
                },
                {
                    id: 'math_003',
                    type: 'F2',
                    title: 'æ¥µé™ã®è¨ˆç®—',
                    question: 'lim(xâ†’0) sin x / x ã‚’æ±‚ã‚ã‚ˆã€‚',
                    answer: '1',
                    difficulty: 'é›£',
                    category: 'å¾®åˆ†',
                    explanation: 'ãƒ­ãƒ”ã‚¿ãƒ«ã®å®šç†ã‚’ä½¿ç”¨ã™ã‚‹ã‹ã€æ¨™æº–çš„ãªæ¥µé™ã¨ã—ã¦çŸ¥ã‚‰ã‚Œã¦ã„ã‚‹å€¤',
                    created: new Date().toISOString(),
                    approvals: 5,
                    rating: 3.8
                },
                {
                    id: 'math_004',
                    type: 'A1',
                    title: 'ç¢ºç‡ã®åŸºæœ¬',
                    question: 'ã‚³ã‚¤ãƒ³ã‚’3å›æŠ•ã’ã¦ã€ã™ã¹ã¦è¡¨ãŒå‡ºã‚‹ç¢ºç‡ã¯ï¼Ÿ',
                    choices: ['1/2', '1/4', '1/8', '1/16'],
                    correct: 2,
                    difficulty: 'æ˜“',
                    category: 'ç¢ºç‡',
                    explanation: '(1/2)Â³ = 1/8',
                    created: new Date().toISOString(),
                    approvals: 3,
                    rating: 4.5
                },
                {
                    id: 'math_005',
                    type: 'F1',
                    title: 'å¾®åˆ†ã®è¨ˆç®—',
                    question: 'f(x) = xÂ³ + 2xÂ² - x + 1 ã®å°é–¢æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚',
                    answer: 'f\'(x) = 3xÂ² + 4x - 1',
                    difficulty: 'ä¸­',
                    category: 'å¾®åˆ†',
                    explanation: 'å„é …ã‚’ã¹ãä¹—ã®å…¬å¼ã§å¾®åˆ†ã™ã‚‹',
                    created: new Date().toISOString(),
                    approvals: 4,
                    rating: 4.1
                }
            ];

            localStorage.setItem('mathQuestions', JSON.stringify(sampleData));
            location.reload();
        }
    </script>
</body>
</html>