<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#fef5e7">
    <title>学習ノート</title>
    <link rel="apple-touch-icon" href="https://pub-d59d6e46c3154423956f648f8df909ae.r2.dev/61203.jpg">
    <link rel="icon" href="https://pub-d59d6e46c3154423956f648f8df909ae.r2.dev/61203.jpg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Klee+One:wght@400;600&family=Zen+Kurenaido&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/theme-toggle.css">
    <link rel="stylesheet" href="../css/rating-system.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <!-- Material Symbols -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0">
    <!-- Tabler Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons@latest/iconfont/tabler-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="../js/theme.js"></script>
    <script src="../js/core/unified-api-client.js"></script>
    <script src="../js/core/auth-manager.js"></script>
    <script src="../js/components/sidebar.js"></script>
</head>

<body>
    <div class="notebook">
        <div class="doodle-bg doodle-star">★</div>
        <div class="doodle-bg doodle-heart">♡</div>
        <div class="doodle-bg doodle-note">♪</div>
        <div class="doodle-bg doodle-smile">☺</div>
        <div class="doodle-bg doodle-check">✓</div>
        <div class="doodle-bg doodle-arrow">→</div>
        <div class="doodle-bg doodle-circle">◯</div>
        <div class="doodle-bg doodle-flower">✿</div>
        <div class="doodle-bg doodle-sun">☀</div>
        <div class="doodle-bg doodle-cloud">☁</div>
        <div class="doodle-bg doodle-pencil">✏</div>
        <div class="doodle-bg doodle-book"><span class="material-symbols-outlined icon">menu_book</span></div>
        <div class="doodle-bg doodle-rocket"><span class="material-symbols-rounded icon">rocket_launch</span></div>
        <div class="doodle-bg doodle-light"><span class="material-symbols-rounded icon">lightbulb</span></div>
        <div class="doodle-bg doodle-trophy">🏆</div>

        <div class="scribble scribble-1"></div>
        <div class="scribble scribble-2"></div>
        <div class="scribble scribble-3"></div>
        
        <svg class="doodle-line doodle-line-1" width="100" height="100">
            <path d="M 10 50 Q 30 20, 50 50 T 90 50" stroke="#d4a574" stroke-width="2" fill="none" opacity="0.1"/>
        </svg>
        <svg class="doodle-line doodle-line-2" width="80" height="80">
            <circle cx="40" cy="40" r="30" stroke="#d4a574" stroke-width="2" fill="none" opacity="0.1" stroke-dasharray="5,5"/>
        </svg>

        <div class="container">
            <div class="main-content">
                <!-- 共通ヘッダー（全モード共通） -->
                <h1 id="subjectTitle">学習</h1>
                <button class="back-btn" id="backBtn">← 戻る</button>

                <!-- 通常学習モード -->
                <div class="study-area">
                <div class="card">
                    <div class="underline"></div>
                    <p class="question" id="question">次の問題を押してスタート</p>
                    <div class="underline"></div>
                    <div class="doodle">✎</div>
                </div>

                <div id="speakBtnArea" class="speak-area hidden">
                    <button id="speakBtn" onclick="speakAgain()">音声を再生</button>
                </div>

                <div class="choices" id="choices">
                    <button class="choice-btn" onclick="selectChoice(0)">A</button>
                    <button class="choice-btn" onclick="selectChoice(1)">B</button>
                    <button class="choice-btn" onclick="selectChoice(2)">C</button>
                    <button class="choice-btn" onclick="selectChoice(3)">D</button>
                    <button class="choice-btn" onclick="selectChoice(4)">E</button>
                </div>

                <!-- 数学用の数値入力UI -->
                <div class="math-input-area hidden" id="mathInputArea">
                    <div class="help-button-container" style="text-align: right; margin-bottom: 10px;">
                        <button class="help-btn" onclick="showMathRules()" style="background: transparent; border: 1px solid #666; color: #666; padding: 5px 15px; border-radius: 20px; cursor: pointer; font-size: 14px;">
                            ? ルール
                        </button>
                    </div>
                    <div class="numeric-input-container" style="display: flex; align-items: center; justify-content: center; gap: 15px; margin: 20px 0;">
                        <label for="mathAnswerInput" style="font-size: 18px; font-weight: 600;">答え:</label>
                        <input type="number" id="mathAnswerInput" placeholder="数値を入力"
                               style="width: 200px; padding: 12px; font-size: 18px; border: 2px solid #ddd; border-radius: 8px; text-align: center;"
                               onkeypress="if(event.key === 'Enter') submitMathAnswer()">
                        <button class="submit-math-btn" onclick="submitMathAnswer()"
                                style="padding: 12px 30px; background: #4f46e5; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600;">
                            解答する
                        </button>
                    </div>
                </div>

                <div class="result hidden" id="result">
                    <p class="result-text" id="resultText"></p>
                    <p class="correct-answer" id="correctAnswer"></p>
                    <div class="explanation-box" id="explanationBox" style="display: none; margin: 20px 0; padding: 15px; background: #f8f9fa; border-left: 4px solid #4f46e5; border-radius: 8px;">
                        <h4 style="margin-bottom: 10px; color: #4f46e5; font-size: 16px;">解説</h4>
                        <p id="explanationText" style="line-height: 1.8; color: #333;"></p>
                    </div>
                    <button class="next-btn" onclick="nextQuestion()">次の問題 →</button>
                </div>

                <!-- 評価・コメントセクション -->
                <div class="rating-section hidden" id="ratingSection">
                    <div class="card">
                        <div class="underline"></div>
                        <h3 style="margin-bottom: 20px; color: var(--text-primary);">
                            <span class="material-symbols-outlined" style="vertical-align: middle; margin-right: 8px;">star</span>
                            この問題を評価
                        </h3>
                        <div class="rating-container" id="ratingContainer">
                            <!-- 評価システムがここに読み込まれる -->
                        </div>
                    </div>
                </div>

                <div class="stats">
                    <p class="stat">問題数: <span id="count">0</span></p>
                    <p class="stat">正解: <span id="correct">0</span></p>
                    <p class="stat">正解率: <span id="accuracy">-</span></p>
                </div>
                </div>

                <!-- 英作文モード -->
                <div id="writing-container" class="writing-area" style="display: none;">
                    <!-- EnglishCompositionSystem がここに読み込まれる -->
                </div>
            </div>

            <!-- 右サイドバー（統一コンポーネントにより自動生成） -->
            <div class="right-sidebar">
            </div>
        </div>
    </div>

    <!-- 数学ルール表示モーダル -->
    <div id="mathRulesModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
        <div class="modal-content" style="background-color: #ffffff; margin: 10% auto; padding: 30px; border-radius: 12px; width: 80%; max-width: 600px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #333; margin: 0;">数学問題の解答ルール</h3>
                <span class="close" onclick="closeMathRules()" style="font-size: 28px; font-weight: bold; color: #aaa; cursor: pointer;">&times;</span>
            </div>
            <div style="line-height: 1.8; color: #555;">
                <p style="margin-bottom: 15px; font-weight: 600; color: #4f46e5;">答えは数値のみを入力してください</p>
                <div style="background: #f0f4ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #d0d9ff;">
                    <p style="margin-bottom: 10px; font-weight: 600; color: #333;">変換ルール：</p>
                    <ul style="margin: 0; padding-left: 20px;">
                        <li style="margin-bottom: 8px;">有理化された、約分された形で計算</li>
                        <li style="margin-bottom: 8px;">分数 \(\frac{a}{b}\) → \(a + b\)</li>
                        <li style="margin-bottom: 8px;">\(\sqrt{n}\) → \(n\)</li>
                        <li style="margin-bottom: 8px;">\(\log n\) → \(n\)、\(\log(1/n)\) → \(1 + n\)</li>
                        <li style="margin-bottom: 8px;">マイナスは無視</li>
                    </ul>
                </div>
                <div style="background: #fffbeb; padding: 15px; border-radius: 8px; border: 1px solid #fde68a;">
                    <p style="margin: 0; font-weight: 600; margin-bottom: 10px; color: #92400e;">例：</p>
                    <p style="margin: 5px 0; color: #333;">\(\frac{3}{4} + \sqrt{3} + \log 3\) の場合</p>
                    <p style="margin: 5px 0; color: #4f46e5; font-weight: 600;">→ \(3 + 4 + 3 + 3 = 13\) と入力</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 手書き風の猫（背景装飾） -->
    <div style="position: fixed; bottom: 20px; right: 20px; opacity: 0.15; pointer-events: none; z-index: 1;">
        <svg width="120" height="120" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
            <!-- 左耳 -->
            <path d="M 35 25 Q 30 15 40 10 Q 45 20 40 30 Z" fill="#666" stroke="#555" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <!-- 右耳 -->
            <path d="M 65 25 Q 70 15 60 10 Q 55 20 60 30 Z" fill="#666" stroke="#555" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <!-- 頭 -->
            <circle cx="50" cy="45" r="20" fill="#777" stroke="#555" stroke-width="2"/>
            <!-- 左目 -->
            <ellipse cx="43" cy="42" rx="3" ry="5" fill="#333"/>
            <!-- 右目 -->
            <ellipse cx="57" cy="42" rx="3" ry="5" fill="#333"/>
            <!-- 鼻 -->
            <path d="M 50 48 L 48 52 L 52 52 Z" fill="#444"/>
            <!-- 口 -->
            <path d="M 50 52 Q 45 55 42 53" stroke="#444" stroke-width="1.5" fill="none" stroke-linecap="round"/>
            <path d="M 50 52 Q 55 55 58 53" stroke="#444" stroke-width="1.5" fill="none" stroke-linecap="round"/>
            <!-- ひげ左 -->
            <line x1="30" y1="45" x2="38" y2="44" stroke="#555" stroke-width="1"/>
            <line x1="30" y1="48" x2="38" y2="48" stroke="#555" stroke-width="1"/>
            <line x1="30" y1="51" x2="38" y2="52" stroke="#555" stroke-width="1"/>
            <!-- ひげ右 -->
            <line x1="70" y1="45" x2="62" y2="44" stroke="#555" stroke-width="1"/>
            <line x1="70" y1="48" x2="62" y2="48" stroke="#555" stroke-width="1"/>
            <line x1="70" y1="51" x2="62" y2="52" stroke="#555" stroke-width="1"/>
            <!-- 体 -->
            <ellipse cx="50" cy="80" rx="22" ry="28" fill="#777" stroke="#555" stroke-width="2"/>
            <!-- 前足左 -->
            <rect x="40" y="95" width="6" height="15" rx="3" fill="#777" stroke="#555" stroke-width="1.5"/>
            <!-- 前足右 -->
            <rect x="54" y="95" width="6" height="15" rx="3" fill="#777" stroke="#555" stroke-width="1.5"/>
            <!-- 尻尾 -->
            <path d="M 72 75 Q 85 70 90 80 Q 88 88 80 85" fill="none" stroke="#555" stroke-width="3" stroke-linecap="round"/>
        </svg>
    </div>

    <script src="../js/features/rating-system.js"></script>
    <script src="../js/features/study.js"></script>
    <script src="../js/features/sidebar-toggle.js"></script>
</body>

</html>
