<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•é¡Œä½œæˆ - å•é¡Œç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <meta name="description" content="æ–°ã—ã„å•é¡Œã‚’ä½œæˆ">
    <link rel="stylesheet" href="css/style.css">
    <script src="data/config.js"></script>
    <script src="data/question-types.js"></script>
    <script src="data/sample-data.js"></script>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <h1 class="header-title">å•é¡Œä½œæˆ</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary btn-sm" onclick="goBack()">
                        â† æˆ»ã‚‹
                    </button>
                </div>
            </div>
        </div>
    </header>

    <nav class="nav">
        <div class="container">
            <a href="index.html" class="nav-item">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
            <a href="create.html" class="nav-item active">â• ä½œæˆ</a>
            <a href="list.html" class="nav-item">ğŸ“‹ ä¸€è¦§</a>
            <a href="stats.html" class="nav-item">ğŸ“ˆ çµ±è¨ˆ</a>
        </div>
    </nav>

    <main class="container">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">æ–°ã—ã„å•é¡Œã‚’ä½œæˆ</h2>
            </div>
            <div class="card-body">
                <form id="question-form">
                    <!-- å•é¡Œã‚¿ã‚¤ãƒ—é¸æŠ -->
                    <div class="form-group">
                        <label class="form-label">å•é¡Œã‚¿ã‚¤ãƒ—</label>
                        <select id="question-type" class="form-select" onchange="updateFormFields()" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        </select>
                    </div>

                    <!-- é›£æ˜“åº¦ -->
                    <div class="form-group">
                        <label class="form-label">é›£æ˜“åº¦</label>
                        <select id="difficulty" class="form-select" required>
                            <option value="1">åˆç´š</option>
                            <option value="2">ä¸­ç´š</option>
                            <option value="3">ä¸Šç´š</option>
                            <option value="4">æœ€ä¸Šç´š</option>
                        </select>
                    </div>

                    <!-- ã‚¿ã‚° -->
                    <div class="form-group">
                        <label class="form-label">ã‚¿ã‚°</label>
                        <input type="text" id="tags" class="form-input" placeholder="ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›">
                        <div class="form-help">ä¾‹: èªå½™,æ–‡æ³•,åˆç´š</div>
                    </div>

                    <!-- å‹•çš„ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
                    <div id="dynamic-fields">
                        <!-- å•é¡Œã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦å‹•çš„ã«ç”Ÿæˆ -->
                    </div>

                    <!-- ãƒœã‚¿ãƒ³ -->
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary btn-block">
                            ğŸ’¾ ä¿å­˜
                        </button>
                        <button type="button" class="btn btn-secondary btn-block" onclick="previewQuestion()">
                            ğŸ‘ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="preview-section" class="card" style="display: none;">
            <div class="card-header">
                <h2 class="card-title">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
            </div>
            <div class="card-body">
                <div id="preview-content">
                    <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…å®¹ã‚’å‹•çš„ã«ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </main>

    <script src="js/app.js"></script>
    <script>
        // ãƒšãƒ¼ã‚¸åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeForm();
        });

        function initializeForm() {
            // å•é¡Œã‚¿ã‚¤ãƒ—é¸æŠè‚¢ã‚’ç”Ÿæˆ
            const typeSelect = document.getElementById('question-type');
            Object.keys(window.QUESTION_TYPES).forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = window.QUESTION_TYPES[type].name;
                typeSelect.appendChild(option);
            });

            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å•é¡Œã‚¿ã‚¤ãƒ—ã‚’å–å¾—
            const urlParams = new URLSearchParams(window.location.search);
            const type = urlParams.get('type');
            if (type && window.QUESTION_TYPES[type]) {
                typeSelect.value = type;
                updateFormFields();
            }
        }

        function updateFormFields() {
            const type = document.getElementById('question-type').value;
            const container = document.getElementById('dynamic-fields');
            
            container.innerHTML = '';
            
            if (!type || !window.QUESTION_TYPES[type]) {
                return;
            }

            const questionType = window.QUESTION_TYPES[type];
            
            questionType.fields.forEach(field => {
                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';
                
                const label = document.createElement('label');
                label.className = 'form-label';
                label.textContent = field.label;
                if (field.required) {
                    label.textContent += ' *';
                }
                
                let input;
                if (field.type === 'textarea') {
                    input = document.createElement('textarea');
                    input.className = 'form-textarea';
                    input.rows = 4;
                } else if (field.type === 'array') {
                    input = document.createElement('textarea');
                    input.className = 'form-textarea';
                    input.placeholder = '1è¡Œã«1ã¤ãšã¤å…¥åŠ›ã—ã¦ãã ã•ã„';
                } else {
                    input = document.createElement('input');
                    input.type = field.type;
                    input.className = 'form-input';
                }
                
                input.id = field.name;
                input.name = field.name;
                if (field.required) {
                    input.required = true;
                }
                if (field.default) {
                    input.value = field.default;
                }
                
                formGroup.appendChild(label);
                formGroup.appendChild(input);
                
                if (field.help) {
                    const help = document.createElement('div');
                    help.className = 'form-help';
                    help.textContent = field.help;
                    formGroup.appendChild(help);
                }
                
                container.appendChild(formGroup);
            });
        }

        function previewQuestion() {
            const formData = collectFormData();
            if (!formData) {
                alert('ãƒ•ã‚©ãƒ¼ãƒ ã«å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const previewSection = document.getElementById('preview-section');
            const previewContent = document.getElementById('preview-content');
            
            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼HTMLã‚’ç”Ÿæˆ
            let previewHtml = generatePreviewHtml(formData);
            previewContent.innerHTML = previewHtml;
            previewSection.style.display = 'block';
            
            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            previewSection.scrollIntoView({ behavior: 'smooth' });
        }

        function collectFormData() {
            const type = document.getElementById('question-type').value;
            const difficulty = document.getElementById('difficulty').value;
            const tags = document.getElementById('tags').value;
            
            if (!type) {
                return null;
            }

            const questionType = window.QUESTION_TYPES[type];
            const data = {
                type: type,
                difficulty: parseInt(difficulty),
                tags: tags ? tags.split(',').map(t => t.trim()) : []
            };

            // å‹•çš„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
            questionType.fields.forEach(field => {
                const input = document.getElementById(field.name);
                if (input) {
                    if (field.type === 'array') {
                        data[field.name] = input.value.split('\n').filter(line => line.trim());
                    } else {
                        data[field.name] = input.value;
                    }
                }
            });

            return data;
        }

        function generatePreviewHtml(data) {
            const questionType = window.QUESTION_TYPES[data.type];
            let html = `<div class="preview-question">`;
            html += `<h3>${questionType.name}</h3>`;
            html += `<p><strong>é›£æ˜“åº¦:</strong> ${window.CONFIG.DIFFICULTY_LEVELS[data.difficulty]}</p>`;
            
            if (data.tags.length > 0) {
                html += `<p><strong>ã‚¿ã‚°:</strong> ${data.tags.map(tag => `<span class="badge badge-secondary">${tag}</span>`).join(' ')}</p>`;
            }

            // å•é¡Œã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
            switch (data.type) {
                case 'vocab_meaning':
                    html += `<div class="question-preview">`;
                    html += `<p><strong>å˜èª:</strong> ${data.word}</p>`;
                    html += `<div class="options">`;
                    data.options.forEach((option, index) => {
                        html += `<div class="option">${index + 1}. ${option}</div>`;
                    });
                    html += `</div>`;
                    html += `<p><strong>æ­£è§£:</strong> ${data.correct}</p>`;
                    html += `</div>`;
                    break;
                    
                case 'vocab_fill':
                    html += `<div class="question-preview">`;
                    html += `<p><strong>è‹±æ–‡:</strong> ${data.sentence.replace('_____', `<u>${data.blank_word}</u>`)}</p>`;
                    html += `<div class="options">`;
                    data.options.forEach((option, index) => {
                        html += `<div class="option">${index + 1}. ${option}</div>`;
                    });
                    html += `</div>`;
                    html += `</div>`;
                    break;
                    
                case 'grammar_reorder':
                    html += `<div class="question-preview">`;
                    html += `<p><strong>å˜èª:</strong> ${data.scrambled_words.join(', ')}</p>`;
                    html += `<p><strong>æ­£è§£:</strong> ${data.correct_order.join(' ')}</p>`;
                    html += `</div>`;
                    break;
                    
                case 'reading_comprehension':
                    html += `<div class="question-preview">`;
                    html += `<p><strong>æœ¬æ–‡:</strong></p>`;
                    html += `<div class="passage">${data.passage}</div>`;
                    html += `<p><strong>è¨­å•æ•°:</strong> ${data.questions.length}</p>`;
                    html += `</div>`;
                    break;
                    
                case 'summary_short':
                case 'summary_medium':
                case 'summary_long':
                    html += `<div class="question-preview">`;
                    html += `<p><strong>æœ¬æ–‡:</strong></p>`;
                    html += `<div class="passage">${data.passage}</div>`;
                    html += `<p><strong>ç›®æ¨™å­—æ•°:</strong> ${data.target_length}å­—</p>`;
                    if (data.sample_answer) {
                        html += `<p><strong>æ¨¡ç¯„è§£ç­”:</strong> ${data.sample_answer}</p>`;
                    }
                    html += `</div>`;
                    break;
                    
                default:
                    html += `<p>ã“ã®å•é¡Œã‚¿ã‚¤ãƒ—ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ã¾ã å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>`;
            }
            
            html += `</div>`;
            return html;
        }

        function goBack() {
            window.location.href = 'index.html';
        }

        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
        document.getElementById('question-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = collectFormData();
            if (!formData) {
                alert('ãƒ•ã‚©ãƒ¼ãƒ ã«å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (window.app) {
                try {
                    const question = window.app.createQuestion(formData.type, formData);
                    window.app.showNotification('å•é¡Œã‚’ä½œæˆã—ã¾ã—ãŸ', 'success');
                    
                    // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
                    if (confirm('å•é¡Œã‚’ä½œæˆã—ã¾ã—ãŸã€‚ç¶šã‘ã¦ä½œæˆã—ã¾ã™ã‹ï¼Ÿ')) {
                        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                        document.getElementById('question-form').reset();
                        document.getElementById('dynamic-fields').innerHTML = '';
                        document.getElementById('preview-section').style.display = 'none';
                    } else {
                        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹
                        window.location.href = 'index.html';
                    }
                } catch (error) {
                    window.app.showNotification('å•é¡Œã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                    console.error('Create question failed:', error);
                }
            } else {
                alert('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
            }
        });
    </script>
</body>
</html>