<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±èªå•é¡Œç·´ç¿’ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        :root {
            --primary-color: #10b981;
            --secondary-color: #065f46;
            --accent-color: #34d399;
            --bg-color: #ecfdf5;
            --text-color: #1f2937;
            --border-color: #a7f3d0;
            --hover-bg: #d1fae5;
            --correct-color: #22c55e;
            --incorrect-color: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .header p {
            color: #6b7280;
            font-size: 1.1rem;
        }

        .mode-selector {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .btn-mode {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin: 0 10px;
            transition: background 0.3s ease;
        }

        .btn-mode:hover {
            background: var(--secondary-color);
        }

        .btn-mode.active {
            background: var(--secondary-color);
        }

        .module-selector {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .module-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .module-btn {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .module-btn:hover {
            border-color: var(--primary-color);
            background: var(--hover-bg);
        }

        .module-btn.selected {
            border-color: var(--primary-color);
            background: var(--hover-bg);
        }

        .module-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .question-container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .question-number {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .question-type {
            background: var(--accent-color);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .question-text {
            font-size: 1.1rem;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .passage-text {
            background: #f8fafc;
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            margin-bottom: 20px;
            font-size: 1rem;
            line-height: 1.8;
        }

        .options-container {
            margin-bottom: 20px;
        }

        .option {
            background: #f8fafc;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option:hover {
            border-color: var(--primary-color);
        }

        .option.selected {
            border-color: var(--primary-color);
            background: var(--hover-bg);
        }

        .option.correct {
            border-color: var(--correct-color);
            background: #dcfce7;
        }

        .option.incorrect {
            border-color: var(--incorrect-color);
            background: #fef2f2;
        }

        .answer-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .answer-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .btn-submit {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin-right: 10px;
        }

        .btn-submit:hover {
            background: var(--secondary-color);
        }

        .btn-next {
            background: #6b7280;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
        }

        .btn-next:hover {
            background: #4b5563;
        }

        .feedback {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-weight: 500;
        }

        .feedback.correct {
            background: #dcfce7;
            color: var(--correct-color);
            border: 1px solid #86efac;
        }

        .feedback.incorrect {
            background: #fef2f2;
            color: var(--incorrect-color);
            border: 1px solid #fca5a5;
        }

        .explanation {
            margin-top: 10px;
            font-style: italic;
            color: #6b7280;
        }

        .progress-bar {
            background: #e5e7eb;
            height: 8px;
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            background: var(--primary-color);
            height: 100%;
            transition: width 0.3s ease;
        }

        .score-display {
            text-align: center;
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .score-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .hidden {
            display: none;
        }

        .audio-player {
            background: #f8fafc;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .audio-controls {
            margin-top: 10px;
        }

        .btn-play {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .btn-play:hover {
            background: var(--secondary-color);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .module-grid {
                grid-template-columns: 1fr;
            }
            
            .question-header {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>è‹±èªå•é¡Œç·´ç¿’ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p>å®Ÿéš›ã®å•é¡Œã‚’è§£ã„ã¦å­¦ç¿’ä½“é¨“ã‚’ã—ã‚ˆã†</p>
        </div>

        <div class="mode-selector">
            <button class="btn-mode active" onclick="setMode('practice')">ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰</button>
            <button class="btn-mode" onclick="setMode('test')">ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰</button>
        </div>

        <div id="moduleSelection" class="module-selector">
            <h3>ç·´ç¿’ã™ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’é¸æŠ</h3>
            <div class="module-grid">
                <div class="module-btn" onclick="selectModule('vocab')">
                    <div class="module-icon">ğŸ“š</div>
                    <div>èªå½™å•é¡Œ</div>
                </div>
                <div class="module-btn" onclick="selectModule('grammar')">
                    <div class="module-icon">ğŸ“</div>
                    <div>æ–‡æ³•å•é¡Œ</div>
                </div>
                <div class="module-btn" onclick="selectModule('reading')">
                    <div class="module-icon">ğŸ“–</div>
                    <div>èª­è§£å•é¡Œ</div>
                </div>
                <div class="module-btn" onclick="selectModule('listening')">
                    <div class="module-icon">ğŸ§</div>
                    <div>ãƒªã‚¹ãƒ‹ãƒ³ã‚°å•é¡Œ</div>
                </div>
                <div class="module-btn" onclick="selectModule('summary')">
                    <div class="module-icon">ğŸ“Š</div>
                    <div>è¦ç´„å•é¡Œ</div>
                </div>
            </div>
        </div>

        <div id="questionContainer" class="question-container hidden">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <div class="question-header">
                <div class="question-number" id="questionNumber">å•é¡Œ 1</div>
                <div class="question-type" id="questionType">èªå½™å•é¡Œ</div>
            </div>

            <div id="audioPlayer" class="audio-player hidden">
                <div>ğŸ“» éŸ³å£°ã‚’å†ç”Ÿã—ã¦å•é¡Œã‚’èã„ã¦ãã ã•ã„</div>
                <div class="audio-controls">
                    <button class="btn-play" onclick="playAudio()">â–¶ å†ç”Ÿ</button>
                </div>
            </div>

            <div id="passageContainer" class="passage-text hidden"></div>
            
            <div class="question-text" id="questionText"></div>
            
            <div id="optionsContainer" class="options-container"></div>
            
            <div id="inputContainer" class="hidden">
                <textarea class="answer-input" id="answerInput" rows="4" placeholder="ã“ã“ã«å›ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
            </div>

            <div id="buttonContainer">
                <button class="btn-submit" onclick="submitAnswer()">å›ç­”ã™ã‚‹</button>
                <button class="btn-next hidden" onclick="nextQuestion()">æ¬¡ã®å•é¡Œ</button>
            </div>

            <div id="feedback" class="feedback hidden"></div>
        </div>

        <div id="scoreContainer" class="score-display hidden">
            <h3>çµæœ</h3>
            <div class="score-number" id="scoreNumber">0/0</div>
            <div id="scoreMessage">ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼</div>
            <button class="btn-submit" onclick="restartQuiz()">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦</button>
        </div>
    </div>

    <script>
        let currentMode = 'practice';
        let currentModule = '';
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let answered = false;

        // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
        function ensureSampleData() {
            return new Promise((resolve) => {
                const modules = ['vocab', 'grammar', 'reading', 'listening', 'summary'];
                let loadedCount = 0;
                
                modules.forEach(module => {
                    const questions = JSON.parse(localStorage.getItem(module + 'Questions') || '[]');
                    if (questions.length === 0) {
                        loadSampleDataForModule(module, () => {
                            loadedCount++;
                            if (loadedCount === modules.length) {
                                resolve();
                            }
                        });
                    } else {
                        loadedCount++;
                        if (loadedCount === modules.length) {
                            resolve();
                        }
                    }
                });
            });
        }

        function loadSampleDataForModule(module, callback) {
            const script = document.createElement('script');
            script.src = module + '/sample-data.js';
            script.onload = callback;
            document.head.appendChild(script);
        }

        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.btn-mode').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function selectModule(module) {
            currentModule = module;
            currentQuestionIndex = 0;
            score = 0;
            answered = false;

            // é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.module-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');

            // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã¦ã‹ã‚‰å•é¡Œã‚’èª­ã¿è¾¼ã‚€
            ensureSampleData().then(() => {
                // ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é¸æŠã‚’éè¡¨ç¤º
                document.getElementById('moduleSelection').classList.add('hidden');
                
                // å•é¡Œã‚³ãƒ³ãƒ†ãƒŠã‚’è¡¨ç¤º
                document.getElementById('questionContainer').classList.remove('hidden');
                document.getElementById('scoreContainer').classList.add('hidden');

                // å•é¡Œã‚’èª­ã¿è¾¼ã‚€
                loadQuestions();
            });
        }

        function loadQuestions() {
            const questions = JSON.parse(localStorage.getItem(currentModule + 'Questions') || '[]');
            console.log(`Loading questions for module: ${currentModule}`);
            console.log(`Found ${questions.length} questions`);
            console.log('First question structure:', questions[0]);
            
            if (questions.length === 0) {
                alert('ã“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã¯å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚');
                return;
            }

            currentQuestions = questions;
            displayQuestion();
        }

        function displayQuestion() {
            console.log(`Displaying question ${currentQuestionIndex + 1} of ${currentQuestions.length}`);
            
            if (currentQuestionIndex >= currentQuestions.length) {
                showResults();
                return;
            }

            const question = currentQuestions[currentQuestionIndex];
            console.log('Current question:', question);
            answered = false;

            // é€²æ—ãƒãƒ¼ã‚’æ›´æ–°
            const progress = ((currentQuestionIndex + 1) / currentQuestions.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';

            // å•é¡Œç•ªå·ã¨ã‚¿ã‚¤ãƒ—ã‚’æ›´æ–°
            document.getElementById('questionNumber').textContent = `å•é¡Œ ${currentQuestionIndex + 1}`;
            document.getElementById('questionType').textContent = getModuleTypeName(currentModule);

            // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’éè¡¨ç¤º
            document.getElementById('feedback').classList.add('hidden');
            document.getElementById('buttonContainer').classList.remove('hidden');

            // å›ç­”ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã€æ¬¡ã®å•é¡Œãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
            document.querySelector('.btn-submit').classList.remove('hidden');
            document.querySelector('.btn-next').classList.add('hidden');

            // éŸ³å£°ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤º
            const audioPlayer = document.getElementById('audioPlayer');
            if (currentModule === 'listening' && question.audioFile) {
                audioPlayer.classList.remove('hidden');
            } else {
                audioPlayer.classList.add('hidden');
            }

            // æœ¬æ–‡ã®è¡¨ç¤º/éè¡¨ç¤º
            const passageContainer = document.getElementById('passageContainer');
            if (currentModule === 'reading' && question.passage) {
                passageContainer.textContent = question.passage;
                passageContainer.classList.remove('hidden');
            } else {
                passageContainer.classList.add('hidden');
            }

            // å•é¡Œæ–‡ã‚’è¨­å®š
            let questionText = '';
            if (currentModule === 'reading' || currentModule === 'listening') {
                questionText = question.questions[0].text;
            } else if (currentModule === 'vocab') {
                if (question.format === 'meaning') {
                    questionText = `"${question.word}"ã®æ„å‘³ã¨ã—ã¦æœ€ã‚‚é©åˆ‡ãªã‚‚ã®ã‚’é¸ã³ãªã•ã„ã€‚`;
                } else if (question.format === 'fillblank') {
                    questionText = question.sentence;
                }
            } else if (currentModule === 'grammar') {
                if (question.format === 'underline') {
                    questionText = question.sentence;
                } else if (question.format === 'reorder') {
                    questionText = 'æ¬¡ã®å˜èªã‚’æ­£ã—ã„é †ç•ªã«ä¸¦ã¹æ›¿ãˆãªã•ã„ã€‚';
                } else if (question.format === 'choice4' || question.format === 'choice5') {
                    questionText = question.question;
                }
            } else {
                questionText = question.question || question.instructions;
            }
            document.getElementById('questionText').textContent = questionText;

            // é¸æŠè‚¢ã‚³ãƒ³ãƒ†ãƒŠã®è¡¨ç¤º/éè¡¨ç¤º
            const optionsContainer = document.getElementById('optionsContainer');
            const inputContainer = document.getElementById('inputContainer');

            if (currentModule === 'summary') {
                // è¦ç´„å•é¡Œã¯ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›
                optionsContainer.classList.add('hidden');
                inputContainer.classList.remove('hidden');
                document.getElementById('answerInput').value = '';
            } else if (currentModule === 'vocab' && question.format === 'meaning') {
                // èªå½™ã®æ„å‘³é¸æŠå•é¡Œ
                optionsContainer.classList.remove('hidden');
                inputContainer.classList.add('hidden');
                displayOptions(question.choices);
            } else if (currentModule === 'vocab' && question.format === 'fillblank') {
                // èªå½™ã®ç©ºæ‰€è£œå……å•é¡Œ
                optionsContainer.classList.remove('hidden');
                inputContainer.classList.add('hidden');
                displayOptions(question.choices);
            } else if (currentModule === 'grammar' && question.format === 'underline') {
                // æ–‡æ³•ã®ä¸‹ç·šéƒ¨é¸æŠå•é¡Œ
                optionsContainer.classList.remove('hidden');
                inputContainer.classList.add('hidden');
                displayOptions(question.choices);
            } else if (currentModule === 'grammar' && (question.format === 'choice4' || question.format === 'choice5')) {
                // æ–‡æ³•ã®é¸æŠå•é¡Œ
                optionsContainer.classList.remove('hidden');
                inputContainer.classList.add('hidden');
                displayOptions(question.choices);
            } else if (currentModule === 'grammar' && question.format === 'reorder') {
                // æ–‡æ³•ã®èªé †ä¸¦ã¹æ›¿ãˆå•é¡Œ
                optionsContainer.classList.remove('hidden');
                inputContainer.classList.remove('hidden');
                
                // å˜èªãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
                const wordsContainer = document.createElement('div');
                wordsContainer.style.cssText = 'background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #e0f2fe;';
                wordsContainer.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 10px; color: #0369a1;">å˜èªãƒªã‚¹ãƒˆ:</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${question.words.split(',').map(word => 
                            `<span style="background: white; padding: 6px 12px; border-radius: 6px; border: 1px solid #cbd5e1; font-family: monospace;">${word.trim()}</span>`
                        ).join('')}
                    </div>
                `;
                
                // é¸æŠè‚¢ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¯ãƒªã‚¢ã—ã¦å˜èªãƒªã‚¹ãƒˆã‚’è¿½åŠ 
                optionsContainer.innerHTML = '';
                optionsContainer.appendChild(wordsContainer);
                
                document.getElementById('answerInput').value = '';
                document.getElementById('answerInput').placeholder = 'å˜èªã‚’æ­£ã—ã„é †ç•ªã§å…¥åŠ›ã—ã¦ãã ã•ã„...';
            } else if (question.options) {
                // ä¸€èˆ¬çš„ãªé¸æŠè‚¢å•é¡Œ
                optionsContainer.classList.remove('hidden');
                inputContainer.classList.add('hidden');
                displayOptions(question.options);
            } else {
                // ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›å•é¡Œ
                optionsContainer.classList.add('hidden');
                inputContainer.classList.remove('hidden');
                document.getElementById('answerInput').value = '';
            }
        }

        function displayOptions(options) {
            const container = document.getElementById('optionsContainer');
            container.innerHTML = '';

            options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                optionElement.textContent = option;
                optionElement.onclick = () => selectOption(index);
                container.appendChild(optionElement);
            });
        }

        function selectOption(index) {
            if (answered) return;

            document.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
            document.querySelectorAll('.option')[index].classList.add('selected');
        }

        function playAudio() {
            // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®å‡¦ç†
            const question = currentQuestions[currentQuestionIndex];
            if (question.audioFile) {
                alert(`éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${question.audioFile.name}ã€ã‚’å†ç”Ÿã—ã¾ã™ã€‚\nï¼ˆå®Ÿéš›ã®ã‚·ã‚¹ãƒ†ãƒ ã§ã¯éŸ³å£°ãŒå†ç”Ÿã•ã‚Œã¾ã™ï¼‰`);
            }
        }

        function submitAnswer() {
            if (answered) return;

            const question = currentQuestions[currentQuestionIndex];
            let userAnswer = '';
            let correctAnswer = '';

            if (currentModule === 'summary') {
                userAnswer = document.getElementById('answerInput').value.trim();
                correctAnswer = question.sampleAnswer;
            } else if (currentModule === 'vocab' && (question.format === 'meaning' || question.format === 'fillblank')) {
                const selectedOption = document.querySelector('.option.selected');
                if (!selectedOption) {
                    alert('é¸æŠè‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                userAnswer = selectedOption.textContent;
                correctAnswer = question.answer;
            } else if (currentModule === 'grammar' && (question.format === 'underline' || question.format === 'choice4' || question.format === 'choice5')) {
                const selectedOption = document.querySelector('.option.selected');
                if (!selectedOption) {
                    alert('é¸æŠè‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                userAnswer = selectedOption.textContent;
                correctAnswer = question.answer;
            } else if (currentModule === 'grammar' && question.format === 'reorder') {
                userAnswer = document.getElementById('answerInput').value.trim();
                correctAnswer = question.correctOrder;
            } else if (question.options) {
                const selectedOption = document.querySelector('.option.selected');
                if (!selectedOption) {
                    alert('é¸æŠè‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                userAnswer = selectedOption.textContent;
                correctAnswer = question.answer;
            } else {
                userAnswer = document.getElementById('answerInput').value.trim();
                correctAnswer = question.answer;
            }

            answered = true;
            const isCorrect = checkAnswer(userAnswer, correctAnswer, question);

            if (isCorrect) {
                score++;
            }

            showFeedback(isCorrect, userAnswer, correctAnswer, question);

            // ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ã§ã¯å³æ™‚ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
            if (currentMode === 'practice') {
                document.querySelector('.btn-submit').classList.add('hidden');
                document.querySelector('.btn-next').classList.remove('hidden');
            } else {
                // ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ã¯è‡ªå‹•çš„ã«æ¬¡ã®å•é¡Œã¸
                setTimeout(() => {
                    nextQuestion();
                }, 2000);
            }
        }

        function checkAnswer(userAnswer, correctAnswer, question) {
            // å³å¯†ãªå›ç­”ãƒã‚§ãƒƒã‚¯
            if (currentModule === 'grammar' && question.format === 'reorder') {
                // èªé †ä¸¦ã¹æ›¿ãˆå•é¡Œã¯å®Œå…¨ä¸€è‡´ã§ãƒã‚§ãƒƒã‚¯
                return userAnswer.toLowerCase() === correctAnswer.toLowerCase();
            } else if (currentModule === 'vocab' || currentModule === 'grammar') {
                // é¸æŠè‚¢å•é¡Œã¯å®Œå…¨ä¸€è‡´ã§ãƒã‚§ãƒƒã‚¯
                return userAnswer === correctAnswer;
            } else {
                // ãã®ä»–ã¯éƒ¨åˆ†ä¸€è‡´ã‚‚è¨±å®¹
                return userAnswer.toLowerCase().includes(correctAnswer.toLowerCase()) || 
                       correctAnswer.toLowerCase().includes(userAnswer.toLowerCase());
            }
        }

        function showFeedback(isCorrect, userAnswer, correctAnswer, question) {
            const feedback = document.getElementById('feedback');
            feedback.classList.remove('hidden', 'correct', 'incorrect');
            
            let explanation = '';
            if (question.explanation) {
                explanation = question.explanation;
            } else if (currentModule === 'vocab' && question.format === 'meaning') {
                explanation = `"${question.word}"ã®æ„å‘³ã¯"${question.definition}"ã§ã™ã€‚ä¾‹æ–‡: ${question.example}`;
            } else if (currentModule === 'vocab' && question.format === 'fillblank') {
                explanation = `è¨³æ–‡: ${question.translation}`;
            } else if (currentModule === 'grammar' && question.format === 'reorder') {
                explanation = `æ­£ã—ã„èªé †ã§æ–‡ç« ã‚’ä½œæˆã—ã¾ã—ã‚‡ã†ã€‚`;
            } else {
                explanation = 'ã‚ˆãã§ãã¾ã—ãŸã€‚';
            }
            
            if (isCorrect) {
                feedback.classList.add('correct');
                feedback.innerHTML = `
                    <div>âœ“ æ­£è§£ã§ã™ï¼</div>
                    <div class="explanation">${explanation}</div>
                `;
            } else {
                feedback.classList.add('incorrect');
                feedback.innerHTML = `
                    <div>âœ— ä¸æ­£è§£ã§ã™</div>
                    <div>æ­£è§£: ${correctAnswer}</div>
                    <div class="explanation">${explanation}</div>
                `;
            }

            // é¸æŠè‚¢ã®è‰²ã‚’å¤‰æ›´
            if (question.choices || question.options) {
                document.querySelectorAll('.option').forEach((opt, index) => {
                    if (opt.textContent === correctAnswer) {
                        opt.classList.add('correct');
                    } else if (opt.classList.contains('selected')) {
                        opt.classList.add('incorrect');
                    }
                });
            }
        }

        function nextQuestion() {
            currentQuestionIndex++;
            displayQuestion();
        }

        function showResults() {
            document.getElementById('questionContainer').classList.add('hidden');
            document.getElementById('scoreContainer').classList.remove('hidden');
            
            const percentage = Math.round((score / currentQuestions.length) * 100);
            document.getElementById('scoreNumber').textContent = `${score}/${currentQuestions.length}`;
            
            let message = '';
            if (percentage >= 80) {
                message = 'ç´ æ™´ã‚‰ã—ã„çµæœã§ã™ï¼ã‚ˆãé ‘å¼µã‚Šã¾ã—ãŸï¼';
            } else if (percentage >= 60) {
                message = 'è‰¯ã„çµæœã§ã™ï¼ã•ã‚‰ã«ç·´ç¿’ã‚’ç¶šã‘ã¾ã—ã‚‡ã†ï¼';
            } else {
                message = 'é ‘å¼µã‚Šã¾ã—ãŸï¼ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼';
            }
            
            document.getElementById('scoreMessage').textContent = message;
        }

        function restartQuiz() {
            currentQuestionIndex = 0;
            score = 0;
            document.getElementById('scoreContainer').classList.add('hidden');
            document.getElementById('moduleSelection').classList.remove('hidden');
            document.querySelectorAll('.module-btn').forEach(btn => btn.classList.remove('selected'));
        }

        function getModuleTypeName(module) {
            const types = {
                'vocab': 'èªå½™å•é¡Œ',
                'grammar': 'æ–‡æ³•å•é¡Œ',
                'reading': 'èª­è§£å•é¡Œ',
                'listening': 'ãƒªã‚¹ãƒ‹ãƒ³ã‚°å•é¡Œ',
                'summary': 'è¦ç´„å•é¡Œ'
            };
            return types[module] || module;
        }

        // ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼é–¢æ•°
        function validateDataStructure() {
            const modules = ['vocab', 'grammar', 'reading', 'listening', 'summary'];
            modules.forEach(module => {
                const questions = JSON.parse(localStorage.getItem(module + 'Questions') || '[]');
                console.log(`=== ${module} module data ===`);
                console.log(`Question count: ${questions.length}`);
                if (questions.length > 0) {
                    console.log('Sample question structure:', JSON.stringify(questions[0], null, 2));
                }
                console.log('========================');
            });
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿æ™‚ã«ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª
        document.addEventListener('DOMContentLoaded', function() {
            ensureSampleData().then(() => {
                console.log('ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™ãŒå®Œäº†ã—ã¾ã—ãŸ');
                validateDataStructure();
            });
        });
    </script>
</body>
</html>