<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced GeoGebra-style Math Input System</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                macros: {
                    frac: ['\\frac{#1}{#2}', 2],
                    sqrt: ['\\sqrt{#1}', 1]
                }
            },
            chtml: {
                scale: 1.0,
                minScale: 0.5,
                matchFontHeight: false
            }
        };
    </script>
    <link rel="stylesheet" href="math-input.css">
</head>
<body>
    <div class="container">
        <h1>Enhanced GeoGebra-style Math Input System</h1>
        <p class="subtitle">複数の入力方式をサポートする数学入力システム (risou.md準拠)</p>
        
        <!-- 入力モード選択 -->
        <div class="input-mode-tabs">
            <button class="input-mode-tab active" data-mode="choice">
                <span class="mode-icon">A1</span>
                選択式入力
            </button>
            <button class="input-mode-tab" data-mode="template">
                <span class="mode-icon">F1</span>
                テンプレート入力
            </button>
            <button class="input-mode-tab" data-mode="free">
                <span class="mode-icon">F2</span>
                自由入力
            </button>
        </div>

        <div class="input-panels">
            <!-- A1: 選択式入力 -->
            <div class="input-panel active" data-panel="choice">
                <div class="panel-header">
                    <h3>問題タイプを選択してください</h3>
                    <p class="panel-description">よく使われる数学問題の形式から選択できます</p>
                </div>
                <div class="choice-grid" id="choiceGrid">
                    <!-- 動的に生成される -->
                </div>
                <div class="selected-choice-info" id="selectedChoiceInfo" style="display: none;">
                    <h4>選択された問題:</h4>
                    <div id="selectedChoicePreview" class="choice-preview"></div>
                    <div class="input-fields" id="choiceInputFields">
                        <!-- 動的に生成される -->
                    </div>
                </div>
            </div>

            <!-- F1: テンプレート入力 -->
            <div class="input-panel" data-panel="template">
                <div class="panel-header">
                    <h3>数学分野を選択</h3>
                    <p class="panel-description">分野別のテンプレートを使って効率的に入力できます</p>
                </div>
                <div class="template-selector">
                    <div class="template-tabs">
                        <button class="template-tab active" data-category="basic">
                            <span class="tab-icon">📐</span>
                            基本数学
                        </button>
                        <button class="template-tab" data-category="algebra">
                            <span class="tab-icon">🔢</span>
                            代数
                        </button>
                        <button class="template-tab" data-category="calculus">
                            <span class="tab-icon">📈</span>
                            微積分
                        </button>
                        <button class="template-tab" data-category="linear">
                            <span class="tab-icon">📊</span>
                            線形代数
                        </button>
                        <button class="template-tab" data-category="geometry">
                            <span class="tab-icon">📏</span>
                            幾何
                        </button>
                    </div>
                    <div class="template-grid" id="templateGrid">
                        <!-- 動的に生成される -->
                    </div>
                </div>
                <div class="input-fields" id="templateInputFields">
                    <!-- 選択されたテンプレートに応じて生成 -->
                </div>
            </div>

            <!-- F2: 自由入力 -->
            <div class="input-panel" data-panel="free">
                <div class="panel-header">
                    <h3>GeoGebra形式で自由に入力</h3>
                    <p class="panel-description">GeoGebra互換の記法で数式を直接入力できます</p>
                </div>
                <div class="free-input-area">
                    <div class="input-with-suggestions">
                        <textarea 
                            class="math-input-enhanced" 
                            id="freeInput" 
                            placeholder="例: x^2 + 2*x + 1, sin(x) + cos(x), sqrt(x^2+y^2)&#10;GeoGebra記法で入力 - Tab で補完、Ctrl+Enter で評価"
                        ></textarea>
                        <div class="suggestions-panel" id="suggestionsPanel">
                            <!-- 動的に生成される -->
                        </div>
                    </div>
                    
                    <div class="toolbar desktop-toolbar">
                        <div class="tool-group">
                            <h4>基本演算</h4>
                            <button class="tool-btn" data-input="+" title="加算">+</button>
                            <button class="tool-btn" data-input="-" title="減算">−</button>
                            <button class="tool-btn" data-input="*" title="乗算">×</button>
                            <button class="tool-btn" data-input="/" title="除算">/</button>
                            <button class="tool-btn" data-input="^" title="べき乗">^</button>
                        </div>
                        
                        <div class="tool-group">
                            <h4>関数</h4>
                            <button class="tool-btn" data-input="sin(" title="正弦関数">sin</button>
                            <button class="tool-btn" data-input="cos(" title="余弦関数">cos</button>
                            <button class="tool-btn" data-input="tan(" title="正接関数">tan</button>
                            <button class="tool-btn" data-input="log(" title="常用対数">log</button>
                            <button class="tool-btn" data-input="sqrt(" title="平方根">√</button>
                        </div>
                        
                        <div class="tool-group">
                            <h4>高度な記号</h4>
                            <button class="tool-btn" data-input="(" title="分数">分数</button>
                            <button class="tool-btn" data-input="int_{}^{}" title="積分">∫</button>
                            <button class="tool-btn" data-input="sum_{}^{}" title="総和">Σ</button>
                            <button class="tool-btn" data-input="lim_{}" title="極限">lim</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- モバイル用仮想キーボード -->
        <div class="mobile-math-keyboard" id="mobileKeyboard">
            <div class="keyboard-header">
                <button class="keyboard-tab active" data-keyboard="numbers">123</button>
                <button class="keyboard-tab" data-keyboard="functions">関数</button>
                <button class="keyboard-tab" data-keyboard="symbols">記号</button>
                <button class="keyboard-tab" data-keyboard="advanced">高度</button>
                <button class="keyboard-close" id="keyboardClose">×</button>
            </div>
            
            <!-- 数字キーボード -->
            <div class="keyboard-panel active" data-panel="numbers">
                <div class="keyboard-row">
                    <button class="key-btn" data-input="7">7</button>
                    <button class="key-btn" data-input="8">8</button>
                    <button class="key-btn" data-input="9">9</button>
                    <button class="key-btn wide" data-input="/">/</button>
                    <button class="key-btn" data-input="^">^</button>
                </div>
                <div class="keyboard-row">
                    <button class="key-btn" data-input="4">4</button>
                    <button class="key-btn" data-input="5">5</button>
                    <button class="key-btn" data-input="6">6</button>
                    <button class="key-btn wide" data-input="*">×</button>
                    <button class="key-btn" data-input="π">π</button>
                </div>
                <div class="keyboard-row">
                    <button class="key-btn" data-input="1">1</button>
                    <button class="key-btn" data-input="2">2</button>
                    <button class="key-btn" data-input="3">3</button>
                    <button class="key-btn wide" data-input="-">−</button>
                    <button class="key-btn" data-input="e">e</button>
                </div>
                <div class="keyboard-row">
                    <button class="key-btn wide" data-input="0">0</button>
                    <button class="key-btn" data-input=".">.</button>
                    <button class="key-btn" data-input="x">x</button>
                    <button class="key-btn wide" data-input="+">+</button>
                    <button class="key-btn accent" data-action="delete">⌫</button>
                </div>
            </div>
            
            <!-- 関数キーボード -->
            <div class="keyboard-panel" data-panel="functions">
                <div class="keyboard-row">
                    <button class="key-btn function" data-input="sin(">sin</button>
                    <button class="key-btn function" data-input="cos(">cos</button>
                    <button class="key-btn function" data-input="tan(">tan</button>
                    <button class="key-btn function" data-input="log(">log</button>
                </div>
                <div class="keyboard-row">
                    <button class="key-btn function" data-input="sqrt(">√</button>
                    <button class="key-btn function" data-input="abs(">|x|</button>
                    <button class="key-btn function" data-input="exp(">e^</button>
                    <button class="key-btn function" data-input="ln(">ln</button>
                </div>
                <div class="keyboard-row">
                    <button class="key-btn" data-input="(">(</button>
                    <button class="key-btn" data-input=")">)</button>
                    <button class="key-btn wide function" data-input="/">分数</button>
                    <button class="key-btn accent" data-action="delete">⌫</button>
                </div>
            </div>
            
            <!-- 記号・変数キーボード -->
            <div class="keyboard-panel" data-panel="symbols">
                <div class="keyboard-row">
                    <button class="key-btn" data-input="α">α</button>
                    <button class="key-btn" data-input="β">β</button>
                    <button class="key-btn" data-input="γ">γ</button>
                    <button class="key-btn" data-input="θ">θ</button>
                </div>
                <div class="keyboard-row">
                    <button class="key-btn" data-input="=">=</button>
                    <button class="key-btn" data-input="≠">≠</button>
                    <button class="key-btn" data-input="≤">≤</button>
                    <button class="key-btn" data-input="≥">≥</button>
                </div>
                <div class="keyboard-row">
                    <button class="key-btn" data-input="∞">∞</button>
                    <button class="key-btn" data-input="°">°</button>
                    <button class="key-btn" data-input="%">%</button>
                    <button class="key-btn accent" data-action="delete">⌫</button>
                </div>
            </div>
            
            <!-- 高度な記号 -->
            <div class="keyboard-panel" data-panel="advanced">
                <div class="keyboard-row">
                    <button class="key-btn special" data-input="int_{}^{}">∫</button>
                    <button class="key-btn special" data-input="sum_{}^{}">Σ</button>
                    <button class="key-btn special" data-input="lim_{}">lim</button>
                    <button class="key-btn special" data-input="partial">∂</button>
                </div>
                <div class="keyboard-row">
                    <button class="key-btn special" data-input="matrix">行列</button>
                    <button class="key-btn special" data-input="vector">ベクトル</button>
                    <button class="key-btn accent" data-action="clear">クリア</button>
                    <button class="key-btn accent" data-action="delete">⌫</button>
                </div>
            </div>
        </div>

        <!-- 結果表示エリア -->
        <div class="result-area">
            <h3>結果</h3>
            <div class="result-preview" id="resultPreview">
                数式を入力してください
            </div>
            <div class="result-details">
                <div class="result-item">
                    <h4>LaTeX形式</h4>
                    <div class="result-value" id="latexOutput">-</div>
                </div>
                <div class="result-item">
                    <h4>GeoGebra形式</h4>
                    <div class="result-value" id="geogebraOutput">-</div>
                </div>
                <div class="result-item">
                    <h4>数値評価</h4>
                    <div class="result-value" id="numericOutput">-</div>
                </div>
                <div class="result-item">
                    <h4>構文チェック</h4>
                    <div class="result-value" id="syntaxCheck">有効</div>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-primary" id="evaluateBtn">
                <span class="btn-icon">⚡</span>
                評価・変換
            </button>
            <button class="btn btn-secondary" id="clearAllBtn">
                <span class="btn-icon">🗑️</span>
                すべてクリア
            </button>
            <button class="btn btn-secondary" id="copyLatexBtn">
                <span class="btn-icon">📋</span>
                LaTeX をコピー
            </button>
            <button class="btn btn-secondary" id="showKeyboardBtn" style="display: none;">
                <span class="btn-icon">⌨️</span>
                キーボード
            </button>
        </div>

        <!-- 使用例 -->
        <div class="examples-section">
            <h3>入力例とガイド</h3>
            <div class="example-tabs">
                <button class="example-tab active" data-examples="basic">基本</button>
                <button class="example-tab" data-examples="advanced">高度</button>
                <button class="example-tab" data-examples="calculus">微積分</button>
            </div>
            
            <div class="examples-panel active" data-panel="basic">
                <div class="examples-grid">
                    <div class="example-item" data-example="x^2 + 2*x + 1">
                        <div class="example-math">x² + 2x + 1</div>
                        <div class="example-desc">二次式</div>
                    </div>
                    <div class="example-item" data-example="(a+b)/(c-d)">
                        <div class="example-math">(a+b)/(c-d)</div>
                        <div class="example-desc">分数</div>
                    </div>
                    <div class="example-item" data-example="sqrt(x^2+y^2)">
                        <div class="example-math">√(x²+y²)</div>
                        <div class="example-desc">平方根</div>
                    </div>
                    <div class="example-item" data-example="sin(x) + cos(x)">
                        <div class="example-math">sin(x) + cos(x)</div>
                        <div class="example-desc">三角関数</div>
                    </div>
                </div>
            </div>
            
            <div class="examples-panel" data-panel="advanced">
                <div class="examples-grid">
                    <div class="example-item" data-example="matrix[[1,2],[3,4]]">
                        <div class="example-math">行列 [1,2;3,4]</div>
                        <div class="example-desc">2×2行列</div>
                    </div>
                    <div class="example-item" data-example="vector[a,b,c]">
                        <div class="example-math">ベクトル (a,b,c)</div>
                        <div class="example-desc">3次元ベクトル</div>
                    </div>
                    <div class="example-item" data-example="(a+sqrt(b))/c">
                        <div class="example-math">(a+√b)/c</div>
                        <div class="example-desc">無理数分数</div>
                    </div>
                    <div class="example-item" data-example="log(x^2+1)">
                        <div class="example-math">log(x²+1)</div>
                        <div class="example-desc">対数関数</div>
                    </div>
                </div>
            </div>
            
            <div class="examples-panel" data-panel="calculus">
                <div class="examples-grid">
                    <div class="example-item" data-example="derivative(x^2, x)">
                        <div class="example-math">d/dx[x²]</div>
                        <div class="example-desc">微分</div>
                    </div>
                    <div class="example-item" data-example="integrate(x^2, x)">
                        <div class="example-math">∫x² dx</div>
                        <div class="example-desc">積分</div>
                    </div>
                    <div class="example-item" data-example="limit(sin(x)/x, x, 0)">
                        <div class="example-math">lim[x→0] sin(x)/x</div>
                        <div class="example-desc">極限</div>
                    </div>
                    <div class="example-item" data-example="sum(k^2, k, 1, n)">
                        <div class="example-math">Σ[k=1 to n] k²</div>
                        <div class="example-desc">級数</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="geogebra-input-manager.js"></script>
    <script src="geogebra-parser.js"></script>
    <script src="math-input.js"></script>
</body>
</html>