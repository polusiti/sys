<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>問題ブラウザ - Data Manager</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- MathJax -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --light-bg: #f8f9fa;
        }

        body {
            background-color: var(--light-bg);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .navbar {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .problem-card {
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .problem-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .difficulty-stars {
            color: #ffc107;
        }

        .difficulty-stars .far {
            color: #e9ecef;
        }

        .filter-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .subject-tabs .nav-link {
            border-radius: 20px;
            margin-right: 10px;
            font-weight: 500;
        }

        .subject-tabs .nav-link.active {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .problem-meta {
            font-size: 0.875rem;
            color: var(--secondary-color);
        }

        .tag-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            margin: 0.125rem;
            background-color: #e9ecef;
            color: #495057;
            border-radius: 12px;
            text-decoration: none;
        }

        .tag-badge:hover {
            background-color: #dee2e6;
            color: #495057;
        }

        .list-view .problem-card {
            margin-bottom: 1rem;
        }

        .list-view .card-body {
            padding: 1rem;
        }

        .view-toggle {
            background: white;
            border-radius: 20px;
            padding: 0.25rem;
        }

        .btn-like {
            border: none;
            background: transparent;
            color: var(--secondary-color);
            transition: color 0.2s;
        }

        .btn-like:hover {
            color: var(--primary-color);
        }

        .btn-like.liked {
            color: var(--primary-color);
        }

        .loading-spinner {
            display: none;
        }

        .problem-preview {
            max-height: 200px;
            overflow: hidden;
            position: relative;
        }

        .problem-preview::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30px;
            background: linear-gradient(transparent, white);
        }

        /* Search Button Styles - 2025年9月22日追記対応 */
        .search-action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .btn-search {
            background: linear-gradient(135deg, #007bff, #0056b3);
            border: none;
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .btn-search:hover {
            background: linear-gradient(135deg, #0056b3, #004085);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
            color: white;
        }

        .btn-filter {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            border: none;
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .btn-filter:hover {
            background: linear-gradient(135deg, #1e7e34, #155724);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
            color: white;
        }

        /* Comment System Styles */
        .problem-modal .modal-dialog {
            max-width: 900px;
        }

        .problem-detail {
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 2rem;
            margin-bottom: 2rem;
        }

        .problem-detail h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .problem-meta-detail {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: var(--secondary-color);
        }

        .comments-section {
            max-height: 400px;
            overflow-y: auto;
        }

        .comment-form {
            background: var(--light-bg);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .comment-form textarea {
            min-height: 100px;
            resize: vertical;
        }

        .comment-item {
            border-bottom: 1px solid #f0f0f0;
            padding: 1rem 0;
        }

        .comment-item:last-child {
            border-bottom: none;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .comment-author {
            font-weight: 600;
            color: var(--primary-color);
        }

        .comment-date {
            font-size: 0.85rem;
            color: var(--secondary-color);
        }

        .comment-content {
            margin-bottom: 0.5rem;
            line-height: 1.6;
        }

        .comment-actions {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
        }

        .comment-action {
            color: var(--secondary-color);
            text-decoration: none;
            cursor: pointer;
            transition: color 0.2s;
        }

        .comment-action:hover {
            color: var(--primary-color);
        }

        .comment-reply {
            margin-left: 2rem;
            padding-left: 1rem;
            border-left: 3px solid var(--light-bg);
        }

        .comment-count {
            color: var(--secondary-color);
            font-size: 0.9rem;
        }

        .empty-comments {
            text-align: center;
            padding: 2rem;
            color: var(--secondary-color);
        }

        .comment-stats {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .like-btn {
            background: none;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .like-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .like-btn.liked {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
    </style>

    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            }
        };
    </script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-database"></i> Data Manager
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="browse.html">
                            <i class="fas fa-search"></i> 問題ブラウザ
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="create.html">
                            <i class="fas fa-plus"></i> 問題作成
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="statistics.html">
                            <i class="fas fa-chart-bar"></i> 統計
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="fas fa-home"></i> ホーム
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3 text-primary">
                    <i class="fas fa-search"></i> 問題ブラウザ
                </h1>
                <p class="text-muted">登録されている問題を検索・閲覧できます</p>
            </div>
        </div>

        <!-- Subject Tabs -->
        <ul class="nav nav-pills subject-tabs mb-4" id="subjectTabs">
            <li class="nav-item">
                <a class="nav-link active" data-subject="math" href="#" onclick="switchSubject('math')">
                    <i class="fas fa-calculator"></i> 数学
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-subject="english" href="#" onclick="switchSubject('english')">
                    <i class="fas fa-language"></i> 英語
                </a>
            </li>
        </ul>

        <!-- Filter Section -->
        <div class="filter-section p-3 mb-4">
            <div class="row">
                <div class="col-md-3">
                    <label for="categoryFilter" class="form-label">カテゴリ</label>
                    <select class="form-select" id="categoryFilter" onchange="applyFilters()">
                        <option value="">全て</option>
                        <option value="高校数学">高校数学</option>
                        <option value="大学数学">大学数学</option>
                        <option value="中学数学">中学数学</option>
                        <option value="競技数学">競技数学</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="difficultyFilter" class="form-label">難易度</label>
                    <select class="form-select" id="difficultyFilter" onchange="applyFilters()">
                        <option value="">全て</option>
                        <option value="1">★☆☆☆☆ (1)</option>
                        <option value="2">★★☆☆☆ (2)</option>
                        <option value="3">★★★☆☆ (3)</option>
                        <option value="4">★★★★☆ (4)</option>
                        <option value="5">★★★★★ (5)</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="sortFilter" class="form-label">並び順</label>
                    <select class="form-select" id="sortFilter" onchange="applyFilters()">
                        <option value="newest">新しい順</option>
                        <option value="oldest">古い順</option>
                        <option value="difficulty">難易度順</option>
                        <option value="likes">いいね順</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="searchInput" class="form-label">検索</label>
                    <input type="text" class="form-control" id="searchInput" placeholder="タイトルで検索...">
                </div>
            </div>

            <!-- Search Action Buttons - 2025年9月22日追記対応 -->
            <div class="search-action-buttons">
                <button class="btn btn-search btn-lg" onclick="executeSearch()">
                    <i class="fas fa-search me-2"></i>検索実行
                </button>
                <button class="btn btn-filter btn-lg" onclick="executeFilter()">
                    <i class="fas fa-filter me-2"></i>絞り込み実行
                </button>
                <button class="btn btn-outline-secondary btn-lg" onclick="clearAllFilters()">
                    <i class="fas fa-times me-2"></i>クリア
                </button>
            </div>
        </div>

        <!-- View Toggle and Results Count -->
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="d-flex align-items-center">
                    <span class="me-3">表示形式:</span>
                    <div class="btn-group view-toggle" role="group">
                        <input type="radio" class="btn-check" name="viewMode" id="cardView" autocomplete="off" checked onchange="toggleView('card')">
                        <label class="btn btn-outline-primary btn-sm" for="cardView">
                            <i class="fas fa-th-large"></i> カード
                        </label>
                        <input type="radio" class="btn-check" name="viewMode" id="listView" autocomplete="off" onchange="toggleView('list')">
                        <label class="btn btn-outline-primary btn-sm" for="listView">
                            <i class="fas fa-list"></i> リスト
                        </label>
                    </div>
                </div>
            </div>
            <div class="col-md-6 text-end">
                <span class="text-muted" id="resultsCount">0件の問題が見つかりました</span>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div class="text-center loading-spinner" id="loadingSpinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">読み込み中...</span>
            </div>
        </div>

        <!-- Problems Grid -->
        <div id="problemsContainer" class="row">
            <!-- Problems will be dynamically loaded here -->
        </div>

        <!-- Pagination -->
        <nav aria-label="ページネーション" class="mt-4">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- Pagination will be dynamically generated -->
            </ul>
        </nav>
    </div>

    <!-- Problem Detail Modal with Comments -->
    <div class="modal fade" id="problemModal" tabindex="-1" aria-labelledby="problemModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg problem-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="problemModalLabel">問題詳細</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Problem Details -->
                    <div class="problem-detail">
                        <h3 id="modalProblemTitle">問題タイトル</h3>
                        
                        <div class="problem-meta-detail" id="modalProblemMeta">
                            <!-- Meta information will be populated here -->
                        </div>
                        
                        <div class="comment-stats">
                            <button class="like-btn" id="modalLikeBtn" onclick="toggleProblemLike()">
                                <i class="fas fa-heart"></i>
                                <span id="modalLikeCount">0</span>
                            </button>
                            <span class="comment-count">
                                <i class="fas fa-comments"></i>
                                <span id="modalCommentCount">0</span>件のコメント
                            </span>
                        </div>
                        
                        <div class="problem-content" id="modalProblemContent">
                            <!-- Problem content will be populated here -->
                        </div>
                        
                        <div id="modalProblemChoices" style="display: none;">
                            <!-- Choices will be populated here -->
                        </div>
                        
                        <div id="modalProblemExplanation" style="display: none;">
                            <h6>解説:</h6>
                            <div class="explanation-content"></div>
                        </div>
                    </div>
                    
                    <!-- Comments Section -->
                    <div class="comments-container">
                        <h5>
                            <i class="fas fa-comments"></i>
                            コメント
                            <span class="badge bg-secondary ms-2" id="commentsBadge">0</span>
                        </h5>
                        
                        <!-- Comment Form -->
                        <div class="comment-form">
                            <div id="auth-required-message" style="display: none; text-align: center; padding: 20px; background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; margin-bottom: 20px;">
                                <i class="fas fa-lock text-primary"></i>
                                <p class="mb-2"><strong>ログインが必要です</strong></p>
                                <p class="mb-3">コメントを投稿するにはログインしてください</p>
                                <a href="auth.html" class="btn btn-primary btn-sm">ログイン・新規登録</a>
                            </div>
                            
                            <div id="comment-form-fields">
                                <div class="mb-3">
                                    <label for="commentAuthor" class="form-label">名前</label>
                                    <input type="text" class="form-control" id="commentAuthor" placeholder="匿名" maxlength="50" readonly>
                                    <div class="form-text">ログインユーザーの表示名が自動入力されます</div>
                                </div>
                                <div class="mb-3">
                                    <label for="commentContent" class="form-label">コメント</label>
                                    <textarea class="form-control" id="commentContent" placeholder="この問題についてのコメント、質問、解法のヒントなどをお書きください..." maxlength="1000"></textarea>
                                    <div class="form-text">最大1000文字</div>
                                </div>
                                <button type="button" class="btn btn-primary" onclick="submitComment()">
                                    <i class="fas fa-paper-plane"></i>
                                    コメントを投稿
                                </button>
                            </div>
                        </div>
                        
                        <!-- Comments List -->
                        <div class="comments-section" id="commentsList">
                            <!-- Comments will be populated here -->
                        </div>
                        
                        <!-- Empty Comments State -->
                        <div class="empty-comments" id="emptyComments">
                            <i class="fas fa-comments fa-3x mb-3"></i>
                            <p>まだコメントがありません。<br>最初のコメントを投稿してみませんか？</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                    <button type="button" class="btn btn-primary" onclick="editProblem()">
                        <i class="fas fa-edit"></i>
                        問題を編集
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Authentication Client -->
    <script src="auth-d1-client.js"></script>

    <script>
        // Load problems from D1 database
        async function loadAllProblems() {
            try {
                // Try to load from D1 first
                const response = await fetch('/api/questions');

                if (response.ok) {
                    const data = await response.json();

                    if (data.success && data.questions) {
                        // Transform D1 data to match existing format
                        const d1Problems = data.questions.map(q => ({
                            id: q.id,
                            title: q.title,
                            content: q.question_text,
                            subject: q.subject || 'math',
                            category: q.field_code || '一般',
                            difficulty: getDifficultyLevel(q.difficulty_level),
                            author: 'D1 User',
                            answerType: 'manual',
                            likes: 0,
                            answers: 0,
                            tags: q.tags ? (Array.isArray(q.tags) ? q.tags : JSON.parse(q.tags || '[]')) : [],
                            createdAt: q.created_at || new Date().toISOString(),
                            estimatedTime: 15,
                            source: 'd1',
                            explanation: q.explanation || '',
                            choices: q.choices ? (Array.isArray(q.choices) ? q.choices : JSON.parse(q.choices || '[]')) : [],
                            correctAnswer: q.correct_answer
                        }));

                        return d1Problems;
                    }
                }

                // Fallback to localStorage if D1 fails
                return await loadProblemsFromLocalStorage();

            } catch (error) {
                console.error('D1 loading error:', error);
                // Fallback to localStorage
                return await loadProblemsFromLocalStorage();
            }
        }

        // Fallback to localStorage
        async function loadProblemsFromLocalStorage() {
            let allProblems = [];

            // Math problems
            const mathProblems = JSON.parse(localStorage.getItem('mathQuestions') || '[]');
            allProblems = allProblems.concat(mathProblems.map(p => ({
                ...p,
                subject: 'math',
                source: 'mathManager'
            })));

            // English module problems
            const vocabQuestions = JSON.parse(localStorage.getItem('vocabQuestions') || '[]');
            const grammarQuestions = JSON.parse(localStorage.getItem('grammarQuestions') || '[]');
            const readingQuestions = JSON.parse(localStorage.getItem('readingQuestions') || '[]');
            const listeningQuestions = JSON.parse(localStorage.getItem('listeningQuestions') || '[]');
            const summaryQuestions = JSON.parse(localStorage.getItem('summaryQuestions') || '[]');

            allProblems = allProblems.concat([
                ...vocabQuestions.map(p => ({...p, subject: 'english', category: '語彙', source: 'vocab'})),
                ...grammarQuestions.map(p => ({...p, subject: 'english', category: '文法', source: 'grammar'})),
                ...readingQuestions.map(p => ({...p, subject: 'english', category: '読解', source: 'reading'})),
                ...listeningQuestions.map(p => ({...p, subject: 'english', category: 'リスニング', source: 'listening'})),
                ...summaryQuestions.map(p => ({...p, subject: 'english', category: 'ライティング', source: 'summary'}))
            ]);

            // Created problems
            const createdProblems = JSON.parse(localStorage.getItem('createdProblems') || '[]');
            allProblems = allProblems.concat(createdProblems.map(p => ({
                ...p,
                source: 'created'
            })));

            // Add sample problems if no data exists
            if (allProblems.length === 0) {
                allProblems = [
                    {
                        id: '1',
                        title: 'cos(n°)が有理数となるnはいくつ存在するか',
                        subject: 'math',
                        category: '高校数学',
                        difficulty: 4,
                        author: 'Kobutya',
                        content: '(1) 自然数 $n$ について、$\\cos\\theta = x$ とおくと $\\cos n\\theta$ が $x$ の多項式で表せ、またその係数はすべて整数となることを示せ。',
                        answerType: 'manual',
                        likes: 0,
                        answers: 0,
                        tags: ['三角関数', '多項式'],
                        createdAt: new Date('2025-09-14T09:30:00'),
                        estimatedTime: 20,
                        source: 'sample'
                    },
                    {
                        id: '2',
                        title: '二次方程式と幾何の問題',
                        subject: 'math',
                        category: '高校数学',
                        difficulty: 3,
                        author: 'takumiarii',
                        content: '三角形 ABC の頂点は A(0,0), B(6,0), C(4,6) である。AC の中点を通り、BC に垂直な直線の方程式を求めよ。',
                        answerType: 'auto',
                        likes: 1,
                        answers: 0,
                        tags: ['二次方程式', '初等幾何', '代数'],
                        createdAt: new Date('2025-09-13T22:05:00'),
                        estimatedTime: 15,
                        source: 'sample'
                    },
                    {
                        id: '3',
                        title: 'English Grammar Exercise',
                        subject: 'english',
                        category: '文法',
                        difficulty: 2,
                        author: 'EnglishTeacher',
                        content: 'Choose the correct form: She ___ to school every day.',
                        answerType: 'auto',
                        likes: 3,
                        answers: 15,
                        tags: ['present tense', 'verb forms'],
                        createdAt: new Date('2025-09-12T14:20:00'),
                        estimatedTime: 5,
                        source: 'sample'
                    }
                ];
            }

            return allProblems;
        }

        // Helper function to convert difficulty level text to number
        function getDifficultyLevel(difficultyLevel) {
            switch (difficultyLevel) {
                case 'easy': return 1;
                case 'medium': return 2;
                case 'hard': return 3;
                case 'expert': return 4;
                case 'master': return 5;
                default: return 2;
            }
        }
  
        let currentProblems = [];
        let sampleProblems = [];

        // Initialize problems loading
        async function initializeProblems() {
            showLoadingSpinner();
            try {
                sampleProblems = await loadAllProblems();
                currentProblems = sampleProblems;
                applyFilters();
                updateResultsCount();
            } catch (error) {
                console.error('Failed to load problems:', error);
                showNotification('問題の読み込みに失敗しました', 'error');
            } finally {
                hideLoadingSpinner();
            }
        }
        let currentSubject = 'math';
        let currentPage = 1;
        let itemsPerPage = 6;
        let currentView = 'card';

        function switchSubject(subject) {
            currentSubject = subject;
            
            // Update active tab
            document.querySelectorAll('.subject-tabs .nav-link').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-subject="${subject}"]`).classList.add('active');
            
            // Update category filter options based on subject
            updateCategoryFilter();
            
            // Reset and apply filters
            applyFilters();
        }

        function updateCategoryFilter() {
            const categoryFilter = document.getElementById('categoryFilter');
            categoryFilter.innerHTML = '<option value="">全て</option>';

            if (currentSubject === 'math') {
                categoryFilter.innerHTML += `
                    <option value="高校数学">高校数学</option>
                    <option value="大学数学">大学数学</option>
                    <option value="中学数学">中学数学</option>
                    <option value="競技数学">競技数学</option>
                `;
            } else if (currentSubject === 'english') {
                categoryFilter.innerHTML += `
                    <option value="文法">文法</option>
                    <option value="語彙">語彙</option>
                    <option value="読解">読解</option>
                    <option value="リスニング">リスニング</option>
                `;
            }
        }

        // 検索実行ボタン機能 - 2025年9月22日追記対応
        function executeSearch() {
            showNotification('検索を実行しています...', 'info');
            showLoadingSpinner();

            setTimeout(() => {
                applyFilters();
                hideLoadingSpinner();
                showNotification('検索が完了しました', 'success');
            }, 800);
        }

        // 絞り込み実行ボタン機能 - 2025年9月22日追記対応
        function executeFilter() {
            showNotification('絞り込みを実行しています...', 'info');
            showLoadingSpinner();

            setTimeout(() => {
                applyFilters();
                hideLoadingSpinner();
                showNotification('絞り込みが完了しました', 'success');
            }, 600);
        }

        // フィルタークリア機能の改善
        function clearAllFilters() {
            document.getElementById('categoryFilter').value = '';
            document.getElementById('difficultyFilter').value = '';
            document.getElementById('sortFilter').value = 'newest';
            document.getElementById('searchInput').value = '';

            applyFilters();
            showNotification('すべてのフィルターをクリアしました', 'success');
        }

        function showLoadingSpinner() {
            document.getElementById('loadingSpinner').style.display = 'block';
        }

        function hideLoadingSpinner() {
            document.getElementById('loadingSpinner').style.display = 'none';
        }

        function applyFilters() {
            const category = document.getElementById('categoryFilter').value;
            const difficulty = document.getElementById('difficultyFilter').value;
            const sort = document.getElementById('sortFilter').value;
            const search = document.getElementById('searchInput').value.toLowerCase();

            // Filter problems
            let filteredProblems = sampleProblems.filter(problem => {
                if (problem.subject !== currentSubject) return false;
                if (category && problem.category !== category) return false;
                if (difficulty && problem.difficulty !== parseInt(difficulty)) return false;
                if (search && !problem.title.toLowerCase().includes(search)) return false;
                return true;
            });

            // Sort problems
            filteredProblems.sort((a, b) => {
                switch (sort) {
                    case 'newest':
                        return new Date(b.createdAt) - new Date(a.createdAt);
                    case 'oldest':
                        return new Date(a.createdAt) - new Date(b.createdAt);
                    case 'difficulty':
                        return b.difficulty - a.difficulty;
                    case 'likes':
                        return b.likes - a.likes;
                    default:
                        return 0;
                }
            });

            currentProblems = filteredProblems;
            currentPage = 1;
            renderProblems();
            updateResultsCount();
            renderPagination();
        }

        function toggleView(view) {
            currentView = view;
            renderProblems();
        }

        function renderProblems() {
            const container = document.getElementById('problemsContainer');
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const problemsToShow = currentProblems.slice(startIndex, endIndex);

            if (currentView === 'card') {
                container.className = 'row';
                container.innerHTML = problemsToShow.map(problem => renderProblemCard(problem)).join('');
            } else {
                container.className = 'list-view';
                container.innerHTML = problemsToShow.map(problem => renderProblemList(problem)).join('');
            }

            // Re-render MathJax
            if (window.MathJax) {
                MathJax.typesetPromise([container]);
            }
        }

        function renderProblemCard(problem) {
            const difficultyStars = generateStars(problem.difficulty);
            const tagsHtml = problem.tags.map(tag => 
                `<a href="#" class="tag-badge" onclick="searchByTag('${tag}')">${tag}</a>`
            ).join('');

            return `
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card problem-card h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title">${problem.title}</h5>
                                <div class="text-end">
                                    <button class="btn btn-like" onclick="toggleLike('${problem.id}')">
                                        <i class="fas fa-heart"></i> ${problem.likes}
                                    </button>
                                </div>
                            </div>
                            
                            <div class="problem-meta mb-2">
                                <small>
                                    <i class="fas fa-user"></i> ${problem.author} | 
                                    <i class="fas fa-tag"></i> ${problem.category} |
                                    <span class="difficulty-stars">${difficultyStars}</span>
                                </small>
                            </div>
                            
                            <div class="problem-preview mb-3">
                                ${problem.content}
                            </div>
                            
                            <div class="tags mb-2">
                                ${tagsHtml}
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    <i class="fas fa-clock"></i> ${problem.estimatedTime}分 |
                                    <i class="fas fa-comments"></i> ${problem.answers || 0}件
                                </small>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="viewProblem('${problem.id}')">
                                        <i class="fas fa-eye"></i> 表示
                                    </button>
                                    <span class="badge ${problem.answerType === 'auto' ? 'bg-success' : 'bg-warning'}">
                                        ${problem.answerType === 'auto' ? '自動採点' : '採点者ジャッジ'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderProblemList(problem) {
            const difficultyStars = generateStars(problem.difficulty);
            const tagsHtml = problem.tags.map(tag => 
                `<a href="#" class="tag-badge" onclick="searchByTag('${tag}')">${tag}</a>`
            ).join('');

            return `
                <div class="card problem-card mb-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h5 class="card-title">${problem.title}</h5>
                                <div class="problem-meta mb-2">
                                    <small>
                                        <i class="fas fa-user"></i> ${problem.author} | 
                                        <i class="fas fa-tag"></i> ${problem.category} |
                                        <span class="difficulty-stars">${difficultyStars}</span> |
                                        <i class="fas fa-clock"></i> ${problem.estimatedTime}分
                                    </small>
                                </div>
                                <p class="card-text">${problem.content.substring(0, 200)}...</p>
                                <div class="tags">
                                    ${tagsHtml}
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-like mb-2" onclick="toggleLike('${problem.id}')">
                                    <i class="fas fa-heart"></i> ${problem.likes}
                                </button>
                                <button class="btn btn-sm btn-outline-primary mb-2 ms-2" onclick="viewProblem('${problem.id}')">
                                    <i class="fas fa-eye"></i> 表示
                                </button>
                                <br>
                                <span class="badge ${problem.answerType === 'auto' ? 'bg-success' : 'bg-warning'}">
                                    ${problem.answerType === 'auto' ? '自動採点' : '採点者ジャッジ'}
                                </span>
                                <br>
                                <small class="text-muted">
                                    <i class="fas fa-comments"></i> ${problem.answers || 0}件のコメント
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateStars(difficulty) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= difficulty) {
                    stars += '<i class="fas fa-star"></i>';
                } else {
                    stars += '<i class="far fa-star"></i>';
                }
            }
            return stars;
        }

        function updateResultsCount() {
            const count = currentProblems.length;
            document.getElementById('resultsCount').textContent = `${count}件の問題が見つかりました`;
        }

        function renderPagination() {
            const totalPages = Math.ceil(currentProblems.length / itemsPerPage);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let paginationHtml = '';
            
            // Previous button
            if (currentPage > 1) {
                paginationHtml += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">前へ</a>
                    </li>
                `;
            }
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                paginationHtml += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                    </li>
                `;
            }
            
            // Next button
            if (currentPage < totalPages) {
                paginationHtml += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">次へ</a>
                    </li>
                `;
            }
            
            pagination.innerHTML = paginationHtml;
        }

        function changePage(page) {
            currentPage = page;
            renderProblems();
            renderPagination();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function toggleLike(problemId) {
            const problem = sampleProblems.find(p => p.id === problemId);
            if (problem) {
                problem.likes++;
                renderProblems();
            }
        }

        function searchByTag(tag) {
            document.getElementById('searchInput').value = tag;
            applyFilters();
        }

        // Comment System Functions
        let currentProblem = null;
        let problemComments = {};

        function viewProblem(id) {
            const problem = sampleProblems.find(p => p.id === id);
            if (!problem) {
                alert('問題が見つかりません');
                return;
            }

            currentProblem = problem;
            
            // Populate modal with problem details
            document.getElementById('modalProblemTitle').textContent = problem.title;
            
            // Meta information
            const metaHtml = `
                <span><i class="fas fa-user"></i> ${problem.author || 'Anonymous'}</span>
                <span><i class="fas fa-tag"></i> ${problem.category || '未分類'}</span>
                <span><i class="fas fa-star"></i> ${generateStars(problem.difficulty)}</span>
                <span><i class="fas fa-clock"></i> ${problem.estimatedTime || 0}分</span>
                <span><i class="fas fa-calendar"></i> ${problem.createdAt ? new Date(problem.createdAt).toLocaleDateString() : '不明'}</span>
            `;
            document.getElementById('modalProblemMeta').innerHTML = metaHtml;
            
            // Problem content
            document.getElementById('modalProblemContent').innerHTML = problem.content || problem.questionText || '';
            
            // Choices (if any)
            const choicesDiv = document.getElementById('modalProblemChoices');
            if (problem.choices && problem.choices.length > 0) {
                let choicesHtml = '<h6>選択肢:</h6><div class="choices-list">';
                problem.choices.forEach((choice, index) => {
                    const isCorrect = problem.correctAnswer === index;
                    choicesHtml += `
                        <div class="choice-item mb-2">
                            <span class="badge ${isCorrect ? 'bg-success' : 'bg-light text-dark'}">${String.fromCharCode(65 + index)}</span>
                            ${choice}
                        </div>
                    `;
                });
                choicesHtml += '</div>';
                choicesDiv.innerHTML = choicesHtml;
                choicesDiv.style.display = 'block';
            } else {
                choicesDiv.style.display = 'none';
            }
            
            // Explanation
            const explanationDiv = document.getElementById('modalProblemExplanation');
            if (problem.explanation) {
                explanationDiv.querySelector('.explanation-content').innerHTML = problem.explanation;
                explanationDiv.style.display = 'block';
            } else {
                explanationDiv.style.display = 'none';
            }
            
            // Update like button
            const likeBtn = document.getElementById('modalLikeBtn');
            const likeCount = document.getElementById('modalLikeCount');
            likeBtn.classList.toggle('liked', problem.liked || false);
            likeCount.textContent = problem.likes || 0;
            
            // Set up comment form based on authentication status
            setupCommentForm();
            
            // Load and display comments
            loadComments(id);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('problemModal'));
            modal.show();

            // Re-render MathJax for the modal content
            setTimeout(() => {
                if (window.MathJax) {
                    MathJax.typesetPromise([document.getElementById('problemModal')]);
                }
            }, 100);
        }

        function setupCommentForm() {
            const authRequiredMessage = document.getElementById('auth-required-message');
            const commentFormFields = document.getElementById('comment-form-fields');
            const authorInput = document.getElementById('commentAuthor');

            if (window.authClient && window.authClient.isLoggedIn()) {
                // User is logged in
                authRequiredMessage.style.display = 'none';
                commentFormFields.style.display = 'block';
                
                const user = window.authClient.getCurrentUser();
                authorInput.value = user.displayName;
                authorInput.readOnly = true;
            } else {
                // User is not logged in
                authRequiredMessage.style.display = 'block';
                commentFormFields.style.display = 'none';
            }
        }

        function loadComments(problemId) {
            const comments = problemComments[problemId] || [];
            
            // Update comment count
            document.getElementById('modalCommentCount').textContent = comments.length;
            document.getElementById('commentsBadge').textContent = comments.length;
            
            const commentsList = document.getElementById('commentsList');
            const emptyComments = document.getElementById('emptyComments');
            
            if (comments.length === 0) {
                commentsList.style.display = 'none';
                emptyComments.style.display = 'block';
                return;
            }
            
            commentsList.style.display = 'block';
            emptyComments.style.display = 'none';
            
            // Render comments
            commentsList.innerHTML = comments.map(comment => renderComment(comment)).join('');
        }

        function renderComment(comment) {
            const date = new Date(comment.createdAt).toLocaleString();
            return `
                <div class="comment-item" data-comment-id="${comment.id}">
                    <div class="comment-header">
                        <span class="comment-author">${comment.author}</span>
                        <span class="comment-date">${date}</span>
                    </div>
                    <div class="comment-content">${comment.content}</div>
                    <div class="comment-actions">
                        <span class="comment-action" onclick="likeComment('${comment.id}')">
                            <i class="fas fa-thumbs-up"></i> いいね (${comment.likes || 0})
                        </span>
                        <span class="comment-action" onclick="replyToComment('${comment.id}')">
                            <i class="fas fa-reply"></i> 返信
                        </span>
                        <span class="comment-action" onclick="reportComment('${comment.id}')">
                            <i class="fas fa-flag"></i> 報告
                        </span>
                    </div>
                    ${comment.replies ? comment.replies.map(reply => `
                        <div class="comment-reply">
                            ${renderComment(reply)}
                        </div>
                    `).join('') : ''}
                </div>
            `;
        }

        function submitComment() {
            if (!currentProblem) return;
            
            // Check authentication
            if (!window.authClient || !window.authClient.isLoggedIn()) {
                alert('コメントを投稿するにはログインが必要です');
                return;
            }

            const user = window.authClient.getCurrentUser();
            const contentInput = document.getElementById('commentContent');
            const content = contentInput.value.trim();
            
            if (!content) {
                alert('コメント内容を入力してください');
                return;
            }
            
            if (content.length > 1000) {
                alert('コメントは1000文字以内で入力してください');
                return;
            }
            
            // Create comment object with authenticated user info
            const comment = {
                id: 'comment_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6),
                author: user.displayName,
                authorId: user.id,
                authorInquiryNumber: user.inquiryNumber,
                content: content,
                createdAt: new Date().toISOString(),
                likes: 0,
                replies: []
            };
            
            // Add to comments storage
            if (!problemComments[currentProblem.id]) {
                problemComments[currentProblem.id] = [];
            }
            problemComments[currentProblem.id].unshift(comment);
            
            // Save to localStorage
            localStorage.setItem('problemComments', JSON.stringify(problemComments));
            
            // Update problem's comment count
            currentProblem.comments = (currentProblem.comments || 0) + 1;
            
            // Clear form
            contentInput.value = '';
            
            // Reload comments
            loadComments(currentProblem.id);
            
            // Show success message
            showNotification('コメントを投稿しました！', 'success');
        }

        function toggleProblemLike() {
            if (!currentProblem) return;
            
            const likeBtn = document.getElementById('modalLikeBtn');
            const likeCount = document.getElementById('modalLikeCount');
            
            // Toggle like status
            currentProblem.liked = !currentProblem.liked;
            
            if (currentProblem.liked) {
                currentProblem.likes = (currentProblem.likes || 0) + 1;
                likeBtn.classList.add('liked');
                showNotification('いいねしました！', 'success');
            } else {
                currentProblem.likes = Math.max(0, (currentProblem.likes || 0) - 1);
                likeBtn.classList.remove('liked');
            }
            
            likeCount.textContent = currentProblem.likes;
            
            // Update the problem in the list view as well
            renderProblems();
        }

        function likeComment(commentId) {
            if (!currentProblem) return;
            
            const comments = problemComments[currentProblem.id] || [];
            const comment = findCommentById(comments, commentId);
            
            if (comment) {
                comment.likes = (comment.likes || 0) + 1;
                localStorage.setItem('problemComments', JSON.stringify(problemComments));
                loadComments(currentProblem.id);
                showNotification('コメントにいいねしました！', 'success');
            }
        }

        function replyToComment(commentId) {
            // For simplicity, we'll focus the main comment form
            // In a full implementation, you might add inline reply forms
            document.getElementById('commentContent').focus();
            showNotification('返信機能は開発中です。コメント欄をご利用ください。', 'info');
        }

        function reportComment(commentId) {
            if (confirm('このコメントを報告しますか？')) {
                showNotification('コメントを報告しました。運営が確認します。', 'warning');
            }
        }

        function findCommentById(comments, id) {
            for (const comment of comments) {
                if (comment.id === id) return comment;
                if (comment.replies) {
                    const found = findCommentById(comment.replies, id);
                    if (found) return found;
                }
            }
            return null;
        }

        function editProblem() {
            if (!currentProblem) return;
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('problemModal'));
            modal.hide();
            
            // In a real implementation, you would navigate to edit page
            showNotification('編集機能は開発中です', 'info');
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : type === 'error' ? 'danger' : 'info'} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }

        // Load comments from localStorage on page load
        function initializeComments() {
            const saved = localStorage.getItem('problemComments');
            if (saved) {
                try {
                    problemComments = JSON.parse(saved);
                } catch (e) {
                    console.error('Failed to load comments:', e);
                    problemComments = {};
                }
            } else {
                // Load sample comments if no data exists
                loadSampleComments();
            }
        }

        function loadSampleComments() {
            // Sample comments for demo purposes
            problemComments = {
                "1": [
                    {
                        "id": "comment_1640995200000_abc123",
                        "author": "数学好きの高校生",
                        "content": "この問題、とても興味深いですね！cos(n°)が有理数になる条件について、チェビシェフ多項式との関連性も面白そうです。",
                        "createdAt": "2025-09-14T10:30:00.000Z",
                        "likes": 3,
                        "replies": [
                            {
                                "id": "reply_1640995300000_def456",
                                "author": "Kobutya",
                                "content": "その通りです！チェビシェフ多項式を使うとより深く理解できます。続きの問題も考えてみてください。",
                                "createdAt": "2025-09-14T11:15:00.000Z",
                                "likes": 1,
                                "replies": []
                            }
                        ]
                    },
                    {
                        "id": "comment_1640995400000_ghi789",
                        "author": "大学生",
                        "content": "解法のポイントを教えていただけませんか？最初のステップが分からなくて困っています。",
                        "createdAt": "2025-09-14T12:00:00.000Z",
                        "likes": 0,
                        "replies": []
                    }
                ],
                "2": [
                    {
                        "id": "comment_1640995500000_jkl012",
                        "author": "数学教師",
                        "content": "垂直な直線の性質を利用した良い問題ですね。生徒にもぜひ解かせてみたいと思います。",
                        "createdAt": "2025-09-13T22:30:00.000Z",
                        "likes": 2,
                        "replies": []
                    }
                ],
                "3": [
                    {
                        "id": "comment_1640995600000_mno345",
                        "author": "英語学習者",
                        "content": "Simple but effective grammar question! The use of 'every day' makes it clear that we need present tense.",
                        "createdAt": "2025-09-12T15:00:00.000Z",
                        "likes": 1,
                        "replies": []
                    },
                    {
                        "id": "comment_1640995700000_pqr678",
                        "author": "Teacher Alice",
                        "content": "This is a great example for teaching present simple. I might use this in my next lesson!",
                        "createdAt": "2025-09-12T16:30:00.000Z",
                        "likes": 2,
                        "replies": []
                    }
                ]
            };
            
            // Save to localStorage for persistence
            localStorage.setItem('problemComments', JSON.stringify(problemComments));
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateCategoryFilter();
            initializeProblems();
            initializeComments();
        });
    </script>
</body>
</html>